/*! For license information please see 233.58eedbc4.chunk.js.LICENSE.txt */
(window.webpackJsonp=window.webpackJsonp||[]).push([[233],{27447:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return r}));var n=new Uint8Array(16);function r(){if(!s&&!(s="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return s(n)}},27448:function(e,t,i){"use strict";for(var s=i(27449),n=[],r=0;r<256;++r)n.push((r+256).toString(16).substr(1));t.a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase();if(!Object(s.a)(i))throw TypeError("Stringified UUID is invalid");return i}},27449:function(e,t,i){"use strict";var s=i(27450);t.a=function(e){return"string"==typeof e&&s.a.test(e)}},27450:function(e,t,i){"use strict";t.a=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i},27455:function(e,t,i){"use strict";var s=i(27447),n=i(27448);t.a=function(e,t,i){var r=(e=e||{}).random||(e.rng||s.a)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){i=i||0;for(var a=0;a<16;++a)t[i+a]=r[a];return t}return Object(n.a)(r)}},28819:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var s,n=i(28849),r=i(28861),a=i(28821),o=i(28870),c=i(28909),l=i(28820);class h{get type(){return h.Type}get attributes(){return h.Attributes}async load(e,t,i,s){const n=new u(t,e,s);return await n.load(i),n}create(e,t){const i=new u(t,e,h.Attributes);return i.initializeLocal(),i}}h.Type="https://graph.microsoft.com/types/map",h.Attributes={type:h.Type,snapshotFormatVersion:"0.2",packageVersion:l.a};class u extends a.a{constructor(e,t,i){super(e,t,i,"fluid_map_"),this[s]="SharedMap",this.kernel=new c.a(this.serializer,this.handle,(e,t)=>this.submitLocalMessage(e,t),()=>this.isAttached(),this)}static create(e,t){return e.createChannel(t,h.Type)}static getFactory(){return new h}keys(){return this.kernel.keys()}entries(){return this.kernel.entries()}values(){return this.kernel.values()}[(s=Symbol.toStringTag,Symbol.iterator)](){return this.kernel.entries()}get size(){return this.kernel.size}forEach(e){this.kernel.forEach(e)}get(e){return this.kernel.get(e)}has(e){return this.kernel.has(e)}set(e,t){return this.kernel.set(e,t),this}delete(e){return this.kernel.delete(e)}clear(){this.kernel.clear()}summarizeCore(e,t){let i=0,s=0,n={};const r=[],a=new o.a,c=this.kernel.getSerializedStorage(e);for(const o of Object.keys(c)){const e=c[o];if(e.value&&e.value.length>=8192){const t="blob"+s;s++,r.push(t);const i={[o]:{type:e.type,value:JSON.parse(e.value)}};a.addBlob(t,JSON.stringify(i))}else{if(i+=e.type.length+21,e.value&&(i+=e.value.length),i>16384){const e="blob"+s;s++,r.push(e),a.addBlob(e,JSON.stringify(n)),n={},i=0}n[o]={type:e.type,value:void 0===e.value?void 0:JSON.parse(e.value)}}}const l={blobs:r,content:n};return a.addBlob("header",JSON.stringify(l)),a.getSummaryTree()}async loadCore(e){const t=await Object(r.a)(e,"header"),i=t;Array.isArray(i.blobs)?(this.kernel.populateFromSerializable(i.content),await Promise.all(i.blobs.map(async t=>{const i=await Object(r.a)(e,t);this.kernel.populateFromSerializable(i)}))):this.kernel.populateFromSerializable(t)}onDisconnect(){}reSubmitCore(e,t){this.kernel.trySubmitMessage(e,t)}applyStashedOp(e){return this.kernel.tryProcessMessage(e,!1,void 0),this.kernel.tryGetStashedOpLocalMetadata(e)}processCore(e,t,i){e.type===n.a.Operation&&this.kernel.tryProcessMessage(e.contents,t,i)}rollback(e,t){this.kernel.rollback(e,t)}}},28820:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s="1.3.1"},28821:function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var s=i(27455),n=i(28824),r=i(28838),a=i(28842),o=i(28822),c=i(28828),l=i(28831),h=i(28835),u=i(28836),d=i(28839),m=i(28825),g=i(28908);class p extends o.a{constructor(e,t,i){super((e,t)=>this.eventListenerErrorHandler(e,t)),this.id=e,this.runtime=t,this.attributes=i,this._connected=!1,this._isBoundToContext=!1,Object(n.a)(!e.includes("/"),772),this.handle=new m.a(this,e,t.IFluidHandleContext),this.logger=c.a.create(t.logger,void 0,{all:{sharedObjectId:Object(s.a)(),ddsType:{value:this.attributes.type,tag:c.d.CodeArtifact}}}),this.mc=Object(l.c)(this.logger),[this.opProcessingHelper,this.callbacksHelper]=this.setUpSampledTelemetryHelpers(),this.attachListeners()}get IFluidLoadable(){return this}get connected(){return this._connected}setUpSampledTelemetryHelpers(){var e,t;Object(n.a)(void 0!==this.mc&&void 0!==this.logger,"this.mc and/or this.logger has not been set");const i=new h.a({eventName:"ddsOpProcessing",category:"performance"},this.logger,null!==(e=this.mc.config.getNumber("Fluid.SharedObject.OpProcessingTelemetrySampling"))&&void 0!==e?e:100,!0,new Map([["local",{localOp:!0}],["remote",{localOp:!1}]])),s=new h.a({eventName:"ddsEventCallbacks",category:"performance"},this.logger,null!==(t=this.mc.config.getNumber("Fluid.SharedObject.DdsCallbacksTelemetrySampling"))&&void 0!==t?t:100,!0);return this.runtime.once("dispose",()=>{this.callbacksHelper.dispose(),this.opProcessingHelper.dispose()}),[i,s]}closeWithError(e){void 0===this.closeError&&(this.closeError=e)}verifyNotClosed(){if(void 0!==this.closeError)throw this.closeError}eventListenerErrorHandler(e,t){const i=u.c.wrapIfUnrecognized(t,"SharedObjectEventListenerException");throw i.addTelemetryProperties({emittedEventName:String(e)}),this.closeWithError(i),i}attachListeners(){this.isAttached()||this.runtime.once("attaching",()=>{this.didAttach()})}async load(e){this.runtime.attachState!==r.a.Detached&&(this.services=e),await this.loadCore(e.objectStorage),this.runtime.attachState!==r.a.Detached&&this.attachDeltaHandler()}initializeLocal(){this.initializeLocalCore()}bindToContext(){this._isBoundToContext||(this._isBoundToContext=!0,this.runtime.bindChannel(this))}connect(e){this.services=e,this.attachDeltaHandler()}isAttached(){return void 0!==this.services&&this.runtime.attachState!==r.a.Detached}handleDecoded(e){var t,i,s;this.isAttached()&&(null===(s=null===(t=this.services)||void 0===t?void 0:(i=t.deltaConnection).addedGCOutboundReference)||void 0===s||s.call(i,this.handle,e))}initializeLocalCore(){}didAttach(){}submitLocalMessage(e,t){this.verifyNotClosed(),this.isAttached()&&this.services.deltaConnection.submit(e,t)}dirty(){this.isAttached()&&this.services.deltaConnection.dirty()}onConnect(){}reSubmitCore(e,t){this.submitLocalMessage(e,t)}async newAckBasedPromise(e){let t;return new Promise((i,s)=>{t=()=>s(new Error("FluidDataStoreRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(i,s))}).finally(()=>{this.runtime.off("dispose",t)})}attachDeltaHandler(){Object(n.a)(void 0!==this.services,122),this._isBoundToContext=!0,this.didAttach(),this.services.deltaConnection.attach({process:(e,t,i)=>{this.process(e,t,i)},setConnectionState:e=>{this.setConnectionState(e)},reSubmit:(e,t)=>{this.reSubmit(e,t)},applyStashedOp:e=>this.applyStashedOp(e),rollback:(e,t)=>{this.rollback(e,t)}}),this.setConnectionState(this.services.deltaConnection.connected)}setConnectionState(e){this._connected!==e&&(this._connected=e,e?this.onConnect():this.onDisconnect())}process(e,t,i){this.verifyNotClosed(),this.emitInternal("pre-op",e,t,this),this.opProcessingHelper.measure(()=>{this.processCore(e,t,i)},t?"local":"remote"),this.emitInternal("op",e,t,this)}reSubmit(e,t){this.reSubmitCore(e,t)}rollback(e,t){throw new Error("rollback not supported")}emit(e,...t){return this.callbacksHelper.measure(()=>super.emit(e,...t))}emitInternal(e,...t){return super.emit(e,...t)}}class f extends p{constructor(e,t,i,s){super(e,t,i),this.telemetryContextPrefix=s,this._isGCing=!1,this._serializer=new d.a(this.runtime.channelsRoutingContext,e=>this.handleDecoded(e))}get serializer(){return Object(n.a)(!this._isGCing,117),this._serializer}getAttachSummary(e=!1,t=!1,i){const s=this.summarizeCore(this.serializer,i);return this.incrementTelemetryMetric(a.blobCountPropertyName,s.stats.blobNodeCount,i),this.incrementTelemetryMetric(a.totalBlobSizePropertyName,s.stats.totalBlobSize,i),s}async summarize(e=!1,t=!1,i){const s=this.summarizeCore(this.serializer,i);return this.incrementTelemetryMetric(a.blobCountPropertyName,s.stats.blobNodeCount,i),this.incrementTelemetryMetric(a.totalBlobSizePropertyName,s.stats.totalBlobSize,i),s}getGCData(e=!1){let t;Object(n.a)(!this._isGCing,120),this._isGCing=!0;try{const e=new g.a(this.runtime.channelsRoutingContext,e=>this.handleDecoded(e));this.processGCDataCore(e),t={gcNodes:{"/":e.getSerializedRoutes()}},Object(n.a)(this._isGCing,121)}finally{this._isGCing=!1}return t}processGCDataCore(e){this.summarizeCore(e)}incrementTelemetryMetric(e,t,i){var s;const n=null!==(s=null==i?void 0:i.get(this.telemetryContextPrefix,e))&&void 0!==s?s:0;null==i||i.set(this.telemetryContextPrefix,e,n+t)}}},28822:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28823);class n extends s.a{constructor(e){super(),this.errorHandler=e}emit(e,...t){try{return super.emit(e,...t)}catch(i){return this.errorHandler(e,i),!0}}}},28823:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(18269);class n extends s.EventEmitter{constructor(){super(),this.addListener=super.addListener.bind(this),this.on=super.on.bind(this),this.once=super.once.bind(this),this.prependListener=super.prependListener.bind(this),this.prependOnceListener=super.prependOnceListener.bind(this),this.removeListener=super.removeListener.bind(this),this.off=super.off.bind(this)}}},28824:function(e,t,i){"use strict";function s(e,t){if(!e)throw new Error("number"==typeof t?"0x"+t.toString(16).padStart(3,"0"):t)}i.d(t,"a",(function(){return s}))},28825:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28826);class n extends s.a{get isAttached(){return this.value.isAttached()}constructor(e,t,i){super(e,t,i)}attachGraph(){this.value.bindToContext(),super.attachGraph()}}},28826:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28827);class n{constructor(e,t,i){this.value=e,this.path=t,this.routeContext=i,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=Object(s.a)(t,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}get visible(){return this.isAttached||this.locallyVisible}async get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach(e=>{e.attachGraph()}),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bind(e){this.visible?e.attachGraph():this.pendingHandlesToMakeVisible.add(e)}}},28827:function(e,t,i){"use strict";function s(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let i=e.startsWith("/")?e.slice(1):e;return i=i.endsWith("/")?i.slice(0,-1):i,void 0===t?"/"+i:`${"/"===t.absolutePath?"":t.absolutePath}/${i}`}}i.d(t,"a",(function(){return s}))},28828:function(e,t,i){"use strict";i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return c})),i.d(t,"c",(function(){return l})),i.d(t,"a",(function(){return h})),i.d(t,"b",(function(){return u}));var s,n=i(28833),r=i(28834),a=i(28831),o=i(28829);!function(e){e.PackageData="PackageData",e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(s||(s={}));class c{constructor(e,t){this.namespace=e,this.properties=t}static formatTick(e){return Math.floor(e)}static numberFromString(e){if(null==e)return;const t=Number(e);return Number.isNaN(t)?e:t}static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,i){const{message:s,errorType:n,stack:r}=Object(o.b)(t,!0);if(e.stack=r,e.error=s,e.errorType=n,Object(o.f)(t)){const i=t.getTelemetryProperties();for(const t of Object.keys(i))void 0===e[t]&&(e[t]=i[t])}void 0===e.stack&&i&&(e.stack=Object(o.d)())}sendTelemetryEvent(e,t){var i;this.sendTelemetryEventCore(Object.assign(Object.assign({},e),{category:null!==(i=e.category)&&void 0!==i?i:"generic"}),t)}sendTelemetryEventCore(e,t){const i=Object.assign({},e);void 0!==t&&c.prepareErrorObject(i,t,!1),"number"==typeof i.duration&&(i.duration=c.formatTick(i.duration)),this.send(i)}sendErrorEvent(e,t){this.sendTelemetryEventCore(Object.assign(Object.assign({error:e.eventName},e),{category:"error"}),t)}sendPerformanceEvent(e,t){var i;const s=Object.assign(Object.assign({},e),{category:null!==(i=e.category)&&void 0!==i?i:"performance"});this.sendTelemetryEventCore(s,t)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,i=Object.assign({},e);if(void 0!==this.namespace&&(i.eventName=`${this.namespace}${c.eventNamespaceSeparator}${i.eventName}`),this.properties){const s=[];s.push(this.properties.all),t&&s.push(this.properties.error);for(const t of s)if(void 0!==t)for(const s of Object.keys(t)){if(void 0!==e[s])continue;const n=t[s],r="function"==typeof n?n():n;void 0!==r&&(i[s]=r)}}return i}}c.eventNamespaceSeparator=":";class l{constructor(e){this.logger=e}send(e){const t={category:e.category,eventName:e.eventName};for(const i of Object.keys(e)){const n=e[i],{value:r,tag:a}="object"==typeof n?n:{value:n,tag:void 0};switch(a){case void 0:case s.PackageData:t[i]=r;break;case s.UserData:t[i]="REDACTED (UserData)";break;default:t[i]="REDACTED (unknown tag)"}}this.logger.send(t)}}class h extends c{constructor(e,t,i){super(t,i),this.baseLogger=e,Object(a.b)(e)&&Object(a.d)(this,new a.a(e.config))}static create(e,t,i){if(e instanceof h){const s={};for(const t of[e.properties,i])void 0!==t&&(void 0!==t.all&&(s.all=Object.assign(Object.assign({},s.all),t.all)),void 0!==t.error&&(s.error=Object.assign(Object.assign({},s.error),t.error)));const n=void 0===e.namespace?t:void 0===t?e.namespace:`${e.namespace}${c.eventNamespaceSeparator}${t}`;return new h(e.baseLogger,n,s)}return new h(e||new n.a,t,i)}send(e){this.baseLogger.send(this.prepareEvent(e))}}class u{constructor(e,t,i={end:!0,cancel:"generic"}){this.logger=e,this.markers=i,this.startTime=r.a.now(),this.event=Object.assign({},t),this.markers.start&&this.reportEvent("start"),"object"==typeof window&&null!=window&&window.performance&&(this.startMark=t.eventName+"-start",window.performance.mark(this.startMark))}static start(e,t,i){return new u(e,t,i)}static timedExec(e,t,i,s){const n=u.start(e,t,s);try{const e=i(n);return n.autoEnd(),e}catch(r){throw n.cancel(void 0,r),r}}static async timedExecAsync(e,t,i,s){const n=u.start(e,t,s);try{const e=await i(n);return n.autoEnd(),e}catch(r){throw n.cancel(void 0,r),r}}get duration(){return r.a.now()-this.startTime}reportProgress(e,t="update"){this.reportEvent(t,e)}autoEnd(){this.event&&this.markers.end&&this.reportEvent("end"),this.performanceEndMark(),this.event=void 0}end(e){this.reportEvent("end",e),this.performanceEndMark(),this.event=void 0}performanceEndMark(){if(this.startMark&&this.event){const e=this.event.eventName+"-end";window.performance.mark(e),window.performance.measure(""+this.event.eventName,this.startMark,e),this.startMark=void 0}}cancel(e,t){void 0!==this.markers.cancel&&this.reportEvent("cancel",Object.assign({category:this.markers.cancel},e),t),this.event=void 0}reportEvent(e,t,i){if(!this.event)return;const s=Object.assign(Object.assign({},this.event),t);s.eventName=`${s.eventName}_${e}`,"start"!==e&&(s.duration=this.duration),this.logger.sendPerformanceEvent(s,i)}}},28829:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"f",(function(){return a})),i.d(t,"g",(function(){return o})),i.d(t,"c",(function(){return l})),i.d(t,"d",(function(){return h})),i.d(t,"h",(function(){return u})),i.d(t,"i",(function(){return d})),i.d(t,"e",(function(){return g})),i.d(t,"a",(function(){return p}));var s=i(27455),n=i(28830);function r(e,t){const i={message:"string"==typeof(null==e?void 0:e.message)?e.message:String(e)};if(null!==(s=e)&&!Array.isArray(s)&&"object"==typeof s){const{errorType:s,stack:n,name:r}=e;if("string"==typeof s&&(i.errorType=s),"string"==typeof n){const e="string"==typeof r?r:void 0;i.stack=((e,i)=>{if(!t)return e;const s=e.split("\n");return s.shift(),void 0!==i&&s.unshift(i),s.join("\n")})(n,e)}}var s;return i}const a=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties);function o(e,t={}){var i;if(Object(n.c)(e)&&function(e){const t=e;void 0===t.errorInstanceId&&(t.errorInstanceId=Object(s.a)())}(e),Object(n.b)(e))return e.addTelemetryProperties(null!==(i=t.props)&&void 0!==i?i:{}),e;const{message:c,stack:l}=r(e,!1),h=new f({message:c,stack:l});if("object"==typeof e&&null!==e){const{canRetry:t,retryAfterSeconds:i}=e;Object.assign(o,{canRetry:t,retryAfterSeconds:i})}"object"!=typeof e&&h.addTelemetryProperties({typeofError:typeof e});const u=a(e)?e.getTelemetryProperties():{};return h.addTelemetryProperties(Object.assign(Object.assign(Object.assign({},u),t.props),{untrustedOrigin:1})),h}let c;function l(){const e=new Error("<<generated stack>>");if(void 0===c&&(c=void 0!==e.stack),c)return e;try{throw e}catch(t){return t}}function h(){return l().stack}function u(e,t){const{message:i,stack:s}=r(e,!1),o=t(i);return void 0!==s&&m(o,s),g(e)&&o.addTelemetryProperties({untrustedOrigin:1}),Object(n.a)(e)&&(o.overwriteErrorInstanceId(e.errorInstanceId),o.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),a(e)&&o.addTelemetryProperties(e.getTelemetryProperties()),o}function d(e,t,i){const s=u(e,t),n=s.errorInstanceId,r=n;return i.sendTelemetryEvent({eventName:"WrapError",errorInstanceId:n,wrappedByErrorInstanceId:r},e),s}function m(e,t){try{Object.assign(e,{stack:t})}catch(i){e.addTelemetryProperties({stack2:t})}}function g(e){return!Object(n.c)(e)||1===e.getTelemetryProperties().untrustedOrigin&&e.errorType===f.normalizedErrorType}class p extends Error{constructor(e,t,i=new Set){super(e),this.omitPropsFromLogging=i,this._errorInstanceId=Object(s.a)(),this.fluidErrorCode="-",i.add("omitPropsFromLogging"),i.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}addTelemetryProperties(e){!function(e,t){for(const i of Object.keys(t))void 0===e[i]&&(e[i]=t[i])}(this,e)}getTelemetryProperties(){const e=function(e,t){const i={};for(const n of Object.keys(e)){if(t.has(n))continue;const r=e[n];switch(typeof r){case"string":case"number":case"boolean":case"undefined":i[n]=r;break;default:"object"!=typeof(null==(s=r)?void 0:s.value)&&"string"==typeof(null==s?void 0:s.tag)?i[n]=r:i[n]="REDACTED (arbitrary object)"}}var s;return i}(this,this.omitPropsFromLogging);return Object.assign(Object.assign({},e),{stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId})}}class f extends p{constructor(e){super(e.message),this.errorType=f.normalizedErrorType,void 0!==e.stack&&m(this,e.stack)}}f.normalizedErrorType="genericError"},28830:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return a}));const s=e=>"function"==typeof(null==e?void 0:e.getTelemetryProperties)&&"function"==typeof(null==e?void 0:e.addTelemetryProperties),n=e=>"string"==typeof(null==e?void 0:e.errorInstanceId);function r(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&n(e)&&s(e)}function a(e){return"string"==typeof(null==e?void 0:e.errorType)&&"string"==typeof(null==e?void 0:e.message)&&s(e)}},28831:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return h})),i.d(t,"c",(function(){return u})),i.d(t,"d",(function(){return d}));const s=new(i(28832).a)(()=>r(c())),n={getRawConfig:()=>{}},r=e=>null!=e?new l({getRawConfig:t=>{var i,s;try{return null===(s=o(null!==(i=e.getItem(t))&&void 0!==i?i:void 0))||void 0===s?void 0:s.raw}catch(n){}}}):n;function a(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function o(e){let t,i=e;if("string"==typeof e)try{i=JSON.parse(e),t={raw:e,string:e}}catch(n){}if(void 0===i)return t;const s=typeof i;if(a(s))return Object.assign(Object.assign({},t),{raw:e,[s]:i});if(Array.isArray(i)){const s=typeof i[0];if(!a(s))return t;for(const e of i)if(typeof e!==s)return t;return Object.assign(Object.assign({},t),{raw:e,[s+"[]"]:i})}return t}const c=()=>{try{return null!==sessionStorage?sessionStorage:void 0}catch(e){return}};class l{constructor(...e){this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set,i=[...e];for(;i.length>0;){const e=i.shift();void 0!==e&&m(e)&&!t.has(e)&&(t.add(e),e instanceof l?i.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){if(!this.configCache.has(e)){for(const t of this.orderedBaseProviders){const i=o(null==t?void 0:t.getRawConfig(e));if(void 0!==i)return this.configCache.set(e,i),i}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function h(e){const t=e;return m(null==t?void 0:t.config)&&void 0!==(null==t?void 0:t.logger)}function u(e){return h(e)?e:d(e,s.value)}function d(e,...t){if(h(e))throw new Error("Logger is already a monitoring context");const i=e;return i.config=new l(...t),i.logger=e,i}function m(e){const t=e;return"function"==typeof(null==t?void 0:t.getRawConfig)}},28832:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(e){this.valueGenerator=e,this._evaluated=!1}get evaluated(){return this._evaluated}get value(){return this._evaluated||(this._evaluated=!0,this._value=this.valueGenerator()),this._value}}},28833:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{send(e){}}},28834:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s=window.performance},28835:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28834);class n{constructor(e,t,i,s=!1,n=new Map){this.eventBase=e,this.logger=t,this.sampleThreshold=i,this.includeAggregateMetrics=s,this.perBucketProperties=n,this.disposed=!1,this.measurementsMap=new Map}measure(e,t=""){var i,n,r;const a=s.a.now(),o=e(),c=s.a.now()-a;let l=this.measurementsMap.get(t);return void 0===l&&(l={count:0,duration:-1},this.measurementsMap.set(t,l)),l.count++,l.duration=c,this.includeAggregateMetrics&&(l.totalDuration=(null!==(i=l.totalDuration)&&void 0!==i?i:0)+c,l.minDuration=Math.min(null!==(n=l.minDuration)&&void 0!==n?n:c,c),l.maxDuration=Math.max(null!==(r=l.maxDuration)&&void 0!==r?r:0,c)),l.count>=this.sampleThreshold&&this.flushBucket(t),o}flushBucket(e){const t=this.measurementsMap.get(e);if(void 0!==t&&0!==t.count){const i=this.perBucketProperties.get(e),s=Object.assign(Object.assign(Object.assign({},this.eventBase),i),t);this.logger.sendPerformanceEvent(s),this.measurementsMap.delete(e)}}dispose(e){this.measurementsMap.forEach((e,t)=>this.flushBucket(t))}}},28836:function(e,t,i){"use strict";i.d(t,"d",(function(){return r})),i.d(t,"e",(function(){return a})),i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return l})),i.d(t,"f",(function(){return h}));var s=i(28837),n=i(28829);class r extends n.a{constructor(e,t,i){super(e,i,new Set(["error"])),this.error=t,this.errorType=s.a.genericError}}n.a;class a extends n.a{constructor(e){super(e,{usageError:!0}),this.errorType="usageError"}}class o extends n.a{constructor(e,t){super(e,{timeoutMs:t}),this.expiryMs=t,this.errorType=s.a.clientSessionExpiredError}}class c extends n.a{constructor(e,t){super(e,Object.assign(Object.assign({},t),{dataProcessingError:1})),this.errorType=s.a.dataCorruptionError,this.canRetry=!1}}class l extends n.a{constructor(e){super(e),this.errorType=s.a.dataProcessingError,this.canRetry=!1}static create(e,t,i,s={}){const n=l.wrapIfUnrecognized(e,t,i);return n.addTelemetryProperties(s),n}static wrapIfUnrecognized(e,t,i){const s=Object.assign({dataProcessingError:1,dataProcessingCodepath:t},void 0===i?void 0:h(i)),r=Object(n.g)(e,{props:s});if(!Object(n.e)(r))return r;const a=Object(n.h)(r,e=>new l(e));return a.addTelemetryProperties(r.getTelemetryProperties()),a}}const h=e=>({messageClientId:e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp})},28837:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(s||(s={}))},28838:function(e,t,i){"use strict";var s,n;i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n})),function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(s||(s={})),function(e){e.NotBound="NotBound",e.Binding="Binding",e.Bound="Bound"}(n||(n={}))},28839:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28827),n=i(28840);class r{constructor(e,t){for(this.context=e,this.handleParsedCb=t,this.encodeValue=(e,t)=>{const i=null==e?void 0:e.IFluidHandle;return void 0!==i?this.serializeHandle(i,t):e},this.decodeValue=e=>{if((e=>"__fluid_handle__"===(null==e?void 0:e.type))(e)){const t=e.url.startsWith("/")?e.url:Object(s.a)(e.url,this.context),i=new n.a(t,this.root);return this.handleParsedCb(i),i}return e},this.root=this.context;void 0!==this.root.routeContext;)this.root=this.root.routeContext}get IFluidSerializer(){return this}encode(e,t){return e&&"object"==typeof e?this.recursivelyReplace(e,this.encodeValue,t):e}decode(e){return e&&"object"==typeof e?this.recursivelyReplace(e,this.decodeValue):e}stringify(e,t){return JSON.stringify(e,(e,i)=>this.encodeValue(i,t))}parse(e){return JSON.parse(e,(e,t)=>this.decodeValue(t))}recursivelyReplace(e,t,i){const s=t(e,i);if(s!==e)return s;let n;for(const r of Object.keys(e)){const s=e[r];if(s&&"object"==typeof s){const a=this.recursivelyReplace(s,t,i);a!==s&&(n=null!=n?n:Array.isArray(e)?[...e]:Object.assign({},e),n[r]=a)}}return null!=n?n:e}serializeHandle(e,t){return t.bind(e),{type:"__fluid_handle__",url:e.absolutePath}}}},28840:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var s=i(28824),n=i(28841),r=i(28876);class a{constructor(e,t){this.absolutePath=e,this.routeContext=t,this.isAttached=!0,Object(s.a)(e.startsWith("/"),413)}get IFluidRouter(){return this}get IFluidHandleContext(){return this}get IFluidHandle(){return this}async get(){if(void 0===this.objectP){const e={url:this.absolutePath,headers:{[n.a.viaHandle]:!0}};this.objectP=this.routeContext.resolveHandle(e).then(t=>{if("fluid/object"===t.mimeType){return t.value}throw Object(r.d)(t,e)})}return this.objectP}attachGraph(){}bind(e){e.attachGraph()}async request(e){try{const t=(await this.get()).IFluidRouter;return void 0!==t?t.request(e):Object(r.a)(e)}catch(t){return Object(r.b)(t)}}}},28841:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));i(28838),i(28892),i(28824),i(28834);var s,n=i(28823),r=(i(28868),i(28906),i(28828),i(28831),i(28905),i(28893),i(28850),i(28861),i(28836),i(28849),i(28860),i(28842));i(28879),i(28904),i(28876),i(28870),i(28907),i(28877),i(27455),i(28855),i(28903),i(28887),i(28898),i(28853),i(28851),i(28883),i(28852),i(28882),i(28863),i(28859),i(28885),i(28886),i(28854),i(28899),i(28897),i(28856),i(28875),i(28900),i(28902),i(28901);!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias"}(s||(s={}));var a;!function(e){e.wait="wait",e.externalRequest="externalRequest",e.viaHandle="viaHandle"}(a||(a={}));r.FlushMode.TurnBased;var o;!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias",e.Operation="op"}(o||(o={}));n.a},28842:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),n=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||s(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),n(i(28843),t),n(i(28844),t),n(i(28845),t),n(i(28846),t),n(i(28847),t),n(i(28848),t)},28843:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreFactory=void 0,t.IFluidDataStoreFactory="IFluidDataStoreFactory"},28844:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},28845:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(t.FlushMode||(t.FlushMode={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},28846:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gcBlobKey=void 0,t.gcBlobKey="gc"},28847:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},28848:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=void 0,function(e){e[e.FromSummary=0]="FromSummary",e[e.FromAttach=1]="FromAttach",e[e.Local=2]="Local"}(t.CreateSummarizerNodeSource||(t.CreateSummarizerNodeSource={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},28849:function(e,t,i){"use strict";var s,n;i.d(t,"a",(function(){return s})),function(e){e.NoOp="noop",e.ClientJoin="join",e.ClientLeave="leave",e.Propose="propose",e.Reject="reject",e.Summarize="summarize",e.SummaryAck="summaryAck",e.SummaryNack="summaryNack",e.Operation="op",e.RemoteHelp="remoteHelp",e.NoClient="noClient",e.RoundTrip="tripComplete",e.Control="control"}(s||(s={})),function(e){e.ThrottlingError="ThrottlingError",e.InvalidScopeError="InvalidScopeError",e.BadRequestError="BadRequestError",e.LimitExceededError="LimitExceededError"}(n||(n={}))},28850:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a}));var s,n=i(28849);function r(e){return e.type===n.a.Operation||e.type===n.a.Summarize}function a(e){return!!Object.values(s).includes(e.type)}!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias",e.Operation="op"}(s||(s={}))},28851:function(e,t,i){"use strict";i.d(t,"b",(function(){return o})),i.d(t,"a",(function(){return l}));var s=i(28828),n=i(28849),r=i(28834),a=i(28824);const o=5e3;class c{constructor(e,t,i){this.clientId=e,this.deltaManager=t,this.pongCount=0,this.msnTrackingTimestamp=0,this.opProcessingTimes={},this.opPerfData={},this.firstConnection=!0,this.bootTime=r.a.now(),this.connectionStartTime=0,this.gap=0,this.logger=s.a.create(i,"OpPerf"),this.deltaManager.on("pong",e=>this.recordPingTime(e)),this.deltaManager.on("submitOp",e=>this.beforeOpSubmit(e)),this.deltaManager.on("op",e=>this.afterProcessingOp(e)),this.deltaManager.on("connect",(e,t)=>{this.clientId=e.clientId,void 0!==t&&(this.connectionOpSeqNumber=this.deltaManager.lastKnownSeqNumber,this.gap=t,this.connectionStartTime=r.a.now(),this.gap<=0&&this.reportGettingUpToDate())}),this.deltaManager.on("disconnect",()=>{this.sequenceNumberForMsnTracking=void 0,this.clientSequenceNumberForLatencyStatistics=void 0,this.opProcessingTimes={},this.opPerfData={},this.connectionOpSeqNumber=void 0,this.firstConnection=!1,this.pongCount=0}),this.deltaManager.outbound.on("push",e=>{for(const t of e)t.type===n.a.Operation&&this.clientSequenceNumberForLatencyStatistics===t.clientSequenceNumber&&(Object(a.a)(void 0===this.opProcessingTimes.outboundPushEventTime,712),Object(a.a)(void 0===this.opPerfData.durationNetwork,713),this.opProcessingTimes.outboundPushEventTime=Date.now(),Object(a.a)(void 0===this.opPerfData.durationOutboundBatching,714),Object(a.a)(void 0!==this.opProcessingTimes.submitOpEventTime,715),this.opPerfData.durationOutboundBatching=this.opProcessingTimes.outboundPushEventTime-this.opProcessingTimes.submitOpEventTime)}),this.deltaManager.inbound.on("push",e=>{this.clientId===e.clientId&&e.type===n.a.Operation&&this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber&&void 0!==this.opProcessingTimes.outboundPushEventTime&&(this.opProcessingTimes.inboundPushEventTime=Date.now(),this.opPerfData.durationNetwork=this.opProcessingTimes.inboundPushEventTime-this.opProcessingTimes.outboundPushEventTime,this.opProcessingTimes.outboundPushEventTime=void 0,this.opPerfData.lengthInboundQueue=this.deltaManager.inbound.length)}),this.deltaManager.inbound.on("idle",(e,t)=>{"number"==typeof e&&e>=100&&this.logger.sendPerformanceEvent({eventName:"GetDeltas_OpProcessing",count:e,duration:t})})}reportGettingUpToDate(){this.connectionOpSeqNumber=void 0,this.logger.sendPerformanceEvent({eventName:"ConnectionSpeed",duration:r.a.now()-this.connectionStartTime,ops:this.gap,timeToConnect:this.firstConnection?s.e.formatTick(this.connectionStartTime-this.bootTime):void 0,firstConnection:this.firstConnection})}recordPingTime(e){this.pingLatency=e,this.pongCount%100==0&&this.deltaManager.active&&this.logger.sendPerformanceEvent({eventName:"DeltaLatency",duration:e}),this.pongCount++}beforeOpSubmit(e){void 0===this.clientSequenceNumberForLatencyStatistics&&e.clientSequenceNumber%500==1&&(Object(a.a)(void 0===this.opProcessingTimes.outboundPushEventTime,716),Object(a.a)(void 0===this.opPerfData.durationNetwork,717),this.opProcessingTimes.submitOpEventTime=Date.now(),this.clientSequenceNumberForLatencyStatistics=e.clientSequenceNumber)}afterProcessingOp(e){const t=e.sequenceNumber;if(t===this.connectionOpSeqNumber&&this.reportGettingUpToDate(),void 0===this.sequenceNumberForMsnTracking&&t%1e3==0&&(this.sequenceNumberForMsnTracking=t,this.msnTrackingTimestamp=e.timestamp),void 0!==this.sequenceNumberForMsnTracking&&e.minimumSequenceNumber>=this.sequenceNumberForMsnTracking&&(Object(a.a)(void 0!==this.msnTrackingTimestamp,718),this.logger.sendPerformanceEvent({eventName:"MsnStatistics",sequenceNumber:t,msnDistance:t-this.sequenceNumberForMsnTracking,duration:e.timestamp-this.msnTrackingTimestamp}),this.sequenceNumberForMsnTracking=void 0),this.clientId===e.clientId&&this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber){Object(a.a)(void 0!==this.opProcessingTimes.submitOpEventTime,288);const i=Date.now();void 0!==this.opProcessingTimes.inboundPushEventTime&&(this.opPerfData.durationInboundToProcessing=i-this.opProcessingTimes.inboundPushEventTime);const s=i-this.opProcessingTimes.submitOpEventTime,n=s>o?"error":"performance";this.logger.sendPerformanceEvent(Object.assign({eventName:"OpRoundtripTime",sequenceNumber:t,referenceSequenceNumber:e.referenceSequenceNumber,duration:s,category:n,pingLatency:this.pingLatency,msnDistance:this.deltaManager.lastSequenceNumber-this.deltaManager.minimumSequenceNumber},this.opPerfData)),this.clientSequenceNumberForLatencyStatistics=void 0,this.opPerfData={}}}}function l(e,t,i){new c(e,t,i)}},28852:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s="1.3.6"},28853:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28834),n=i(28828);class r{constructor(e,t){this.logger=t,this.processingTimeIncrement=10,this.currentAllowedProcessingTimeForTurn=r.processingTime,this.schedulingCount=0,this.deltaManager=e,this.deltaManager.inbound.on("idle",()=>{this.inboundQueueIdle()})}batchBegin(e){this.processingStartTime||(this.processingStartTime=s.a.now()),void 0===this.schedulingLog&&this.schedulingCount%500==0&&(this.schedulingLog={opsRemainingToProcess:0,numberOfTurns:1,totalProcessingTime:0,numberOfBatchesProcessed:0,firstSequenceNumber:e.sequenceNumber,lastSequenceNumber:e.sequenceNumber,startTime:s.a.now()})}batchEnd(e){if(this.schedulingLog&&(this.schedulingLog.numberOfBatchesProcessed++,this.schedulingLog.lastSequenceNumber=e.sequenceNumber,this.schedulingLog.opsRemainingToProcess=this.deltaManager.inbound.length),this.shouldRunScheduler()){const e=s.a.now(),t=e-this.processingStartTime;t>this.currentAllowedProcessingTimeForTurn&&(this.deltaManager.inbound.pause(),this.currentAllowedProcessingTimeForTurn+=this.processingTimeIncrement,this.schedulingLog&&(this.schedulingLog.numberOfTurns++,this.schedulingLog.totalProcessingTime+=t),setTimeout(()=>{this.schedulingLog&&this.logger.sendTelemetryEvent({eventName:"InboundOpsPartialProcessingTime",duration:n.e.formatTick(t),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,opsRemainingToProcess:this.deltaManager.inbound.length,processingTime:n.e.formatTick(this.schedulingLog.totalProcessingTime),numberOfTurns:this.schedulingLog.numberOfTurns,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,timeToResume:n.e.formatTick(s.a.now()-e)}),this.deltaManager.inbound.resume()}),this.processingStartTime=void 0)}}inboundQueueIdle(){if(this.schedulingLog){const e=s.a.now();this.schedulingLog.totalProcessingTime+=e-this.processingStartTime,this.logger.sendTelemetryEvent({eventName:"InboundOpsProcessingTime",opsRemainingToProcess:this.schedulingLog.opsRemainingToProcess,numberOfTurns:this.schedulingLog.numberOfTurns,processingTime:n.e.formatTick(this.schedulingLog.totalProcessingTime),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,duration:n.e.formatTick(e-this.schedulingLog.startTime),schedulingCount:this.schedulingCount}),this.schedulingLog=void 0}this.schedulingCount++,this.processingStartTime=void 0,this.currentAllowedProcessingTimeForTurn=r.processingTime}shouldRunScheduler(){return this.deltaManager.inbound.length>0}}r.processingTime=50},28854:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return a}));var s=i(28823),n=i(28849);const r="summarizer";class a extends s.a{constructor(e,t,i,s,r){super(),this.logger=e,this.summaryCollection=t,this.clientElection=i,this.maxOpsSinceLastSummary=s,this.electionEnabled=r,this.lastReportedSeq=0,this.summaryCollection.on("default",({sequenceNumber:e})=>{var t,i,n;const r=this.electedClientId;if(void 0===r)return void(this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(e));let a=this.clientElection.electionSequenceNumber;if(e-(null!==(t=this.lastSummaryAckSeqForClient)&&void 0!==t?t:a)>this.maxOpsSinceLastSummary){const t=e-this.lastReportedSeq;if(t>this.maxOpsSinceLastSummary&&(this.logger.sendErrorEvent({eventName:"ElectedClientNotSummarizing",electedClientId:r,lastSummaryAckSeqForClient:this.lastSummaryAckSeqForClient,electionSequenceNumber:a,nextElectedClientId:null===(i=this.clientElection.peekNextElectedClient())||void 0===i?void 0:i.clientId,electionEnabled:this.electionEnabled}),this.lastReportedSeq=e),this.electionEnabled){const i=this.electedParentId;this.clientElection.incrementElectedClient(e),a=this.clientElection.electionSequenceNumber,e>(null!==(n=this.lastSummaryAckSeqForClient)&&void 0!==n?n:a)&&t>this.maxOpsSinceLastSummary&&this.logger.sendErrorEvent({eventName:"UnexpectedElectionSequenceNumber",lastSummaryAckSeqForClient:this.lastSummaryAckSeqForClient,electionSequenceNumber:a,sequenceNumber:e,previousClientId:r,previousParentId:i,electedParentId:this.electedParentId,electedClientId:this.electedClientId,opsSinceLastReport:t,maxOpsSinceLastSummary:s})}}}),this.summaryCollection.on(n.a.SummaryAck,e=>{this.lastSummaryAckSeqForClient=e.sequenceNumber}),this.clientElection.on("election",(e,t)=>{this.lastSummaryAckSeqForClient=void 0,void 0===e&&this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(t),this.emit("electedSummarizerChanged")})}get electedClientId(){var e;return null===(e=this.clientElection.electedClient)||void 0===e?void 0:e.clientId}get electedParentId(){var e;return null===(e=this.clientElection.electedParent)||void 0===e?void 0:e.clientId}serialize(){var e;const{electedClientId:t,electedParentId:i,electionSequenceNumber:s}=this.clientElection.serialize();return{electedClientId:t,electedParentId:i,electionSequenceNumber:null!==(e=this.lastSummaryAckSeqForClient)&&void 0!==e?e:s}}static isClientEligible(e){const t=e.client.details;return void 0===t||a.clientDetailsPermitElection(t)}}a.clientDetailsPermitElection=e=>e.capabilities.interactive||e.type===r},28855:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28838),n=i(28827);class r{constructor(e,t,i){this.path=e,this.runtime=t,this.routeContext=i,this.absolutePath=Object(n.a)(e,this.routeContext)}get IFluidHandleContext(){return this}attachGraph(){throw new Error("can't attach container runtime form within container!")}get isAttached(){return this.runtime.attachState!==s.a.Detached}async resolveHandle(e){return this.runtime.resolveHandle(e)}}},28856:function(e,t,i){"use strict";i.d(t,"c",(function(){return v})),i.d(t,"a",(function(){return S})),i.d(t,"b",(function(){return T}));var s=i(28857),n=i(28858),r=i(28824),a=i(28836),o=i(28878),c=i(28877),l=i(28860),h=i(28842),u=i(28870),d=i(28831),m=i(28828),g=i(28841),p=i(28863),f=i(28859),b=function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(i[s[n]]=e[s[n]])}return i};const v="gc",S={DataStore:"DataStore",SubDataStore:"SubDataStore",Blob:"Blob",Other:"Other"},y="Active",C="Inactive",O="SweepReady";class w{constructor(e,t,i,s){this.unreferencedTimestampMs=e,this.inactiveTimeoutMs=t,this.sweepTimeoutMs=i,this._state=y,void 0!==s&&this.updateTracking(s)}get state(){return this._state}updateTracking(e){const t=e-this.unreferencedTimestampMs;if(void 0!==this.sweepTimeoutMs&&t>=this.sweepTimeoutMs)return this._state=O,void this.clearTimers();if(t>=this.inactiveTimeoutMs)return this._state=C,this.clearTimers(),void(void 0!==this.sweepTimeoutMs&&q(this.sweepTimeoutMs-t,()=>{this._state=O},e=>{this.sweepTimer=e}));const i=this.inactiveTimeoutMs-t;if(void 0===this.inactiveTimer){const e=()=>{this._state=C,void 0!==this.sweepTimeoutMs&&q(this.sweepTimeoutMs-this.inactiveTimeoutMs,()=>{this._state=O},e=>{this.sweepTimer=e})};this.inactiveTimer=new s.b(i,()=>e())}this.inactiveTimer.restart(i)}clearTimers(){var e;null===(e=this.inactiveTimer)||void 0===e||e.clear(),void 0!==this.sweepTimer&&clearTimeout(this.sweepTimer)}stopTracking(){this.clearTimers(),this._state=y}}class T{constructor(e){var t,i,s,l,u,g,b;this._writeDataAtRoot=!0,this.initialStateNeedsReset=!1,this.currentGCVersion=1,this.newReferencesSinceLastRun=new Map,this.unreferencedNodesState=new Map,this.loggedUnreferencedEvents=new Set,this.pendingEventsQueue=[],this.completedRuns=0,this.runtime=e.runtime,this.isSummarizerClient=e.isSummarizerClient,this.gcOptions=e.gcOptions,this.getNodePackagePath=e.getNodePackagePath,this.getLastSummaryTimestampMs=e.getLastSummaryTimestampMs;const S=e.baseSnapshot,y=e.metadata,C=e.readAndParseBlob;let O;if(this.mc=Object(d.c)(m.a.create(e.baseLogger,"GarbageCollector",{all:{completedGCRuns:()=>this.completedRuns}})),e.existing)O=Object(f.i)(y),this.gcEnabled=O>0,this.sweepEnabled=null!==(t=null==y?void 0:y.sweepEnabled)&&void 0!==t&&t,this.sessionExpiryTimeoutMs=null==y?void 0:y.sessionExpiryTimeoutMs;else{if(this.gcOptions.sweepAllowed&&!1===this.gcOptions.gcAllowed)throw new a.e("GC sweep phase cannot be enabled without enabling GC mark phase");this.gcEnabled=!1!==this.gcOptions.gcAllowed,this.sweepEnabled=!0===this.gcOptions.sweepAllowed,this.mc.config.getBoolean("Fluid.GarbageCollection.RunSessionExpiry")&&this.gcEnabled&&(this.sessionExpiryTimeoutMs=2592e6)}if(void 0!==this.sessionExpiryTimeoutMs&&!0!==this.mc.config.getBoolean("Fluid.GarbageCollection.DisableSessionExpiry")){const t=this.mc.config.getNumber("Fluid.GarbageCollection.TestOverride.SessionExpiryMs"),i=null!=t?t:this.sessionExpiryTimeoutMs;q(i,()=>{this.runtime.closeFn(new a.a("Client session expired.",i))},e=>{this.sessionExpiryTimer=e}),void 0!==e.snapshotCacheExpiryMs&&(this.sweepTimeoutMs=this.sessionExpiryTimeoutMs+e.snapshotCacheExpiryMs+864e5)}if(this.latestSummaryGCVersion=null!=O?O:this.currentGCVersion,this.shouldRunGC=null!==(i=this.mc.config.getBoolean("Fluid.GarbageCollection.RunGC"))&&void 0!==i?i:this.gcEnabled&&!this.gcOptions.disableGC,this.shouldRunSweep=this.shouldRunGC&&void 0!==this.sweepTimeoutMs&&(null!==(s=this.mc.config.getBoolean("Fluid.GarbageCollection.RunSweep"))&&void 0!==s?s:this.sweepEnabled),this.trackGCState=!0===this.mc.config.getBoolean("Fluid.GarbageCollection.TrackGCState"),this.inactiveTimeoutMs=null!==(u=null!==(l=this.mc.config.getNumber("Fluid.GarbageCollection.TestOverride.InactiveTimeoutMs"))&&void 0!==l?l:this.gcOptions.inactiveTimeoutMs)&&void 0!==u?u:6048e5,void 0!==this.sweepTimeoutMs&&this.inactiveTimeoutMs>this.sweepTimeoutMs)throw new a.e("inactive timeout should not be greated than the sweep timeout");if(this.testMode=null!==(g=this.mc.config.getBoolean("Fluid.GarbageCollection.GCTestMode"))&&void 0!==g?g:!0===this.gcOptions.runGCInTestMode,this._writeDataAtRoot=null===(b=this.mc.config.getBoolean("Fluid.GarbageCollection.WriteDataAtRoot"))||void 0===b||b,this._writeDataAtRoot){const e=void 0!==(null==S?void 0:S.trees[v]);this.initialStateNeedsReset=e!==this.shouldRunGC}const T=new n.b(async()=>{var e;if(void 0===S)return;const t=S.trees[v];if(void 0!==t){this._writeDataAtRoot=!0;const e=await k(t,C);return this.trackGCState&&(this.latestSerializedSummaryState=JSON.stringify(N(e))),e}const i={gcNodes:{"/":{outboundRoutes:[]}}},s=Object(p.b)(S,y);Object(r.a)(void 0!==s,680);for(const[n,a]of Object.entries(s.trees)){const t=a.blobs[h.gcBlobKey];if(void 0===t)continue;const s=await C(t);if(void 0===(null===(e=s.gcData)||void 0===e?void 0:e.gcNodes))continue;const o="/"+n;(await C(a.blobs[f.d])).isRootDataStore&&i.gcNodes["/"].outboundRoutes.push(o);for(const[e,n]of Object.entries(s.gcData.gcNodes)){const t="/"===e?o:`${o}${e}`;i.gcNodes[t]={outboundRoutes:Array.from(n)}}Object(r.a)(void 0!==i.gcNodes[o],681),i.gcNodes[o].unreferencedTimestampMs=s.unrefTimestamp}return 1===Object.keys(i.gcNodes).length?void 0:i});this.initializeBaseStateP=new n.b(async()=>{const e=this.runtime.getCurrentReferenceTimestampMs(),t=await T;if(void 0===t)return;const i={};for(const[s,n]of Object.entries(t.gcNodes))void 0!==n.unreferencedTimestampMs&&this.unreferencedNodesState.set(s,new w(n.unreferencedTimestampMs,this.inactiveTimeoutMs,this.sweepTimeoutMs,e)),i[s]=Array.from(n.outboundRoutes);this.previousGCDataFromLastRun={gcNodes:i}}),this.baseGCDetailsP=new n.b(async()=>{const e=await T;if(void 0===e)return new Map;const t={};for(const[n,r]of Object.entries(e.gcNodes))t[n]=Array.from(r.outboundRoutes);const i=Object(o.a)(t,["/"]).referencedNodeIds,s=Object(c.f)({gcData:{gcNodes:t},usedRoutes:i});for(const[n,r]of Object.entries(e.gcNodes))if(void 0!==r.unreferencedTimestampMs){const e=s.get(n.slice(1));void 0!==e&&(e.unrefTimestamp=r.unreferencedTimestampMs)}return s});const R=JSON.stringify(Object.assign({gcEnabled:this.gcEnabled,sweepEnabled:this.sweepEnabled,runGC:this.shouldRunGC,runSweep:this.shouldRunSweep,writeAtRoot:this._writeDataAtRoot,testMode:this.testMode,sessionExpiry:this.sessionExpiryTimeoutMs,inactiveTimeout:this.inactiveTimeoutMs,existing:e.existing,trackGCState:this.trackGCState},this.gcOptions));this.isSummarizerClient&&this.mc.logger.sendTelemetryEvent({eventName:"GarbageCollectorLoaded",gcConfigs:R}),this.shouldRunGC&&this.initializeBaseStateP.catch(e=>{const t=a.c.wrapIfUnrecognized(e,"FailedToInitializeGC");throw t.addTelemetryProperties({gcConfigs:R}),t})}static create(e){return new T(e)}get summaryStateNeedsReset(){return this.initialStateNeedsReset||this.shouldRunGC&&this.latestSummaryGCVersion!==this.currentGCVersion}get writeDataAtRoot(){return this._writeDataAtRoot}async collectGarbage(e){const{fullGC:t=!0===this.gcOptions.runFullGC||this.summaryStateNeedsReset}=e,i=e.logger?m.a.create(e.logger,void 0,{all:{completedGCRuns:()=>this.completedRuns}}):this.mc.logger;return m.b.timedExecAsync(i,{eventName:"GarbageCollection"},async e=>{await this.runPreGCSteps();const s=await this.runtime.getGCData(t),n=Object(o.a)(s.gcNodes,["/"]),r=await this.runPostGCSteps(s,n,i);return e.end(Object.assign({},r)),this.completedRuns++,r},{end:!0,cancel:"error"})}async runPreGCSteps(){await this.initializeBaseStateP,await this.runtime.updateStateBeforeGC()}async runPostGCSteps(e,t,i){const s=this.generateStats(t);this.updateStateSinceLastRun(e,i);const n=this.runtime.getCurrentReferenceTimestampMs();return this.updateCurrentState(e,t,n),this.runtime.updateUsedRoutes(t.referencedNodeIds,n),this.logSweepEvents(i,n),this.testMode&&this.runtime.deleteUnusedRoutes(t.deletedNodeIds),await this.logUnreferencedEvents(i),s}summarize(e,t,i){var s;if(!this.shouldRunGC||void 0===this.previousGCDataFromLastRun)return;const n={gcNodes:{}};for(const[o,c]of Object.entries(this.previousGCDataFromLastRun.gcNodes))n.gcNodes[o]={outboundRoutes:c,unreferencedTimestampMs:null===(s=this.unreferencedNodesState.get(o))||void 0===s?void 0:s.unreferencedTimestampMs};const r=JSON.stringify(N(n));if(this.trackGCState&&(this.pendingSerializedSummaryState=r,void 0!==this.latestSerializedSummaryState&&this.latestSerializedSummaryState===r&&!e&&t)){const e=Object(u.j)();return e.handleNodeCount++,{summary:{type:l.a.Handle,handle:"/"+v,handleType:l.a.Tree},stats:e}}const a=new u.a;return a.addBlob("__gc_root",r),a.getSummaryTree()}getMetadata(){return{gcFeature:this.gcEnabled?this.currentGCVersion:0,sessionExpiryTimeoutMs:this.sessionExpiryTimeoutMs,sweepEnabled:this.sweepEnabled}}async getBaseGCDetails(){return this.baseGCDetailsP}async latestSummaryStateRefreshed(e,t){if(!this.shouldRunGC||!e.latestSummaryUpdated)return;if(e.wasSummaryTracked)return this.latestSummaryGCVersion=this.currentGCVersion,this.initialStateNeedsReset=!1,void(this.trackGCState&&(this.latestSerializedSummaryState=this.pendingSerializedSummaryState,this.pendingSerializedSummaryState=void 0));const i=e.snapshot,s=i.blobs[f.k];if(s){const e=await t(s);this.latestSummaryGCVersion=Object(f.i)(e)}const n=i.trees[v];if(void 0!==n&&this.trackGCState){const e=await k(n,t);this.latestSerializedSummaryState=JSON.stringify(N(e))}else this.latestSerializedSummaryState=void 0;this.pendingSerializedSummaryState=void 0}nodeUpdated(e,t,i,s,n){if(!this.shouldRunGC)return;const r=this.unreferencedNodesState.get(e);r&&r.state!==y&&this.inactiveNodeUsed(t,e,r,void 0,s,i,n)}addedOutboundReference(e,t){var i;if(!this.shouldRunGC)return;const s=null!==(i=this.newReferencesSinceLastRun.get(e))&&void 0!==i?i:[];s.push(t),this.newReferencesSinceLastRun.set(e,s);const n=this.unreferencedNodesState.get(t);n&&n.state!==y&&this.inactiveNodeUsed("Revived",t,n,e)}dispose(){void 0!==this.sessionExpiryTimer&&(clearTimeout(this.sessionExpiryTimer),this.sessionExpiryTimer=void 0)}updateCurrentState(e,t,i){this.previousGCDataFromLastRun=Object(c.b)(e),this.newReferencesSinceLastRun.clear();for(const s of t.referencedNodeIds){const e=this.unreferencedNodesState.get(s);void 0!==e&&(e.stopTracking(),this.unreferencedNodesState.delete(s))}if(void 0!==i)for(const s of t.deletedNodeIds){const e=this.unreferencedNodesState.get(s);void 0===e?this.unreferencedNodesState.set(s,new w(i,this.inactiveTimeoutMs,this.sweepTimeoutMs,i)):e.updateTracking(i)}}updateStateSinceLastRun(e,t){if(void 0===this.previousGCDataFromLastRun)return;const i=this.findMissingExplicitReferences(e,this.previousGCDataFromLastRun,this.newReferencesSinceLastRun);if(this.writeDataAtRoot&&i.length>0&&i.forEach(e=>{const i={eventName:"gcUnknownOutboundReferences",gcNodeId:e[0],gcRoutes:JSON.stringify(e[1])};t.sendPerformanceEvent(i)}),0===this.newReferencesSinceLastRun.size)return;const s=Object(c.c)(this.previousGCDataFromLastRun,e);this.newReferencesSinceLastRun.forEach((e,t)=>{void 0===s.gcNodes[t]?s.gcNodes[t]=e:s.gcNodes[t].push(...e)});const n=Object(o.a)(s.gcNodes,["/"]);for(const r of n.referencedNodeIds){const e=this.unreferencedNodesState.get(r);void 0!==e&&(e.stopTracking(),this.unreferencedNodesState.delete(r))}}findMissingExplicitReferences(e,t,i){Object(r.a)(void 0!==t,695);const s=Object.entries(e.gcNodes),n=[];return s.forEach(([e,s])=>{var r,a;const o=null!==(r=t.gcNodes[e])&&void 0!==r?r:[],c=null!==(a=i.get(e))&&void 0!==a?a:[],l=[];s.forEach(t=>{const i=this.runtime.getNodeType(t)===S.Blob||this.runtime.getNodeType(t)===S.DataStore,s=!e.startsWith(t);i&&s&&!o.includes(t)&&!c.includes(t)&&l.push(t)}),l.length>0&&n.push([e,l])}),n}generateStats(e){const t={nodeCount:0,dataStoreCount:0,attachmentBlobCount:0,unrefNodeCount:0,unrefDataStoreCount:0,unrefAttachmentBlobCount:0,updatedNodeCount:0,updatedDataStoreCount:0,updatedAttachmentBlobCount:0},i=(e,i)=>{t.nodeCount++;const s=void 0===this.previousGCDataFromLastRun||this.unreferencedNodesState.has(e)===i;s&&t.updatedNodeCount++,i||t.unrefNodeCount++,this.runtime.getNodeType(e)===S.DataStore&&(t.dataStoreCount++,s&&t.updatedDataStoreCount++,i||t.unrefDataStoreCount++),this.runtime.getNodeType(e)===S.Blob&&(t.attachmentBlobCount++,s&&t.updatedAttachmentBlobCount++,i||t.unrefAttachmentBlobCount++)};for(const s of e.referencedNodeIds)i(s,!0);for(const s of e.deletedNodeIds)i(s,!1);return t}logSweepEvents(e,t){!0!==this.mc.config.getBoolean("Fluid.GarbageCollection.DisableSweepLog")&&void 0!==t&&void 0!==this.sweepTimeoutMs&&this.unreferencedNodesState.forEach((i,s)=>{if(i.state!==O)return;const n=this.runtime.getNodeType(s);if(n!==S.DataStore&&n!==S.Blob)return;const r="Deleted-"+s;this.loggedUnreferencedEvents.has(r)||(this.loggedUnreferencedEvents.add(r),e.sendTelemetryEvent({eventName:"GCObjectDeleted",id:s,type:n,age:t-i.unreferencedTimestampMs,timeout:this.sweepTimeoutMs,completedGCRuns:this.completedRuns,lastSummaryTime:this.getLastSummaryTimestampMs()}))})}inactiveNodeUsed(e,t,i,s,n,r=this.runtime.getCurrentReferenceTimestampMs(),a){if(void 0===r||i.state===y)return;if(!this.isSummarizerClient&&"Loaded"!==e)return;const o=this.runtime.getNodeType(t);if(o!==S.DataStore&&o!==S.Blob)return;const c=i.state,l=`${c}-${t}-${e}`;if(this.loggedUnreferencedEvents.has(l))return;this.loggedUnreferencedEvents.add(l);const h={id:t,type:o,unrefTime:i.unreferencedTimestampMs,age:r-i.unreferencedTimestampMs,timeout:i.state===C?this.inactiveTimeoutMs:this.sweepTimeoutMs,completedGCRuns:this.completedRuns,lastSummaryTime:this.getLastSummaryTimestampMs(),externalRequest:null==a?void 0:a[g.a.externalRequest],viaHandle:null==a?void 0:a[g.a.viaHandle],fromId:s};this.isSummarizerClient?this.pendingEventsQueue.push(Object.assign(Object.assign({},h),{usageType:e,state:c})):this.mc.logger.sendErrorEvent(Object.assign(Object.assign({},h),{eventName:`${c}Object_${e}`,pkg:n?{value:n.join("/"),tag:m.d.CodeArtifact}:void 0}))}async logUnreferencedEvents(e){for(const t of this.pendingEventsQueue){const{usageType:i,state:s}=t,n=b(t,["usageType","state"]),r=this.unreferencedNodesState.get(t.id);if("Revived"===i===(void 0===r||r.state===y)){const r=await this.getNodePackagePath(t.id),a=t.fromId?await this.getNodePackagePath(t.fromId):void 0;e.sendErrorEvent(Object.assign(Object.assign({},n),{eventName:`${s}Object_${i}`,pkg:r?{value:r.join("/"),tag:m.d.CodeArtifact}:void 0,fromPkg:a?{value:a.join("/"),tag:m.d.CodeArtifact}:void 0}))}}this.pendingEventsQueue=[]}}async function k(e,t){let i={gcNodes:{}};for(const s of Object.keys(e.blobs)){if(!s.startsWith("__gc"))continue;const n=e.blobs[s];if(void 0===n)continue;const a=await t(n);Object(r.a)(void 0!==a,685),i=Object(c.d)(i,a)}return i}function N(e){const t=Object.entries(e.gcNodes);t.sort(([e],[t])=>e.localeCompare(t));const i={gcNodes:{}};for(const[s,n]of t)n.outboundRoutes.sort(),i.gcNodes[s]=n;return i}function q(e,t,i){let s;if(e>2147483647){const n=e-2147483647;s=setTimeout(()=>q(n,t,i),2147483647)}else s=setTimeout(()=>t(),e);i(s)}},28857:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return a}));var s=i(28824),n=i(28858);class r{constructor(e,t,i=(()=>Date.now())){this.defaultTimeout=e,this.defaultHandler=t,this.getCurrentTick=i}get hasTimer(){return!!this.runningState}start(e=this.defaultTimeout,t=this.defaultHandler){this.startCore(e,t,e)}clear(){this.runningState&&(clearTimeout(this.runningState.timeout),this.runningState=void 0)}restart(e,t){var i,s;if(this.runningState){const n=null!=e?e:this.runningState.intendedDuration,r=null!==(s=null!=t?t:null===(i=this.runningState.restart)||void 0===i?void 0:i.handler)&&void 0!==s?s:this.runningState.handler,a=this.calculateRemainingTime(this.runningState);n<a?this.start(n,r):n===a?(this.runningState.handler=r,this.runningState.restart=void 0,this.runningState.intendedDuration=n):this.runningState.restart={startTick:this.getCurrentTick(),duration:n,handler:r}}else this.start(e,t)}startCore(e,t,i){this.clear(),this.runningState={startTick:this.getCurrentTick(),duration:e,intendedDuration:i,handler:t,timeout:setTimeout(()=>this.handler(),e)}}handler(){Object(s.a)(!!this.runningState,10);const e=this.runningState.restart;if(void 0!==e){const t=this.calculateRemainingTime(e);this.startCore(t,()=>e.handler(),e.duration)}else{const e=this.runningState.handler;this.clear(),e()}}calculateRemainingTime(e){const t=this.getCurrentTick()-e.startTick;return e.duration-t}}class a{constructor(e,t){this.timer=new r(e,()=>this.wrapHandler(t))}get hasTimer(){return this.timer.hasTimer}async start(e,t){return this.clear(),this.deferred=new n.a,this.timer.start(e,t?()=>this.wrapHandler(t):void 0),this.deferred.promise}clear(){this.timer.clear(),this.deferred&&(this.deferred.resolve({timerResult:"cancel"}),this.deferred=void 0)}wrapHandler(e){e(),Object(s.a)(!!this.deferred,11),this.deferred.resolve({timerResult:"timeout"}),this.deferred=void 0}}},28858:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));class s{constructor(){this.completed=!1,this.p=new Promise((e,t)=>{this.res=e,this.rej=t})}get isCompleted(){return this.completed}get promise(){return this.p}resolve(e){void 0!==this.res&&(this.completed=!0,this.res(e))}reject(e){void 0!==this.rej&&(this.completed=!0,this.rej(e))}}class n{constructor(e){this.execute=e}get[Symbol.toStringTag](){return this.getPromise()[Symbol.toStringTag]}async then(e,t){return this.getPromise().then(...arguments)}async catch(e){return this.getPromise().catch(...arguments)}async finally(e){return this.getPromise().finally(...arguments)}async getPromise(){return void 0===this.result&&(this.result=this.execute()),this.result}}},28859:function(e,t,i){"use strict";i.d(t,"g",(function(){return c})),i.d(t,"j",(function(){return l})),i.d(t,"f",(function(){return h})),i.d(t,"a",(function(){return u})),i.d(t,"k",(function(){return d})),i.d(t,"c",(function(){return m})),i.d(t,"e",(function(){return g})),i.d(t,"b",(function(){return p})),i.d(t,"m",(function(){return f})),i.d(t,"i",(function(){return b})),i.d(t,"l",(function(){return v})),i.d(t,"d",(function(){return S})),i.d(t,"n",(function(){return y})),i.d(t,"h",(function(){return C}));var s=i(28824),n=i(28861),r=i(28860),a=i(28842),o=i(28856);function c(e){return e.summaryFormatVersion?e.summaryFormatVersion:"0.1"===e.snapshotFormatVersion?1:0}function l(e){return!!e.summaryFormatVersion&&!e.disableIsolatedChannels}const h=e=>void 0===e?void 0:{clientId:e.clientId,clientSequenceNumber:e.clientSequenceNumber,minimumSequenceNumber:e.minimumSequenceNumber,referenceSequenceNumber:e.referenceSequenceNumber,sequenceNumber:e.sequenceNumber,timestamp:e.timestamp,type:e.type};const u=".aliases",d=".metadata",m=".chunks",g=".electedSummarizer",p=".blobs";function f(e){return!!e&&!e.disableIsolatedChannels}function b(e){var t;return e&&null!==(t=e.gcFeature)&&void 0!==t?t:0}const v=[".protocol",".logTail",".serviceProtocol",p,o.c],S=".component";function y(e){e.summary={type:r.a.Tree,tree:{[a.channelsTreeName]:e.summary}},e.stats.treeNodeCount++}async function C(e,t){const i=await Object(n.a)(e,t.blobs[S]),r=c(i);return Object(s.a)(r>0,469),i}},28860:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),function(e){e.Tree=1,e.Blob=2,e.Handle=3,e.Attachment=4}(s||(s={}))},28861:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28862);async function n(e,t){const i=await e.readBlob(t),n=Object(s.c)(i,"utf8");return JSON.parse(n)}},28862:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"d",(function(){return a})),i.d(t,"c",(function(){return o})),i.d(t,"a",(function(){return l}));var s=i(12665),n=i(28824);function r(e,t){switch(t){case"base64":return s.fromByteArray(e);case"utf8":case"utf-8":case void 0:return(new TextDecoder).decode(e);default:throw new Error("invalid/unsupported encoding")}}const a=(e,t)=>l.from(e,t).buffer,o=(e,t)=>l.from(e).toString(t);function c(e){const t=e;return e instanceof ArrayBuffer||"object"==typeof t&&null!==t&&"number"==typeof t.byteLength&&"function"==typeof t.slice&&void 0===t.byteOffset&&void 0===t.buffer}class l extends Uint8Array{toString(e){return r(this,e)}static from(e,t,i){if("string"==typeof e)return l.fromString(e,t);if(null!==e&&"object"==typeof e&&c(e.buffer))return Object(n.a)(0===e.byteOffset,0),Object(n.a)(e.byteLength===e.buffer.byteLength,1),l.fromArrayBuffer(e.buffer,t,i);if(c(e))return l.fromArrayBuffer(e,t,i);throw new TypeError}static fromArrayBuffer(e,t,i){const s=null!=t?t:0,n=null!=i?i:e.byteLength-s;if(s<0||s>e.byteLength||n<0||n+s>e.byteLength)throw new RangeError;return new l(e,s,n)}static fromString(e,t){switch(t){case"base64":{const t=this.sanitizeBase64(e),i=s.toByteArray(t);return new l(i.buffer)}case"utf8":case"utf-8":case void 0:{const t=(new TextEncoder).encode(e);return new l(t.buffer)}default:throw new Error("invalid/unsupported encoding")}}static isBuffer(e){throw new Error("unimplemented")}static sanitizeBase64(e){let t=e;if(t=t.split("=")[0],t=t.replace(/[^\w+-/]/g,""),t.length%4!=0){t+=["","===","==","="][t.length%4]}return t}}},28863:function(e,t,i){"use strict";i.d(t,"a",(function(){return w})),i.d(t,"b",(function(){return T}));var s=i(28836),n=i(28826),r=i(28842),a=i(28876),o=i(28870),c=i(28828),l=i(28829),h=i(28838),u=i(28872),d=i(28873),m=i(28832),g=i(28858),p=i(28824),f=i(27455),b=i(28877),v=i(28864),S=i(28865),y=i(28859),C=i(28875),O=i(28856);class w{constructor(e,t,i,s,a,o,u,d,p,f,b=new v.a(o)){this.baseSnapshot=e,this.runtime=t,this.submitAttachFn=i,this.getCreateChildSummarizerNodeFn=s,this.deleteChildSummarizerNodeFn=a,this.gcNodeUpdated=d,this.aliasMap=p,this.writeGCDataAtRoot=f,this.contexts=b,this.pendingAttach=new Map,this.attachOpFiredForDataStore=new Set,this.disposeOnce=new m.a(()=>this.contexts.dispose()),this.dataStoresSinceLastGC=[],this.dispose=()=>this.disposeOnce.value,this.logger=c.a.create(o),this.containerRuntimeHandle=new n.a(this.runtime,"/",this.runtime.IFluidHandleContext);const y=new g.b(async()=>u()),C=async e=>(await y).get(e),O=new Map;if(e)for(const[n,r]of Object.entries(e.trees))O.set(n,r);let w=0;for(const[n,c]of O){let e;if(c.unreferenced&&w++,this.runtime.attachState!==h.a.Detached)e=new S.c({id:n,snapshotTree:c,getBaseGCDetails:async()=>C(n),runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(n,{type:r.CreateSummarizerNodeSource.FromSummary}),writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels});else{if("object"!=typeof c)throw new l.a("Snapshot should be there to load from!!");const t=c;e=new S.b({id:n,pkg:void 0,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(n,{type:r.CreateSummarizerNodeSource.FromSummary}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(n),snapshotTree:t,isRootDataStore:void 0,writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels})}this.contexts.addBoundOrRemoted(e)}this.containerLoadStats={containerLoadDataStoreCount:O.size,referencedDataStoreCount:O.size-w}}aliases(){return this.aliasMap}processAttachMessage(e,t){var i,n;const a=e.contents;if(this.dataStoresSinceLastGC.push(a.id),t)return Object(p.a)(this.pendingAttach.has(a.id),350),null===(i=this.contexts.get(a.id))||void 0===i||i.emit("attached"),void this.pendingAttach.delete(a.id);if(this.alreadyProcessed(a.id)){throw new s.b("Duplicate DataStore created with existing id",Object.assign(Object.assign({},Object(s.f)(e)),{dataStoreId:{value:a.id,tag:c.d.PackageData}}))}const o=new Map;let l;a.snapshot&&(l=Object(u.a)(a.snapshot.entries,o));const h=[a.type],m=new S.c({id:a.id,snapshotTree:l,getBaseGCDetails:async()=>({}),runtime:this.runtime,storage:new d.a(this.runtime.storage,o),scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(a.id,{type:r.CreateSummarizerNodeSource.FromAttach,sequenceNumber:e.sequenceNumber,snapshot:null!==(n=a.snapshot)&&void 0!==n?n:{entries:[Object(S.d)(h,!0,this.runtime.disableIsolatedChannels)]}}),writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels,pkg:h});this.contexts.addBoundOrRemoted(m)}processAliasMessage(e,t,i){const n=e.contents;if(!Object(C.b)(n))throw new s.b("malformedDataStoreAliasMessage",Object.assign({},Object(s.f)(e)));const r=t,a=this.processAliasMessageCore(n);i&&r(a)}processAliasMessageCore(e){if(this.alreadyProcessed(e.alias))return!1;const t=this.contexts.get(e.internalId);if(void 0===t)return this.logger.sendErrorEvent({eventName:"AliasFluidDataStoreNotFound",fluidDataStoreId:e.internalId}),!1;const i=new n.a(t,e.internalId,this.runtime.IFluidHandleContext);return this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,i),this.aliasMap.set(e.alias,t.id),t.setInMemoryRoot(),!0}alreadyProcessed(e){return void 0!==this.aliasMap.get(e)||void 0!==this.contexts.get(e)}makeDataStoreLocallyVisible(e){const t=this.contexts.getUnbound(e);if(Object(p.a)(!!t,351),this.runtime.attachState!==h.a.Detached){t.emit("attaching");const i=t.generateAttachMessage();this.pendingAttach.set(e,i),this.submitAttachFn(i),this.attachOpFiredForDataStore.add(e)}this.contexts.bind(e)}createDetachedDataStoreCore(e,t,i=Object(f.a)()){Object(p.a)(!i.includes("/"),780);const s=new S.a({id:i,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(i,{type:r.CreateSummarizerNodeSource.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(i),snapshotTree:void 0,isRootDataStore:t,writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels});return this.contexts.addUnbound(s),s}_createFluidDataStoreContext(e,t,i,s){Object(p.a)(!t.includes("/"),781);const n=new S.b({id:t,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(t,{type:r.CreateSummarizerNodeSource.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(t),snapshotTree:void 0,isRootDataStore:i,writeGCDataAtRoot:this.writeGCDataAtRoot,disableIsolatedChannels:this.runtime.disableIsolatedChannels,createProps:s});return this.contexts.addUnbound(n),n}get disposed(){return this.disposeOnce.evaluated}resubmitDataStoreOp(e,t){const i=e,s=this.contexts.get(i.address);Object(p.a)(!!s,352),s.reSubmit(i.contents,t)}rollbackDataStoreOp(e,t){const i=e,s=this.contexts.get(i.address);Object(p.a)(!!s,744),s.rollback(i.contents,t)}async applyStashedOp(e){const t=e,i=this.contexts.get(t.address);return Object(p.a)(!!i,353),i.applyStashedOp(t.contents)}async applyStashedAttachOp(e){this.pendingAttach.set(e.id,e),this.processAttachMessage({contents:e},!1)}processFluidDataStoreOp(e,t,i){const s=e.contents,n=Object.assign(Object.assign({},e),{contents:s.contents}),r=this.contexts.get(s.address);Object(p.a)(!!r,354),r.process(n,t,i),this.gcNodeUpdated("/"+s.address,e.timestamp,r.isLoaded?r.packagePath:void 0)}async getDataStore(e,t){const i=await this.contexts.getBoundOrRemoted(e,t);if(void 0===i){const t={url:e};throw Object(a.d)(Object(a.a)(t),t)}return i}processSignal(e,t,i){const s=this.contexts.get(e);if(!s)return Object(p.a)(!i,355),void this.logger.sendTelemetryEvent({eventName:"SignalFluidDataStoreNotFound",fluidDataStoreId:{value:e,tag:c.d.PackageData}});s.processSignal(t,i)}setConnectionState(e,t){for(const[s,n]of this.contexts)try{n.setConnectionState(e,t)}catch(i){this.logger.sendErrorEvent({eventName:"SetConnectionStateError",clientId:t,fluidDataStore:s},i)}}setAttachState(e){let t;t=e===h.a.Attaching?"attaching":"attached";for(const[,i]of this.contexts)this.contexts.isNotBound(i.id)||i.emit(t)}get size(){return this.contexts.size}async summarize(e,t,i){const s=new o.a;return await Promise.all(Array.from(this.contexts).filter(([e,t])=>(Object(p.a)(t.attachState!==h.a.Attaching,357),t.attachState===h.a.Attached)).map(async([n,r])=>{const a=await r.summarize(e,t,i);s.addWithStats(n,a)})),s.getSummaryTree()}createSummary(e){const t=new o.a;let i;do{const e=t.summary.tree;i=this.contexts.notBoundLength(),Array.from(this.contexts).filter(([t,i])=>!(this.contexts.isNotBound(t)||e[t]||this.attachOpFiredForDataStore.has(t))).map(([e,i])=>{let s;if(i.isLoaded){const e=i.generateAttachMessage().snapshot;s=Object(o.i)(e,!0)}else Object(p.a)(!!this.baseSnapshot,358),s=Object(o.g)(this.baseSnapshot.trees[e]);t.addWithStats(e,s)})}while(i!==this.contexts.notBoundLength());return t.getSummaryTree()}async updateStateBeforeGC(){for(const e of this.dataStoresSinceLastGC){const t=this.contexts.get(e);if(Object(p.a)(void 0!==t,694),await t.isRoot()){const i=new n.a(t,e,this.runtime.IFluidHandleContext);this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,i)}}this.dataStoresSinceLastGC=[]}async getGCData(e=!1){const t=new b.a;return await Promise.all(Array.from(this.contexts).filter(([e,t])=>t.attachState===h.a.Attached).map(async([i,s])=>{const n=await s.getGCData(e);t.prefixAndAddNodes(i,n.gcNodes)})),t.addNode("/",await this.getOutboundRoutes()),t.getGCData()}updateUsedRoutes(e,t){var i;const s=Object(b.g)(e);for(const[n]of s)Object(p.a)(this.contexts.has(n),359);for(const[n,r]of this.contexts)r.updateUsedRoutes(null!==(i=s.get(n))&&void 0!==i?i:[],t)}deleteUnusedRoutes(e){for(const t of e){const e=t.split("/");if(e.length>2)continue;const i=e[1];Object(p.a)(this.contexts.has(i),727),this.contexts.delete(i),this.deleteChildSummarizerNodeFn(i)}}async getOutboundRoutes(){const e=[];for(const[t,i]of this.contexts){await i.isRoot()&&e.push("/"+t)}return e}async getDataStorePackagePath(e){var t;const i=this.contexts.get(e.split("/")[1]);return null===(t=await(null==i?void 0:i.getInitialSnapshotDetails()))||void 0===t?void 0:t.pkg}getGCNodeType(e){const t=e.split("/");if(this.contexts.has(t[1]))return 2===t.length?O.a.DataStore:O.a.SubDataStore}}function T(e,t){if(e){if(Object(y.m)(t)){const t=e.trees[r.channelsTreeName];return Object(p.a)(!!t,360),t}{const t={};for(const[i,s]of Object.entries(e.trees))y.l.includes(i)||(t[i]=s);return Object.assign(Object.assign({},e),{trees:t})}}}},28864:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var s=i(28832),n=i(28824),r=i(28858),a=i(28828);class o{constructor(e){this.notBoundContexts=new Set,this._contexts=new Map,this.deferredContexts=new Map,this.disposeOnce=new s.a(()=>{for(const[e,t]of this.deferredContexts)t.promise.then(e=>{e.dispose()}).catch(t=>{this._logger.sendErrorEvent({eventName:"FluidDataStoreContextDisposeError",fluidDataStoreId:e},t)})}),this.dispose=()=>this.disposeOnce.value,this._logger=a.a.create(e)}[Symbol.iterator](){return this._contexts.entries()}get size(){return this._contexts.size}get disposed(){return this.disposeOnce.evaluated}notBoundLength(){return this.notBoundContexts.size}isNotBound(e){return this.notBoundContexts.has(e)}has(e){return this._contexts.has(e)}get(e){return this._contexts.get(e)}delete(e){return this.deferredContexts.delete(e),this.notBoundContexts.delete(e),this._contexts.delete(e)}getUnbound(e){if(void 0!==this._contexts.get(e)&&this.notBoundContexts.has(e))return this._contexts.get(e)}addUnbound(e){const t=e.id;Object(n.a)(!this._contexts.has(t),344),this._contexts.set(t,e),this.notBoundContexts.add(t),this.ensureDeferred(t)}async getBoundOrRemoted(e,t){const i=this.ensureDeferred(e);if(t||i.isCompleted)return i.promise}ensureDeferred(e){const t=this.deferredContexts.get(e);if(t)return t;const i=new r.a;return this.deferredContexts.set(e,i),i}bind(e){const t=this.notBoundContexts.delete(e);Object(n.a)(t,345),this.resolveDeferred(e)}resolveDeferred(e){const t=this._contexts.get(e);Object(n.a)(!!t,346),Object(n.a)(!this.notBoundContexts.has(e),347);const i=this.deferredContexts.get(e);Object(n.a)(!!i,348),i.resolve(t)}addBoundOrRemoted(e){const t=e.id;Object(n.a)(!this._contexts.has(t),349),this._contexts.set(t,e),this.ensureDeferred(t),this.resolveDeferred(t)}}},28865:function(e,t,i){"use strict";i.d(t,"d",(function(){return b})),i.d(t,"c",(function(){return S})),i.d(t,"b",(function(){return C})),i.d(t,"a",(function(){return O}));var s=i(28838),n=i(28823),r=i(28824),a=i(28858),o=i(28861),c=i(28866),l=i(28842),h=i(28870),u=i(28828),d=i(28869),m=i(28829),g=i(28836),p=i(28859);function f(e,t,i){const s=JSON.stringify(e);return i?{pkg:s,snapshotFormatVersion:"0.1",isRootDataStore:t}:{pkg:s,summaryFormatVersion:2,isRootDataStore:t}}function b(e,t,i){const s=f(e,t,i);return new c.b(p.d,JSON.stringify(s))}class v extends n.a{constructor(e,t,i,n,a){super(),this.existing=t,this.bindState=i,this.isLocalDataStore=n,this.makeLocallyVisibleFn=a,this._disposed=!1,this.detachedRuntimeCreation=!1,this.loaded=!1,this.pending=[],this._isInMemoryRoot=!1,this._containerRuntime=e.runtime,this.id=e.id,this.storage=e.storage,this.scope=e.scope,this.writeGCDataAtRoot=e.writeGCDataAtRoot,this.disableIsolatedChannels=e.disableIsolatedChannels,this.pkg=e.pkg,Object(r.a)(!this.id.includes("/"),314),this._attachState=this.containerRuntime.attachState!==s.a.Detached&&this.existing?this.containerRuntime.attachState:s.a.Detached,this.bindToContext=()=>{Object(r.a)(this.bindState===s.b.NotBound,315),this.bindState=s.b.Binding,Object(r.a)(void 0!==this.channel,316),this.makeLocallyVisible(),this.bindState=s.b.Bound};this.summarizerNode=e.createSummarizerNodeFn(async(e,t,i)=>this.summarizeInternal(e,t,i),async e=>this.getGCDataInternal(e),async()=>this.getBaseGCDetails()),this.subLogger=u.a.create(this.logger,"FluidDataStoreContext"),this.thresholdOpsCounter=new d.a(v.pendingOpsCountThreshold,this.subLogger)}get packagePath(){return Object(r.a)(void 0!==this.pkg,313),this.pkg}get options(){return this._containerRuntime.options}get clientId(){return this._containerRuntime.clientId}get clientDetails(){return this._containerRuntime.clientDetails}get logger(){return this._containerRuntime.logger}get deltaManager(){return this._containerRuntime.deltaManager}get connected(){return this._containerRuntime.connected}get IFluidHandleContext(){return this._containerRuntime.IFluidHandleContext}get containerRuntime(){return this._containerRuntime}get isLoaded(){return this.loaded}get baseSnapshot(){return this._baseSnapshot}get disposed(){return this._disposed}get attachState(){return this._attachState}get IFluidDataStoreRegistry(){return this.registry}async isRoot(){return this.isInMemoryRoot()||(await this.getInitialSnapshotDetails()).isRootDataStore}isInMemoryRoot(){return this._isInMemoryRoot}dispose(){this._disposed||(this._disposed=!0,this.channelDeferred&&this.channelDeferred.promise.then(e=>{e.dispose()}).catch(e=>{}))}rejectDeferredRealize(e,t){throw new m.a(e,{packageName:{value:t,tag:u.d.PackageData}})}async realize(){return Object(r.a)(!this.detachedRuntimeCreation,317),this.channelDeferred||(this.channelDeferred=new a.a,this.realizeCore(this.existing).catch(e=>{var t;const i=g.c.wrapIfUnrecognized(e,"realizeFluidDataStoreContext");i.addTelemetryProperties({fluidDataStoreId:{value:this.id,tag:"PackageData"}}),null===(t=this.channelDeferred)||void 0===t||t.reject(i),this.logger.sendErrorEvent({eventName:"RealizeError"},i)})),this.channelDeferred.promise}async factoryFromPackagePath(e){let t;Object(r.a)(this.pkg===e,318),void 0===e&&this.rejectDeferredRealize("packages is undefined");let i,s=this._containerRuntime.IFluidDataStoreRegistry;for(const r of e)s||this.rejectDeferredRealize("No registry for package",i),i=r,t=await s.get(r),t||this.rejectDeferredRealize("Registry does not contain entry for the package",r),s=t.IFluidDataStoreRegistry;const n=null==t?void 0:t.IFluidDataStoreFactory;return void 0===n&&this.rejectDeferredRealize("Can't find factory for package",i),{factory:n,registry:s}}async realizeCore(e){const t=await this.getInitialSnapshotDetails();this._baseSnapshot=t.snapshot;const i=t.pkg,{factory:s,registry:n}=await this.factoryFromPackagePath(i);Object(r.a)(void 0===this.registry,319),this.registry=n;const a=await s.instantiateDataStore(this,e);Object(r.a)(void 0!==a,320),this.bindRuntime(a)}setConnectionState(e,t){this.verifyNotClosed(),this.loaded&&(Object(r.a)(this.connected===e,321),this.channel.setConnectionState(e,t))}process(e,t,i){var s;this.verifyNotClosed();const n=e.contents,a=Object.assign(Object.assign({},e),{type:n.type,contents:n.content});if(this.summarizerNode.recordChange(a),this.loaded)return null===(s=this.channel)||void 0===s?void 0:s.process(a,t,i);Object(r.a)(!t,322),Object(r.a)(void 0!==this.pending,573),this.pending.push(a),this.thresholdOpsCounter.sendIfMultiple("StorePendingOps",this.pending.length)}processSignal(e,t){var i;this.verifyNotClosed(),this.loaded&&(null===(i=this.channel)||void 0===i||i.processSignal(e,t))}getQuorum(){return this._containerRuntime.getQuorum()}getAudience(){return this._containerRuntime.getAudience()}async summarize(e=!1,t=!0,i){return this.summarizerNode.summarize(e,t,i)}async summarizeInternal(e,t,i){await this.realize();const s=await this.channel.summarize(e,t,i);let n;this.disableIsolatedChannels||(Object(p.n)(s),n=[l.channelsTreeName]);const{pkg:r}=await this.getInitialSnapshotDetails(),a=f(r,await this.isRoot(),this.disableIsolatedChannels);return Object(h.c)(s,p.d,JSON.stringify(a)),this.writeGCDataAtRoot||Object(h.c)(s,l.gcBlobKey,JSON.stringify(this.summarizerNode.getGCSummaryDetails())),this.summarizerNode.isReferenced()||(s.summary.unreferenced=!0,s.stats.unreferencedBlobSize=s.stats.totalBlobSize),Object.assign(Object.assign({},s),{id:this.id,pathPartsForChildren:n})}async getGCData(e=!1){return this.summarizerNode.getGCData(e)}async getGCDataInternal(e=!1){return await this.realize(),Object(r.a)(void 0!==this.channel,323),this.channel.getGCData(e)}updateUsedRoutes(e,t){this.summarizerNode.updateUsedRoutes(e,t),this.lastUsedState={usedRoutes:e,gcTimestamp:t},this.loaded&&this.updateChannelUsedRoutes()}addedGCOutboundReference(e,t){this._containerRuntime.addedGCOutboundReference(e,t)}updateChannelUsedRoutes(){if(Object(r.a)(this.loaded,324),Object(r.a)(void 0!==this.channel,325),void 0===this.lastUsedState)return;const e=this.lastUsedState.usedRoutes.filter(e=>"/"!==e&&""!==e);this.channel.updateUsedRoutes(e,this.lastUsedState.gcTimestamp)}async request(e){return(await this.realize()).request(e)}submitMessage(e,t,i){this.verifyNotClosed(),Object(r.a)(!!this.channel,326);const s={content:t,type:e};this._containerRuntime.submitDataStoreOp(this.id,s,i)}setChannelDirty(e){this.verifyNotClosed();const t=this.deltaManager.lastSequenceNumber;this.summarizerNode.invalidate(t);const i=this.summarizerNode.getChild(e);i&&i.invalidate(t)}submitSignal(e,t){return this.verifyNotClosed(),Object(r.a)(!!this.channel,327),this._containerRuntime.submitDataStoreSignal(this.id,e,t)}makeLocallyVisible(){Object(r.a)(void 0!==this.channel,719),this.makeLocallyVisibleFn()}bindRuntime(e){var t;if(this.channel)throw new Error("Runtime already bound");try{Object(r.a)(!this.detachedRuntimeCreation,328),Object(r.a)(void 0!==this.channelDeferred,329),Object(r.a)(void 0!==this.pkg,330);const t=this.pending;for(const i of t)e.process(i,!1,void 0);this.thresholdOpsCounter.send("ProcessPendingOps",t.length),this.pending=void 0,this.loaded=!0,this.channel=e,Object.freeze(this.pkg),this.updateChannelUsedRoutes(),this.channelDeferred.resolve(this.channel)}catch(i){null===(t=this.channelDeferred)||void 0===t||t.reject(i),this.logger.sendErrorEvent({eventName:"BindRuntimeError",fluidDataStoreId:{value:this.id,tag:"PackageData"}},i)}}async getAbsoluteUrl(e){if(this.attachState===s.a.Attached)return this._containerRuntime.getAbsoluteUrl(e)}setInMemoryRoot(){this._isInMemoryRoot=!0}reSubmit(e,t){Object(r.a)(!!this.channel,331);const i=e;this.channel.reSubmit(i.type,i.content,t)}rollback(e,t){if(!this.channel)throw new Error("Channel must exist when rolling back ops");if(!this.channel.rollback)throw new Error("Channel doesn't support rollback");const i=e;this.channel.rollback(i.type,i.content,t)}async applyStashedOp(e){this.channel||await this.realize(),Object(r.a)(!!this.channel,332);const t=e;return this.channel.applyStashedOp(t.content)}verifyNotClosed(){if(this._disposed)throw new Error("Context is closed")}getCreateChildSummarizerNodeFn(e,t){return(i,s,n)=>this.summarizerNode.createChild(i,e,t,{throwOnFailure:!0},s,n)}async uploadBlob(e){return this.containerRuntime.uploadBlob(e)}}v.pendingOpsCountThreshold=1e3;class S extends v{constructor(e){super(e,!0,s.b.Bound,!1,()=>{throw new Error("Already attached")}),this.initialSnapshotDetailsP=new a.b(async()=>{var e,t;let i,s=!0;if("string"==typeof this.initSnapshotValue){const t=(await this.storage.getVersions(this.initSnapshotValue,1))[0];i=null!==(e=await this.storage.getSnapshotTree(t))&&void 0!==e?e:void 0}else i=this.initSnapshotValue;const n=async e=>Object(o.a)(this.storage,e);if(i){const e=await this.summarizerNode.loadBaseSummary(i,n);i=e.baseSummary,this.pending=e.outstandingOps.concat(this.pending)}if(i&&void 0!==i.blobs[p.d]){const e=await n(i.blobs[p.d]);let a;a=Object(p.g)(e)<1?e.pkg.startsWith('["')&&e.pkg.endsWith('"]')?JSON.parse(e.pkg):[e.pkg]:JSON.parse(e.pkg),this.pkg=a,s=null===(t=e.isRootDataStore)||void 0===t||t,Object(p.j)(e)&&(i=i.trees[l.channelsTreeName],Object(r.a)(void 0!==i,510))}return{pkg:this.pkg,isRootDataStore:s,snapshot:i}}),this.initSnapshotValue=e.snapshotTree,this.baseGCDetailsP=new a.b(async()=>{var t;return null!==(t=await e.getBaseGCDetails())&&void 0!==t?t:{}})}async getInitialSnapshotDetails(){return this.initialSnapshotDetailsP}async getInitialGCSummaryDetails(){return this.getBaseGCDetails()}async getBaseGCDetails(){return this.baseGCDetailsP}generateAttachMessage(){throw new Error("Cannot attach remote store")}}class y extends v{constructor(e){super(e,void 0!==e.snapshotTree,e.snapshotTree?s.b.Bound:s.b.NotBound,!0,e.makeLocallyVisibleFn),this.snapshotTree=e.snapshotTree,!0===e.isRootDataStore&&this.setInMemoryRoot(),this.createProps=e.createProps,this.attachListeners()}attachListeners(){this.once("attaching",()=>{Object(r.a)(this.attachState===s.a.Detached,333),this._attachState=s.a.Attaching}),this.once("attached",()=>{Object(r.a)(this.attachState===s.a.Attaching,334),this._attachState=s.a.Attached})}generateAttachMessage(){Object(r.a)(void 0!==this.channel,335),Object(r.a)(void 0!==this.pkg,336);const e=this.channel.getAttachSummary();this.disableIsolatedChannels||Object(p.n)(e);const t=f(this.pkg,this.isInMemoryRoot(),this.disableIsolatedChannels);Object(h.c)(e,p.d,JSON.stringify(t));const i=Object(h.h)(e.summary);return{id:this.id,snapshot:i,type:this.pkg[this.pkg.length-1]}}async getInitialSnapshotDetails(){var e;let t,i=this.snapshotTree,s=!1;return void 0!==i&&(t=await Object(p.h)(this.storage,i),Object(p.j)(t)&&(i=i.trees[l.channelsTreeName],Object(r.a)(void 0!==i,511)),void 0===this.pkg&&(this.pkg=JSON.parse(t.pkg),(null===(e=t.isRootDataStore)||void 0===e||e)&&(s=!0,this.setInMemoryRoot()))),Object(r.a)(void 0!==this.pkg,338),{pkg:this.pkg,isRootDataStore:s,snapshot:i}}async getInitialGCSummaryDetails(){return{}}async getBaseGCDetails(){return{}}}class C extends y{constructor(e){super(e)}}class O extends y{constructor(e){super(e),this.detachedRuntimeCreation=!0}async attachRuntime(e,t){Object(r.a)(this.detachedRuntimeCreation,340),Object(r.a)(void 0===this.channelDeferred,341);const i=e.IFluidDataStoreFactory,s=await this.factoryFromPackagePath(this.pkg);Object(r.a)(s.factory===i,342),Object(r.a)(void 0===this.registry,343),this.registry=s.registry,this.detachedRuntimeCreation=!1,this.channelDeferred=new a.a,super.bindRuntime(t),await this.isRoot()&&(void 0!==t.makeVisibleAndAttachGraph?t.makeVisibleAndAttachGraph():t.bindToContext())}async getInitialSnapshotDetails(){if(this.detachedRuntimeCreation)throw new Error("Detached Fluid Data Store context can't be realized! Please attach runtime first!");return super.getInitialSnapshotDetails()}}},28866:function(e,t,i){"use strict";i.d(t,"d",(function(){return n})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return a})),i.d(t,"a",(function(){return o}));i(28860);var s=i(28867);i(28868);function n(e,t=new Map,i=!1){const s={},n={id:e.sha,blobs:{},trees:{}};s[""]=n;for(const r of e.tree){const e=i?r.path.replace(/^\.app\//,""):r.path,n=e.lastIndexOf("/"),a=e.slice(0,Math.max(0,n)),o=e.slice(n+1),c=s[a];if("tree"===r.type){const t={id:r.sha,blobs:{},commits:{},trees:{}};c.trees[decodeURIComponent(o)]=t,s[e]=t}else{if("blob"!==r.type)throw new Error("Unknown entry type!!");c.blobs[decodeURIComponent(o)]=r.sha,t.set(r.sha,"/"+e)}}return n}class r{constructor(e,t,i="utf-8"){this.path=e,this.mode=s.a.File,this.type=s.b.Blob,this.value={contents:t,encoding:i}}}class a{constructor(e,t){this.path=e,this.value=t,this.mode=s.a.Directory,this.type=s.b.Tree}}class o{constructor(e,t){this.path=e,this.id=t,this.mode=s.a.File,this.type=s.b.Attachment,this.value={id:t}}}},28867:function(e,t,i){"use strict";var s,n;i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n})),function(e){e.File="100644",e.Executable="100755",e.Directory="040000",e.Symlink="120000"}(s||(s={})),function(e){e.Blob="Blob",e.Tree="Tree",e.Attachment="Attachment"}(n||(n={}))},28868:function(e,t,i){"use strict";function s(e,t="Unreachable Case"){throw new Error(t)}i.d(t,"a",(function(){return s}))},28869:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(e,t,i=e){this.threshold=e,this.logger=t,this.thresholdMultiple=i}send(e,t){t<this.threshold||this.logger.sendPerformanceEvent({eventName:e,value:t})}sendIfMultiple(e,t){t===this.thresholdMultiple&&(this.logger.sendPerformanceEvent({eventName:e,value:t}),this.thresholdMultiple=2*this.thresholdMultiple)}}},28870:function(e,t,i){"use strict";i.d(t,"j",(function(){return l})),i.d(t,"f",(function(){return u})),i.d(t,"c",(function(){return d})),i.d(t,"e",(function(){return m})),i.d(t,"d",(function(){return g})),i.d(t,"a",(function(){return p})),i.d(t,"i",(function(){return f})),i.d(t,"g",(function(){return b})),i.d(t,"h",(function(){return v})),i.d(t,"b",(function(){return S}));var s=i(28862),n=i(28871),r=i(28868),a=i(28866),o=i(28860),c=i(28867);function l(...e){const t={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(const i of e)t.treeNodeCount+=i.treeNodeCount,t.blobNodeCount+=i.blobNodeCount,t.handleNodeCount+=i.handleNodeCount,t.totalBlobSize+=i.totalBlobSize,t.unreferencedBlobSize+=i.unreferencedBlobSize;return t}function h(e){return"string"==typeof e?function(e){let t=e.length;for(let i=e.length-1;i>=0;i--){const s=e.charCodeAt(i);s>127&&s<=2047?t++:s>2047&&s<=65535&&(t+=2),s>=56320&&s<=57343&&i--}return t}(e):e.byteLength}function u(e){const t=l();return function e(t,i){switch(t.type){case o.a.Tree:i.treeNodeCount++;for(const s of Object.values(t.tree))e(s,i);return;case o.a.Handle:return void i.handleNodeCount++;case o.a.Blob:return i.blobNodeCount++,void(i.totalBlobSize+=h(t.content));default:return}}(e,t),t}function d(e,t,i){const s={type:o.a.Blob,content:i};e.summary.tree[t]=s,e.stats.blobNodeCount++,e.stats.totalBlobSize+=h(i)}function m(e,t,i){e.summary.tree[t]=i.summary,e.stats=l(e.stats,i.stats)}function g(e,t,i){e.summary.tree[t]=i.summary,e.stats=l(e.stats,i.stats)}class p{constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=l(),this.summaryStats.treeNodeCount++}get summary(){return{type:o.a.Tree,tree:Object.assign({},this.summaryTree)}}get stats(){return Object.assign({},this.summaryStats)}addBlob(e,t){d({summary:{type:o.a.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,i){this.summaryTree[e]={type:o.a.Handle,handleType:t,handle:i},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=l(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:o.a.Attachment}}getSummaryTree(){return{summary:this.summary,stats:this.stats}}}function f(e,t=!1){if(e.id&&!t){const t=l();return t.handleNodeCount++,{summary:{handle:e.id,handleType:o.a.Tree,type:o.a.Handle},stats:t}}return function(e,t=!1){const i=new p;for(const r of e.entries)switch(r.type){case c.b.Blob:{const e=r.value;let t;t="base64"===e.encoding?s.a.from(e.contents,"base64"):e.contents,i.addBlob(r.path,t);break}case c.b.Tree:{const e=f(r.value,t);i.addWithStats(r.path,e);break}case c.b.Attachment:{const e=r.value.id;i.addAttachment(e);break}default:throw new Error("Unexpected TreeEntry type")}const n=i.getSummaryTree();return n.summary.unreferenced=e.unreferenced,n}(e,t)}function b(e){const t=new p;for(const[r,a]of Object.entries(e.blobs)){let i;if(void 0!==e.blobsContents){const t=e.blobsContents[a];void 0!==t&&(i=Object(s.c)(t,"utf-8"))}else void 0!==e.blobs[a]&&(i=Object(n.a)(e.blobs[a]));void 0!==i&&t.addBlob(r,i)}for(const[s,n]of Object.entries(e.trees)){const e=b(n);t.addWithStats(s,e)}const i=t.getSummaryTree();return i.summary.unreferenced=e.unreferenced,i}function v(e){const t=[];for(const[i,n]of Object.entries(e.tree))switch(n.type){case o.a.Blob:{let e,r="utf-8";"string"==typeof n.content?e=n.content:(e=Object(s.b)(n.content,"base64"),r="base64"),t.push(new a.b(i,e,r));break}case o.a.Tree:t.push(new a.c(i,v(n)));break;case o.a.Attachment:t.push(new a.a(i,n.id));break;case o.a.Handle:throw new Error("Should not have Handle type in summary tree");default:Object(r.a)(n,"Unexpected summary tree type")}return{entries:t,unreferenced:e.unreferenced}}class S{constructor(){this.telemetry=new Map}set(e,t,i){this.telemetry.set(`${e}${t}`,i)}get(e,t){return this.telemetry.get(`${e}${t}`)}serialize(){const e={};return this.telemetry.forEach((t,i)=>{e[i]=t}),JSON.stringify(e)}}},28871:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28862);const n=e=>s.a.from(e,"base64").toString("utf-8")},28872:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var s=i(28862),n=i(28824),r=i(28867),a=i(28866),o=i(27455);function c(e,t){return{sha:"",tree:function e(t,i,a){const c=[];for(const l of i){const i=`${t}${l.path}`;if(l.type===r.b.Blob){const e=l.value,t=Object(s.d)(e.contents,e.encoding),n=Object(o.a)();a.set(n,t);const h={mode:r.a[l.mode],path:i,sha:n,size:0,type:"blob",url:""};c.push(h)}else if(l.type===r.b.Tree){Object(n.a)(l.type===r.b.Tree,257);const t=l.value,s={mode:r.a[l.mode],path:i,sha:"",size:-1,type:"tree",url:""};c.push(s);const o=e(i+"/",t.entries,a);c.push(...o)}}return c}("",e,t),url:""}}function l(e,t){const i=c(e,t);return Object(a.d)(i)}},28873:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28874);class n extends s.a{constructor(e,t){super(e),this.blobs=t}get policies(){return this.internalStorageService.policies}async readBlob(e){const t=this.blobs.get(e);return void 0!==t?t:this.internalStorageService.readBlob(e)}}},28874:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(e){this.internalStorageService=e}set policies(e){this._policies=e}get policies(){var e;return null!==(e=this._policies)&&void 0!==e?e:this.internalStorageService.policies}get repositoryUrl(){return this.internalStorageService.repositoryUrl}async getSnapshotTree(e,t){return this.internalStorageService.getSnapshotTree(e,t)}async getVersions(e,t,i){return this.internalStorageService.getVersions(e,t,i)}async uploadSummaryWithContext(e,t){return this.internalStorageService.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this.internalStorageService.downloadSummary(e)}async createBlob(e){return this.internalStorageService.createBlob(e)}async readBlob(e){return this.internalStorageService.readBlob(e)}}},28875:function(e,t,i){"use strict";i.d(t,"b",(function(){return c})),i.d(t,"a",(function(){return l}));var s=i(28824),n=i(28868),r=i(28838),a=i(28836),o=i(28828);const c=e=>"string"==typeof(null==e?void 0:e.internalId)&&"string"==typeof(null==e?void 0:e.alias),l=(e,t,i,s,n)=>new u(e,t,i,s,n);var h;!function(e){e.Aliased="Aliased",e.Aliasing="Aliasing",e.None="None"}(h||(h={}));class u{constructor(e,t,i,s,n){this.fluidDataStoreChannel=e,this.internalId=t,this.runtime=i,this.datastores=s,this.logger=n,this.aliasState=h.None}async trySetAlias(e){if(e.includes("/"))throw new a.e(`The alias cannot contain slashes: '${e}'`);switch(this.aliasState){case h.Aliasing:return Object(s.a)(void 0!==this.aliasResult,790),await this.aliasResult,this.alias===e?"Success":"AlreadyAliased";case h.Aliased:return this.alias===e?"Success":"AlreadyAliased";case h.None:break;default:Object(n.a)(this.aliasState)}return this.aliasState=h.Aliasing,this.aliasResult=this.trySetAliasInternal(e),this.aliasResult}async trySetAliasInternal(e){const t={internalId:this.internalId,alias:e};if(void 0!==this.fluidDataStoreChannel.makeVisibleAndAttachGraph?this.fluidDataStoreChannel.makeVisibleAndAttachGraph():this.fluidDataStoreChannel.bindToContext(),this.runtime.attachState===r.a.Detached){const e=this.datastores.processAliasMessageCore(t);return this.aliasState=h.Aliased,e?"Success":"Conflict"}return await this.ackBasedPromise(e=>{this.runtime.submitDataStoreAliasOp(t,e)}).then(t=>(this.aliasState=h.Aliased,t&&(this.alias=e),t)).catch(t=>(this.logger.sendErrorEvent({eventName:"AliasingException",alias:{value:e,tag:o.d.UserData},internalId:{value:this.internalId,tag:o.d.PackageData}},t),this.aliasState=h.None,!1))?"Success":"Conflict"}async request(e){return this.fluidDataStoreChannel.request(e)}get IFluidRouter(){return this.fluidDataStoreChannel}async ackBasedPromise(e){let t;return new Promise((i,s)=>{t=()=>s(new Error("ContainerRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(i,s))}).finally(()=>{this.runtime.off("dispose",t)})}}},28876:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"d",(function(){return a})),i.d(t,"c",(function(){return o})),i.d(t,"a",(function(){return c}));var s=i(28824),n=i(28829);function r(e){if(null!==e&&"object"==typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack}}}const t=Object(n.c)();return{mimeType:"text/plain",status:500,value:""+e,get stack(){var i;return null!==(i=null==e?void 0:e.stack)&&void 0!==i?i:t.stack}}}function a(e,t){const i=e.value,s=Object(n.c)();return{errorFromRequestFluidObject:!0,message:i,name:"Error",code:e.status,get stack(){var t;return null!==(t=e.stack)&&void 0!==t?t:s.stack}}}async function o(e,t){const i="string"==typeof t?{url:t}:t,n=await e.request(i);if(200!==n.status||"fluid/object"!==n.mimeType)throw a(n);return Object(s.a)(n.value,410),n.value}const c=e=>function(e,t,i){var r;Object(s.a)(200!==e,411);const a=null===(r=i.url)||void 0===r?void 0:r.split("?")[0],o=Object(n.c)();return{mimeType:"text/plain",status:e,value:void 0===a?t:`${t}: ${a}`,get stack(){return o.stack}}}(404,"not found",e)},28877:function(e,t,i){"use strict";i.d(t,"e",(function(){return n})),i.d(t,"b",(function(){return a})),i.d(t,"f",(function(){return o})),i.d(t,"g",(function(){return c})),i.d(t,"d",(function(){return l})),i.d(t,"c",(function(){return h})),i.d(t,"a",(function(){return u}));var s=i(28824);function n(e){return e.replace(/^\/+|\/+$/g,"")}function r(e){return e.replace(/\/+$/g,"")}function a(e){const t={};for(const[i,s]of Object.entries(e.gcNodes))t[i]=Array.from(s);return{gcNodes:t}}function o(e){const t=new Map;if(void 0===e.gcData)return t;const i=e.gcData.gcNodes;delete i["/"];for(const[r,a]of Object.entries(i)){Object(s.a)(r.startsWith("/"),686);const e=r.split("/")[1];let i=r.slice(e.length+1);""===i&&(i="/");let n=t.get(e);void 0===n&&(n={gcData:{gcNodes:{}},usedRoutes:[]}),Object(s.a)(void 0!==n.gcData,687),n.gcData.gcNodes[i]=[...new Set(a)],t.set(e,n)}if(void 0===e.usedRoutes)return t;const n=e.usedRoutes.filter(e=>""!==e&&"/"!==e);for(const r of n){Object(s.a)(r.startsWith("/"),688);const e=r.split("/")[1],i=r.slice(e.length+1),n=t.get(e);Object(s.a)(void 0!==(null==n?void 0:n.usedRoutes),689),n.usedRoutes.push(i),t.set(e,n)}return t}function c(e){const t=e.filter(e=>""!==e&&"/"!==e),i=new Map;for(const n of t){Object(s.a)(n.startsWith("/"),408);const e=n.split("/")[1],t=n.slice(e.length+1),r=i.get(e);void 0!==r?r.push(t):i.set(e,[t])}return i}function l(e,t){var i;const n={};for(const[s,r]of Object.entries(e.gcNodes))n[s]={outboundRoutes:Array.from(r.outboundRoutes),unreferencedTimestampMs:r.unreferencedTimestampMs};for(const[r,a]of Object.entries(t.gcNodes)){let e=n[r];void 0===e?e={outboundRoutes:Array.from(a.outboundRoutes),unreferencedTimestampMs:a.unreferencedTimestampMs}:(void 0!==a.unreferencedTimestampMs&&void 0!==e.unreferencedTimestampMs&&Object(s.a)(a.unreferencedTimestampMs===e.unreferencedTimestampMs,690),e={outboundRoutes:[...new Set([...a.outboundRoutes,...e.outboundRoutes])],unreferencedTimestampMs:null!==(i=a.unreferencedTimestampMs)&&void 0!==i?i:e.unreferencedTimestampMs}),n[r]=e}return{gcNodes:n}}function h(e,t){const i=a(e);for(const[s,n]of Object.entries(t.gcNodes))if(void 0===i.gcNodes[s])i.gcNodes[s]=Array.from(n);else{const e=[...n,...i.gcNodes[s]];i.gcNodes[s]=[...new Set(e)]}return i}class u{constructor(){this.gcNodesSet={}}get gcNodes(){const e={};for(const[t,i]of Object.entries(this.gcNodesSet))e[t]=[...i];return e}addNode(e,t){this.gcNodesSet[e]=new Set(t)}prefixAndAddNodes(e,t){for(const[i,s]of Object.entries(t)){let t=i.replace(/^\/+/g,"");t=`/${e}/${t}`,t=r(t),this.gcNodesSet[t]=new Set(s)}}addNodes(e){for(const[t,i]of Object.entries(e))this.gcNodesSet[t]=new Set(i)}addRouteToAllNodes(e){for(const t of Object.values(this.gcNodesSet))t.add(e)}getGCData(){return{gcNodes:this.gcNodes}}}},28878:function(e,t,i){"use strict";function s(e,t){const i=new Set,s=[...t];for(const a of s){if(i.has(a))continue;i.add(a);const t=e[a];void 0!==t&&s.push(...t)}const n=[],r=[];for(const a of Object.keys(e))i.has(a)?n.push(a):r.push(a);return{referencedNodeIds:n,deletedNodeIds:r}}i.d(t,"a",(function(){return s}))},28879:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var s=i(28858),n=i(28824),r=i(28877),a=i(28842),o=i(28881),c=i(28880);class l extends c.b{constructor(e,t){super(t),this.serializedUsedRoutes=e}}class h extends o.a{constructor(e,t,i,n,r,a,o,c,l){super(e,async(e,i,s)=>t(e,!0,s),i,n,r,a,o),this.summarizeFn=t,this.getGCDataFn=c,this.baseGCDetailsLoaded=!1,this.usedRoutes=[""],this.gcDisabled=!0===i.gcDisabled,this.baseGCDetailsP=new s.b(async()=>{var e;return null!==(e=await(null==l?void 0:l()))&&void 0!==e?e:{usedRoutes:[]}})}getGCSummaryDetails(){return this.getBaseGCDetails()}getBaseGCDetails(){return{gcData:this.gcData,usedRoutes:this.usedRoutes,unrefTimestamp:this.unreferencedTimestampMs}}async loadBaseGCDetails(){var e;const t=await this.baseGCDetailsP;this.baseGCDetailsLoaded||(this.baseGCDetailsLoaded=!0,void 0!==t.gcData&&(this.gcData=Object(r.b)(t.gcData)),this.referenceUsedRoutes=null===(e=t.usedRoutes)||void 0===e?void 0:e.sort(),this.unreferencedTimestampMs=t.unrefTimestamp)}async summarize(e,t=!0,i){return!this.gcDisabled&&this.isTrackingInProgress()&&Object(n.a)(void 0!==this.wipSerializedUsedRoutes,433),t?super.summarize(e,!0,i):this.summarizeFn(e,t,i)}async getGCData(e=!1){if(Object(n.a)(!this.gcDisabled,434),Object(n.a)(void 0!==this.getGCDataFn,435),await this.loadBaseGCDetails(),!e&&!this.hasDataChanged()&&void 0!==this.gcData)return Object(r.b)(this.gcData);const t=await this.getGCDataFn(e);return this.gcData=Object(r.b)(t),t}startSummary(e,t){this.gcDisabled||Object(n.a)(void 0===this.wipSerializedUsedRoutes,436),super.startSummary(e,t)}completeSummaryCore(e,t,i){let s;if(this.gcDisabled||(s=this.wipSerializedUsedRoutes,Object(n.a)(void 0!==s,437)),super.completeSummaryCore(e,t,i),!this.gcDisabled){const t=this.pendingSummaries.get(e);if(void 0!==t){const i=new l(s,t);this.pendingSummaries.set(e,i)}}}clearSummary(){this.wipSerializedUsedRoutes=void 0,super.clearSummary()}refreshLatestSummaryFromPending(e,t){if(!this.gcDisabled){const t=this.pendingSummaries.get(e);void 0!==t&&(this.referenceUsedRoutes=JSON.parse(t.serializedUsedRoutes))}return super.refreshLatestSummaryFromPending(e,t)}async refreshLatestSummaryFromSnapshot(e,t,i,s,n,r){if(!this.gcDisabled){const i=t.blobs[a.gcBlobKey];if(void 0!==i){const t=await r(i);if(this.referenceSequenceNumber>=e)return;this.referenceUsedRoutes=t.usedRoutes}}return super.refreshLatestSummaryFromSnapshot(e,t,i,s,n,r)}createChild(e,t,i,s={},r,a){var o;Object(n.a)(!this.children.has(t),438);const c=this.getCreateDetailsForChild(t,i),l=new h(this.defaultLogger,e,Object.assign(Object.assign({},s),{gcDisabled:null!==(o=s.gcDisabled)&&void 0!==o?o:this.gcDisabled}),c.changeSequenceNumber,c.latestSummary,c.initialSummary,this.wipSummaryLogger,r,a);return this.maybeUpdateChildState(l),this.children.set(t,l),l}deleteChild(e){this.children.delete(e)}getChild(e){return this.children.get(e)}isReferenced(){return this.usedRoutes.includes("")||this.usedRoutes.includes("/")}updateUsedRoutes(e,t){this.usedRoutes=e.sort(),!this.gcDisabled&&this.isTrackingInProgress()&&(this.wipSerializedUsedRoutes=JSON.stringify(this.usedRoutes)),this.isReferenced()?this.unreferencedTimestampMs=void 0:void 0===this.unreferencedTimestampMs&&(this.unreferencedTimestampMs=t)}hasChanged(){return this.hasDataChanged()||this.hasUsedStateChanged()}hasDataChanged(){return super.hasChanged()}hasUsedStateChanged(){return!this.gcDisabled&&(void 0===this.referenceUsedRoutes||JSON.stringify(this.usedRoutes)!==JSON.stringify(this.referenceUsedRoutes))}}const u=(e,t,i,s,n={},r,a)=>new h(e,t,n,i,void 0===s?void 0:c.b.createForRoot(s),void 0,void 0,r,a)},28880:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return l})),i.d(t,"d",(function(){return h})),i.d(t,"e",(function(){return u})),i.d(t,"f",(function(){return d}));var s=i(28824),n=i(28860),r=i(28842),a=i(28870);class o{constructor(e){this.path=e}static create(e){return new o(encodeURIComponent(e))}static createAndConcat(e){var t;let i=o.create(null!==(t=e[0])&&void 0!==t?t:"");for(let s=1;s<e.length;s++)i=i.concat(o.create(e[s]));return i}toString(){return this.path}concat(e){return new o(`${this.path}/${e.path}`)}}class c{constructor(e){this.summary=e}static createForRoot(e){return new c({referenceSequenceNumber:e,basePath:void 0,localPath:o.create("")})}get referenceSequenceNumber(){return this.summary.referenceSequenceNumber}get basePath(){return this.summary.basePath}get localPath(){return this.summary.localPath}get additionalPath(){return this.summary.additionalPath}set additionalPath(e){this.summary.additionalPath=e}get fullPath(){var e,t;return null!==(t=null===(e=this.basePath)||void 0===e?void 0:e.concat(this.localPath))&&void 0!==t?t:this.localPath}get fullPathForChildren(){return void 0!==this.additionalPath?this.fullPath.concat(this.additionalPath):this.fullPath}createForChild(e){return new c({referenceSequenceNumber:this.referenceSequenceNumber,basePath:this.fullPathForChildren,localPath:o.create(e)})}}function l(e,t){let i=e;const n=[],r=[];for(let a=0;;a++){a>100&&t.sendTelemetryEvent({eventName:"DecodeSummaryMaxDepth",maxDecodeDepth:100});const e=i.blobs._outstandingOps,o=i.trees._baseSummary;if(void 0===e&&void 0===o)return{baseSummary:i,pathParts:n,async getOutstandingOps(e){let i=[];for(const s of r){const n=await e(s);if(i.length>0&&n.length>0){const e=i[i.length-1].sequenceNumber,s=n[0].sequenceNumber;if(s<=e)for(t.sendTelemetryEvent({eventName:"DuplicateOutstandingOps",message:`newEarliestSeq <= latestSeq in decodeSummary: ${s} <= ${e}`});n.length>0&&n[0].sequenceNumber<=e;)n.shift()}i=i.concat(n)}return i}};Object(s.a)(!!e,431),Object(s.a)(void 0!==o,432),i=o,n.push("_baseSummary"),r.unshift(e)}}function h(e,t){let i=o.create("_baseSummary");const s=new a.a;if(s.addBlob("_outstandingOps",JSON.stringify(t)),e.fromSummary){const t=e.summaryNode;void 0!==t.additionalPath&&(i=i.concat(t.additionalPath)),s.addHandle("_baseSummary",n.a.Tree,t.fullPath.path)}else s.addWithStats("_baseSummary",e.initialSummary);const r=s.getSummaryTree();return Object.assign(Object.assign({},r),{additionalPath:i})}function u(e){const t=e.trees[r.channelsTreeName];return void 0!==t?{childrenTree:t,childrenPathPart:r.channelsTreeName}:{childrenTree:e,childrenPathPart:void 0}}function d(e){const t=e.tree[r.channelsTreeName];return void 0!==t?{childrenTree:t,childrenPathPart:r.channelsTreeName}:{childrenTree:e,childrenPathPart:void 0}}},28881:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var s=i(28842),n=i(28860),r=i(28824),a=i(28868),o=i(28870),c=i(28880);class l{constructor(e,t,i,s,n,r,a){var o;this.defaultLogger=e,this.summarizeInternalFn=t,this._changeSequenceNumber=s,this._latestSummary=n,this.initialSummary=r,this.wipSummaryLogger=a,this.children=new Map,this.pendingSummaries=new Map,this.outstandingOps=[],this.wipSkipRecursion=!1,this.canReuseHandle=null===(o=i.canReuseHandle)||void 0===o||o,this.throwOnError=!0,this.trackingSequenceNumber=this._changeSequenceNumber}get referenceSequenceNumber(){var e,t;return null!==(t=null===(e=this._latestSummary)||void 0===e?void 0:e.referenceSequenceNumber)&&void 0!==t?t:0}startSummary(e,t){Object(r.a)(void 0===this.wipSummaryLogger,415),Object(r.a)(void 0===this.wipReferenceSequenceNumber,416),this.wipSummaryLogger=t;for(const i of this.children.values())i.startSummary(e,this.wipSummaryLogger);this.wipReferenceSequenceNumber=e}async summarize(e,t=!0,i){if(Object(r.a)(this.isTrackingInProgress(),417),Object(r.a)(void 0!==this.wipSummaryLogger,418),this.canReuseHandle&&!e&&!this.hasChanged()){const e=this._latestSummary;if(void 0!==e){this.wipLocalPaths={localPath:e.localPath,additionalPath:e.additionalPath},this.wipSkipRecursion=!0;const t=Object(o.j)();return t.handleNodeCount++,{summary:{type:n.a.Handle,handle:e.fullPath.path,handleType:n.a.Tree},stats:t}}}try{const t=await this.summarizeInternalFn(e,!0,i);return this.wipLocalPaths={localPath:c.a.create(t.id)},void 0!==t.pathPartsForChildren&&(this.wipLocalPaths.additionalPath=c.a.createAndConcat(t.pathPartsForChildren)),{summary:t.summary,stats:t.stats}}catch(s){if(this.throwOnError||this.trackingSequenceNumber<this._changeSequenceNumber)throw s;const e=this._latestSummary,t=this.initialSummary;let i,n;if(void 0!==e)i={fromSummary:!0,summaryNode:e},n=e.localPath;else{if(void 0===(null==t?void 0:t.summary))throw s;i={fromSummary:!1,initialSummary:t.summary},n=c.a.create(t.id)}this.wipSummaryLogger.sendErrorEvent({eventName:"SummarizingWithBasePlusOps"},s);const r=Object(c.d)(i,this.outstandingOps);return this.wipLocalPaths={localPath:n,additionalPath:r.additionalPath},this.wipSkipRecursion=!0,{summary:r.summary,stats:r.stats}}}completeSummary(e){this.completeSummaryCore(e,void 0,!1)}completeSummaryCore(e,t,i){Object(r.a)(void 0!==this.wipSummaryLogger,419),Object(r.a)(void 0!==this.wipReferenceSequenceNumber,420);let s=this.wipLocalPaths;if(i){const e=this._latestSummary;if(void 0===e)return void this.clearSummary();s={localPath:e.localPath,additionalPath:e.additionalPath}}Object(r.a)(!!s,421);const n=new c.b(Object.assign(Object.assign({},s),{referenceSequenceNumber:this.wipReferenceSequenceNumber,basePath:t})),a=n.fullPathForChildren;for(const r of this.children.values())r.completeSummaryCore(e,a,this.wipSkipRecursion||i);this.pendingSummaries.set(e,n),this.clearSummary()}clearSummary(){this.wipReferenceSequenceNumber=void 0,this.wipLocalPaths=void 0,this.wipSkipRecursion=!1,this.wipSummaryLogger=void 0;for(const e of this.children.values())e.clearSummary()}async refreshLatestSummary(e,t,i,s,n){if(void 0!==e){const t=this.pendingSummaries.get(e);if(void 0!==t)return this.refreshLatestSummaryFromPending(e,t.referenceSequenceNumber),{latestSummaryUpdated:!0,wasSummaryTracked:!0}}if(this.referenceSequenceNumber>=t)return{latestSummaryUpdated:!1};const r=await i();return await this.refreshLatestSummaryFromSnapshot(t,r,void 0,c.a.create(""),n,s),{latestSummaryUpdated:!0,wasSummaryTracked:!1,snapshot:r}}refreshLatestSummaryFromPending(e,t){const i=this.pendingSummaries.get(e);if(void 0!==i){Object(r.a)(t===i.referenceSequenceNumber,423),this.pendingSummaries.delete(e),this.refreshLatestSummaryCore(t),this._latestSummary=i;for(const i of this.children.values())i.refreshLatestSummaryFromPending(e,t)}else Object(r.a)(void 0===this._latestSummary,422)}async refreshLatestSummaryFromSnapshot(e,t,i,s,n,r){if(this.referenceSequenceNumber>=e)return;this.refreshLatestSummaryCore(e);const{baseSummary:a,pathParts:o}=Object(c.c)(t,n);this._latestSummary=new c.b({referenceSequenceNumber:e,basePath:i,localPath:s});const{childrenTree:l,childrenPathPart:h}=Object(c.e)(a);void 0!==h&&o.push(h),o.length>0&&(this._latestSummary.additionalPath=c.a.createAndConcat(o));const u=this._latestSummary.fullPathForChildren;await Promise.all(Array.from(this.children).filter(([e])=>void 0!==l.trees[e]).map(async([t,i])=>i.refreshLatestSummaryFromSnapshot(e,l.trees[t],u,c.a.create(t),n,r)))}refreshLatestSummaryCore(e){for(const[t,i]of this.pendingSummaries)i.referenceSequenceNumber<e&&this.pendingSummaries.delete(t);for(;this.outstandingOps.length>0&&this.outstandingOps[0].sequenceNumber<=e;)this.outstandingOps.shift()}loadBaseSummaryWithoutDifferential(e){const{childrenPathPart:t}=Object(c.e)(e);void 0!==t&&void 0!==this._latestSummary&&(this._latestSummary.additionalPath=c.a.create(t))}async loadBaseSummary(e,t){const i=Object(c.c)(e,this.defaultLogger),s=await i.getOutstandingOps(t),{childrenPathPart:n}=Object(c.e)(i.baseSummary);if(void 0!==n&&i.pathParts.push(n),i.pathParts.length>0&&void 0!==this._latestSummary&&(this._latestSummary.additionalPath=c.a.createAndConcat(i.pathParts)),s.length>0){const e=s[s.length-1].sequenceNumber;Object(r.a)(e<=this.trackingSequenceNumber,425)}return{baseSummary:i.baseSummary,outstandingOps:s}}recordChange(e){const t=this.outstandingOps[this.outstandingOps.length-1];void 0!==t&&Object(r.a)(t.sequenceNumber<e.sequenceNumber,426),this.invalidate(e.sequenceNumber),this.trackingSequenceNumber=e.sequenceNumber,this.outstandingOps.push(e)}invalidate(e){e>this._changeSequenceNumber&&(this._changeSequenceNumber=e)}hasChanged(){return this._changeSequenceNumber>this.referenceSequenceNumber}get latestSummary(){return this._latestSummary}createChild(e,t,i,s={}){Object(r.a)(!this.children.has(t),427);const n=this.getCreateDetailsForChild(t,i),a=new l(this.defaultLogger,e,s,n.changeSequenceNumber,n.latestSummary,n.initialSummary,this.wipSummaryLogger);return this.maybeUpdateChildState(a),this.children.set(t,a),a}getChild(e){return this.children.get(e)}getCreateDetailsForChild(e,t){var i;let l,h,u;const d=this._latestSummary;switch(t.type){case s.CreateSummarizerNodeSource.FromAttach:if(void 0!==d&&t.sequenceNumber<=d.referenceSequenceNumber)h=d.createForChild(e);else{const i=Object(o.i)(t.snapshot);l={sequenceNumber:t.sequenceNumber,id:e,summary:i}}u=t.sequenceNumber;break;case s.CreateSummarizerNodeSource.FromSummary:void 0===this.initialSummary&&Object(r.a)(!!d,428);case s.CreateSummarizerNodeSource.Local:{const a=this.initialSummary;if(void 0!==a){let i,h;if(void 0!==a.summary){const{childrenTree:t}=Object(c.f)(a.summary.summary);Object(r.a)(t.type===n.a.Tree,470),i=t.tree[e]}t.type===s.CreateSummarizerNodeSource.FromSummary&&Object(r.a)(!!i,429),void 0!==i&&(Object(r.a)(i.type===n.a.Tree,430),h={summary:i,stats:Object(o.f)(i)}),l={sequenceNumber:a.sequenceNumber,id:e,summary:h}}h=null==d?void 0:d.createForChild(e),u=null!==(i=null==d?void 0:d.referenceSequenceNumber)&&void 0!==i?i:-1;break}default:{const e=t.type;Object(a.a)(t,"Unexpected CreateSummarizerNodeSource: "+e)}}return{initialSummary:l,latestSummary:h,changeSequenceNumber:u}}maybeUpdateChildState(e){if(this.isTrackingInProgress()&&(e.wipReferenceSequenceNumber=this.wipReferenceSequenceNumber),void 0!==e._latestSummary)for(const[t,i]of this.pendingSummaries.entries()){const s=new c.b({referenceSequenceNumber:i.referenceSequenceNumber,basePath:e._latestSummary.basePath,localPath:e._latestSummary.localPath});e.addPendingSummary(t,s)}}addPendingSummary(e,t){this.pendingSummaries.set(e,t)}isTrackingInProgress(){return void 0!==this.wipReferenceSequenceNumber}}},28882:function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var s=i(28827),n=i(28870),r=i(28824),a=i(28858),o=i(28838),c=i(28828);class l{constructor(e,t,i){this.path=e,this.routeContext=t,this.get=i,this.attached=!1,this.absolutePath=Object(s.a)(e,this.routeContext)}get IFluidHandle(){return this}get isAttached(){return this.attached}attachGraph(){this.attached=!0}bind(e){throw new Error("Cannot bind to blob handle")}}class h{constructor(e,t,i,s,n,r,a){this.routeContext=e,this.getStorage=i,this.attachBlobCallback=s,this.gcNodeUpdated=n,this.runtime=r,this.logger=a,this.blobIds=new Set,this.pendingBlobIds=new Map,this.detachedBlobIds=new Set,this.runtime.once("dispose",()=>{for(const e of this.pendingBlobIds.values())e.reject(new Error("runtime disposed while blobAttach op in flight"))}),this.load(t)}hasBlob(e){return this.blobIds.has(e)||this.detachedBlobIds.has(e)}getBlobGCNodePath(e){return`/${h.basePath}/${e}`}async getBlob(e){var t,i;const s=null!==(i=null===(t=this.redirectTable)||void 0===t?void 0:t.get(e))&&void 0!==i?i:e;return Object(r.a)(this.hasBlob(s),287),this.gcNodeUpdated(this.getBlobGCNodePath(e)),new l(`${h.basePath}/${s}`,this.routeContext,async()=>c.b.timedExecAsync(this.logger,{eventName:"AttachmentReadBlob",id:s},async()=>this.getStorage().readBlob(s),{end:!0,cancel:"error"}))}async createBlob(e){var t,i;this.runtime.attachState===o.a.Attaching&&(this.logger.sendTelemetryEvent({eventName:"CreateBlobWhileAttaching"}),await new Promise(e=>this.runtime.once("attached",e))),this.runtime.connected||this.runtime.attachState!==o.a.Attached||await new Promise(e=>this.runtime.once("connected",e));const s=await c.b.timedExecAsync(this.logger,{eventName:"createBlob"},async()=>this.getStorage().createBlob(e),{end:!0,cancel:"error"}),n=new l(`${h.basePath}/${s.id}`,this.routeContext,async()=>this.getBlob(s.id).then(async e=>e.get()));return this.runtime.attachState===o.a.Detached?(this.detachedBlobIds.add(s.id),n):(this.pendingBlobIds.has(s.id)?await(null===(t=this.pendingBlobIds.get(s.id))||void 0===t?void 0:t.promise):this.blobIds.has(s.id)||(this.pendingBlobIds.set(s.id,new a.a),this.attachBlobCallback(s.id),await(null===(i=this.pendingBlobIds.get(s.id))||void 0===i?void 0:i.promise)),n)}processBlobAttachOp(e,t){if(t){const t=this.pendingBlobIds.get(e);Object(r.a)(void 0!==t,504),t.resolve(),this.pendingBlobIds.delete(e)}this.blobIds.add(e)}static async load(e,t){if(!e)return{};let i;const s=e.blobs[this.redirectTableBlobName];s&&(i=await t(s));return{ids:Object.entries(e.blobs).filter(([e,t])=>e!==this.redirectTableBlobName).map(([e,t])=>t),redirectTable:i}}load(e){var t,i,s;if(e.ids){const t=this.runtime.attachState===o.a.Detached;e.ids.map(e=>t?this.detachedBlobIds.add(e):this.blobIds.add(e))}e.redirectTable&&(this.redirectTable=new Map(e.redirectTable)),this.logger.sendTelemetryEvent({eventName:"AttachmentBlobsLoaded",count:null!==(i=null===(t=e.ids)||void 0===t?void 0:t.length)&&void 0!==i?i:0,redirectTable:null===(s=e.redirectTable)||void 0===s?void 0:s.length})}getGCData(e=!1){const t={gcNodes:{}};if(this.blobIds.forEach(e=>{t.gcNodes[this.getBlobGCNodePath(e)]=[]}),void 0!==this.redirectTable)for(const[i,s]of this.redirectTable)t.gcNodes[this.getBlobGCNodePath(i)]=[this.getBlobGCNodePath(s)];return t}deleteUnusedRoutes(e){var t;for(const i of e){const e=i.split("/");Object(r.a)(3===e.length&&e[1]===h.basePath,725);const s=e[2];(null===(t=this.redirectTable)||void 0===t?void 0:t.has(s))?this.redirectTable.delete(s):this.blobIds.delete(s)}}summarize(e){const t=!!this.redirectTable||this.runtime.attachState!==o.a.Detached?this.blobIds:this.detachedBlobIds,i=new n.a;return t.forEach(e=>{i.addAttachment(e)}),this.redirectTable&&this.redirectTable.size>0&&i.addBlob(h.redirectTableBlobName,JSON.stringify(Array.from(this.redirectTable.entries()))),i.getSummaryTree()}setRedirectTable(e){Object(r.a)(this.runtime.attachState===o.a.Detached,594),Object(r.a)(!this.redirectTable,595);for(const[t,i]of e)Object(r.a)(this.detachedBlobIds.delete(t),596),this.blobIds.add(i);Object(r.a)(0===this.detachedBlobIds.size,597),this.redirectTable=e}}h.basePath="_blobs",h.redirectTableBlobName=".redirectTable"},28883:function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var s=i(28832),n=i(28824),r=i(28836),a=i(28842),o=i(28829),c=i(28884),l=i.n(c);class h{constructor(e,t,i){var n;this.stateHandler=e,this.pendingStates=new l.a,this.disposeOnce=new s.a(()=>{this.initialStates.clear(),this.pendingStates.clear()}),this._pendingMessagesCount=0,this.isProcessingBatch=!1,this.dispose=()=>this.disposeOnce.value,this.initialStates=new l.a(null!==(n=null==i?void 0:i.pendingStates)&&void 0!==n?n:[]),this.flushModeForNextMessage=t,this.onFlushModeUpdated(t)}get pendingMessagesCount(){return this._pendingMessagesCount}hasPendingMessages(){return 0!==this._pendingMessagesCount||!this.initialStates.isEmpty()}getLocalState(){if(Object(n.a)(this.initialStates.isEmpty(),745),this.hasPendingMessages())return{pendingStates:this.pendingStates.toArray().map(e=>"message"===e.type?Object.assign(Object.assign({},e),{localOpMetadata:void 0}):e)}}get disposed(){return this.disposeOnce.evaluated}onSubmitMessage(e,t,i,s,n,r){const a={type:"message",messageType:e,clientSequenceNumber:t,referenceSequenceNumber:i,content:s,localOpMetadata:n,opMetadata:r};this.pendingStates.push(a),this._pendingMessagesCount++}onFlushModeUpdated(e){this.pendingStates.push({type:"flushMode",flushMode:e})}onFlush(){if(this.stateHandler.flushMode()===a.FlushMode.Immediate)return;const e=this.pendingStates.peekBack();"message"===(null==e?void 0:e.type)&&this.pendingStates.push({type:"flush"})}async applyStashedOpsAt(e){for(;!this.initialStates.isEmpty();){const t=this.initialStates.peekFront();if("message"===t.type){if(void 0!==e){if(t.referenceSequenceNumber>e)break;if(t.referenceSequenceNumber<e)throw new Error("loaded from snapshot too recent to apply stashed ops")}const i=await this.stateHandler.applyStashedOp(t.messageType,t.content);t.localOpMetadata=i}this.pendingStates.push(this.initialStates.shift())}}processPendingLocalMessage(e){this.maybeProcessBatchBegin(e);const t=this.peekNextPendingState();if(Object(n.a)("message"===t.type,361),this.pendingStates.shift(),t.clientSequenceNumber===e.clientSequenceNumber)return this._pendingMessagesCount--,this.maybeProcessBatchEnd(e),t.localOpMetadata;{const i=r.c.create("pending local message clientSequenceNumber mismatch","unexpectedAckReceived",e,{expectedClientSequenceNumber:t.clientSequenceNumber});this.stateHandler.close(i)}}maybeProcessBatchBegin(e){let t,i=!1,s=this.peekNextPendingState();for(;"message"!==s.type;)"flushMode"===s.type&&(t=s.flushMode),"flush"===s.type&&(i=!0),this.pendingStates.shift(),s=this.peekNextPendingState();void 0!==t&&(this.flushModeForNextMessage=t),t!==a.FlushMode.Immediate&&(t===a.FlushMode.TurnBased||i)&&(Object(n.a)(!this.isProcessingBatch&&void 0===this.pendingBatchBeginMessage,363),this.pendingBatchBeginMessage=e,this.isProcessingBatch=!0)}maybeProcessBatchEnd(e){var t,i;if(!this.isProcessingBatch)return;const s=this.peekNextPendingState();if("message"===s.type)return;Object(n.a)("flushMode"!==s.type,701),Object(n.a)(void 0!==this.pendingBatchBeginMessage,365);const r=null===(t=this.pendingBatchBeginMessage.metadata)||void 0===t?void 0:t.batch;if(this.pendingBatchBeginMessage===e)Object(n.a)(void 0===r,366);else{const t=null===(i=e.metadata)||void 0===i?void 0:i.batch;Object(n.a)(!0===r,367),Object(n.a)(!1===t,368)}this.pendingBatchBeginMessage=void 0,this.isProcessingBatch=!1}checkpoint(){const e=this.pendingStates.peekBack();return{rollback:()=>{try{for(;this.pendingStates.peekBack()!==e;)this.rollbackNextPendingState()}catch(t){const e=Object(o.h)(t,e=>r.c.create("RollbackError: "+e,"checkpointRollback",void 0));throw this.stateHandler.close(e),e}}}}peekNextPendingState(){const e=this.pendingStates.peekFront();return Object(n.a)(!!e,369),e}rollbackNextPendingState(){if(0===this.pendingStates.length)return;this._pendingMessagesCount--;const e=this.pendingStates.pop();switch(e.type){case"message":this.stateHandler.rollback(e.messageType,e.content,e.localOpMetadata);break;default:throw new Error("Can't rollback state "+e.type)}}replayPendingStates(){Object(n.a)(this.stateHandler.connected(),370),Object(n.a)(this.clientId!==this.stateHandler.clientId(),371),this.clientId=this.stateHandler.clientId(),Object(n.a)(this.initialStates.isEmpty(),372);let e=this.pendingStates.length;if(0===e)return;this._pendingMessagesCount=0;const t=this.stateHandler.flushMode();for(this.stateHandler.setFlushMode(this.flushModeForNextMessage);e>0;){const t=this.pendingStates.shift();switch(t.type){case"message":this.stateHandler.reSubmit(t.messageType,t.content,t.localOpMetadata,t.opMetadata);break;case"flushMode":this.stateHandler.setFlushMode(t.flushMode);break;case"flush":this.stateHandler.flush()}e--}this.stateHandler.setFlushMode(t)}}},28884:function(e,t,i){"use strict";function s(e){if(this._capacity=r(e),this._length=0,this._front=0,n(e)){for(var t=e.length,i=0;i<t;++i)this[i]=e[i];this._length=t}}s.prototype.toArray=function(){for(var e=this._length,t=new Array(e),i=this._front,s=this._capacity,n=0;n<e;++n)t[n]=this[i+n&s-1];return t},s.prototype.push=function(e){var t=arguments.length,i=this._length;if(t>1){var s=this._capacity;if(i+t>s){for(var n=0;n<t;++n){this._checkCapacity(i+1),this[r=this._front+i&this._capacity-1]=arguments[n],i++,this._length=i}return i}for(var r=this._front,n=0;n<t;++n)this[r+i&s-1]=arguments[n],r++;return this._length=i+t,i+t}return 0===t?i:(this._checkCapacity(i+1),this[n=this._front+i&this._capacity-1]=e,this._length=i+1,i+1)},s.prototype.pop=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1,i=this[t];return this[t]=void 0,this._length=e-1,i}},s.prototype.shift=function(){var e=this._length;if(0!==e){var t=this._front,i=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length=e-1,i}},s.prototype.unshift=function(e){var t=this._length,i=arguments.length;if(i>1){if(t+i>(n=this._capacity)){for(var s=i-1;s>=0;s--){this._checkCapacity(t+1);var n=this._capacity;this[a=(this._front-1&n-1^n)-n]=arguments[s],t++,this._length=t,this._front=a}return t}var r=this._front;for(s=i-1;s>=0;s--){var a;this[a=(r-1&n-1^n)-n]=arguments[s],r=a}return this._front=r,this._length=t+i,t+i}if(0===i)return t;this._checkCapacity(t+1);n=this._capacity;return this[s=(this._front-1&n-1^n)-n]=e,this._length=t+1,this._front=s,t+1},s.prototype.peekBack=function(){var e=this._length;if(0!==e)return this[this._front+e-1&this._capacity-1]},s.prototype.peekFront=function(){if(0!==this._length)return this[this._front]},s.prototype.get=function(e){var t=e;if(t===(0|t)){var i=this._length;if(t<0&&(t+=i),!(t<0||t>=i))return this[this._front+t&this._capacity-1]}},s.prototype.isEmpty=function(){return 0===this._length},s.prototype.clear=function(){for(var e=this._length,t=this._front,i=this._capacity,s=0;s<e;++s)this[t+s&i-1]=void 0;this._length=0,this._front=0},s.prototype.toString=function(){return this.toArray().toString()},s.prototype.valueOf=s.prototype.toString,s.prototype.removeFront=s.prototype.shift,s.prototype.removeBack=s.prototype.pop,s.prototype.insertFront=s.prototype.unshift,s.prototype.insertBack=s.prototype.push,s.prototype.enqueue=s.prototype.push,s.prototype.dequeue=s.prototype.shift,s.prototype.toJSON=s.prototype.toArray,Object.defineProperty(s.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),s.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(r(1.5*this._capacity+16))},s.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var i=this._front,s=this._length;i+s>t&&function(e,t,i,s,n){for(var r=0;r<n;++r)i[r+s]=e[r+t],e[r+t]=void 0}(this,0,this,t,i+s&t-1)};var n=Array.isArray;function r(e){if("number"!=typeof e){if(!n(e))return 16;e=e.length}return t=Math.min(Math.max(16,e),1073741824),t>>>=0,t-=1,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,1+(t|=t>>16);var t}e.exports=s},28885:function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var s,n=i(28858),r=i(28824),a=i(28823),o=i(28849);!function(e){e[e.Local=0]="Local",e[e.Broadcast=1]="Broadcast",e[e.Acked=2]="Acked",e[e.Nacked=-1]="Nacked"}(s||(s={}));class c{constructor(e,t){this.clientId=e,this.clientSequenceNumber=t,this.state=s.Local,this.defSummaryOp=new n.a,this.defSummaryAck=new n.a}static createLocal(e,t){return new c(e,t)}static createFromOp(e){const t=new c(e.clientId,e.clientSequenceNumber);return t.broadcast(e),t}get summaryOp(){return this._summaryOp}get summaryAckNack(){return this._summaryAckNack}hasBeenAcked(){return this.state===s.Acked}broadcast(e){return Object(r.a)(this.state===s.Local,373),this._summaryOp=e,this.defSummaryOp.resolve(),this.state=s.Broadcast,!0}ackNack(e){return Object(r.a)(this.state===s.Broadcast,374),this._summaryAckNack=e,this.defSummaryAck.resolve(),this.state=e.type===o.a.SummaryAck?s.Acked:s.Nacked,!0}async waitBroadcast(){return await this.defSummaryOp.promise,this._summaryOp}async waitAckNack(){return await this.defSummaryAck.promise,this._summaryAckNack}}class l{constructor(e,t){this.clientId=e,this.summaryCollection=t,this.localSummaries=new Map,this._disposed=!1}get disposed(){return this._disposed}watchSummary(e){let t=this.localSummaries.get(e);return t||(t=c.createLocal(this.clientId,e),this.localSummaries.set(t.clientSequenceNumber,t)),t}waitFlushed(){return this.summaryCollection.waitFlushed()}tryGetSummary(e){return this.localSummaries.get(e)}setSummary(e){this.localSummaries.set(e.clientSequenceNumber,e)}dispose(){this.summaryCollection.removeWatcher(this.clientId),this._disposed=!0}}class h extends a.a{constructor(e,t){super(),this.deltaManager=e,this.logger=t,this.summaryWatchers=new Map,this.pendingSummaries=new Map,this.refreshWaitNextAck=new n.a,this.deltaManager.on("op",e=>this.handleOp(e))}get latestAck(){return this.lastAck}emit(e,...t){return super.emit(e,...t)}get opsSinceLastAck(){var e,t;return this.deltaManager.lastSequenceNumber-(null!==(t=null===(e=this.lastAck)||void 0===e?void 0:e.summaryAck.sequenceNumber)&&void 0!==t?t:this.deltaManager.initialSequenceNumber)}addOpListener(e){this.deltaManager.on("op",e)}removeOpListener(e){this.deltaManager.off("op",e)}createWatcher(e){const t=new l(e,this);return this.summaryWatchers.set(e,t),t}removeWatcher(e){this.summaryWatchers.delete(e)}setPendingAckTimerTimeoutCallback(e,t){this.maxAckWaitTime=e,this.pendingAckTimerTimeoutCallback=t}unsetPendingAckTimerTimeoutCallback(){this.maxAckWaitTime=void 0,this.pendingAckTimerTimeoutCallback=void 0}async waitFlushed(){for(;this.pendingSummaries.size>0;){const e=Array.from(this.pendingSummaries,([,e])=>e.waitAckNack());await Promise.all(e)}return this.lastAck}async waitSummaryAck(e){for(;!this.lastAck||this.lastAck.summaryOp.referenceSequenceNumber<e;)await this.refreshWaitNextAck.promise;return this.lastAck}handleOp(e){var t;switch(e.type){case o.a.Summarize:return void this.handleSummaryOp(e);case o.a.SummaryAck:return void this.handleSummaryAck(e);case o.a.SummaryNack:return void this.handleSummaryNack(e);default:{const i=e.timestamp;return void 0!==this.lastSummaryTimestamp&&void 0!==this.maxAckWaitTime&&i-this.lastSummaryTimestamp>=this.maxAckWaitTime&&(null===(t=this.pendingAckTimerTimeoutCallback)||void 0===t||t.call(this)),void this.emit("default",e)}}}handleSummaryOp(e){let t;const i=this.summaryWatchers.get(e.clientId);i&&(t=i.tryGetSummary(e.clientSequenceNumber),t&&t.broadcast(e)),t||(t=c.createFromOp(e),i&&i.setSummary(t)),this.pendingSummaries.set(e.sequenceNumber,t),this.lastSummaryTimestamp=e.timestamp,this.emit(o.a.Summarize,e)}handleSummaryAck(e){const t=e.contents.summaryProposal.summarySequenceNumber,i=this.pendingSummaries.get(t);i&&void 0!==i.summaryOp?(i.ackNack(e),this.pendingSummaries.delete(t),(!this.lastAck||t>this.lastAck.summaryAck.contents.summaryProposal.summarySequenceNumber)&&(this.lastAck={summaryOp:i.summaryOp,summaryAck:e},this.refreshWaitNextAck.resolve(),this.refreshWaitNextAck=new n.a,this.emit(o.a.SummaryAck,e))):t>=this.deltaManager.initialSequenceNumber&&this.logger.sendErrorEvent({eventName:"SummaryAckWithoutOp",sequenceNumber:e.sequenceNumber,summarySequenceNumber:t,initialSequenceNumber:this.deltaManager.initialSequenceNumber})}handleSummaryNack(e){const t=e.contents.summaryProposal.summarySequenceNumber,i=this.pendingSummaries.get(t);i&&(i.ackNack(e),this.pendingSummaries.delete(t),this.emit(o.a.SummaryNack,e))}}},28886:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return l}));var s=i(28823),n=i(28824),r=i(28836),a=i(28828),o=i(28854);class c extends s.a{constructor(e,t,i){super(),this.clientMap=new Map,this.rootNode={sequenceNumber:-1,olderClient:void 0,youngerClient:void 0},this._youngestClient=this.rootNode,this.logger=a.a.create(e,"OrderedClientCollection");const s=i.getMembers();for(const[n,r]of s)this.addClient(n,r);i.on("addMember",(e,i)=>{const s=this.addClient(e,i);this.emit("addClient",s,t.lastSequenceNumber)}),i.on("removeMember",e=>{const i=t.lastSequenceNumber,s=this.removeClient(e);void 0===s?this.logger.sendErrorEvent({eventName:"ClientNotFound",clientId:e,sequenceNumber:i}):this.emit("removeClient",s,i)})}get count(){return this.clientMap.size}get oldestClient(){return this.rootNode.youngerClient}addClient(e,t){Object(n.a)(t.sequenceNumber>-1,502);let i=this._youngestClient;for(;i.sequenceNumber>t.sequenceNumber;)Object(n.a)(void 0!==i.olderClient,503),i=i.olderClient;const s={clientId:e,sequenceNumber:t.sequenceNumber,client:Object.assign({},t.client),olderClient:i,youngerClient:i.youngerClient};return s.olderClient.youngerClient=s,void 0===s.youngerClient?this._youngestClient=s:s.youngerClient.olderClient=s,this.clientMap.set(e,s),s}removeClient(e){const t=this.clientMap.get(e);if(void 0!==t)return t.olderClient.youngerClient=t.youngerClient,void 0===t.youngerClient?this._youngestClient=t.olderClient:t.youngerClient.olderClient=t.olderClient,this.clientMap.delete(e),t}getAllClients(){const e=[];let t=this.rootNode;for(;void 0!==t.youngerClient;)e.push(t.youngerClient),t=t.youngerClient;return e}}class l extends s.a{constructor(e,t,i,s){let n,r;super(),this.orderedClientCollection=t,this.isEligibleFn=s,this._eligibleCount=0;for(const a of t.getAllClients())this.addClient(a,0),"number"!=typeof i&&(a.clientId===i.electedClientId&&(n=a,void 0===i.electedParentId&&a.client.details.type!==o.b&&(r=a)),a.clientId===i.electedParentId&&(r=a));t.on("addClient",(e,t)=>this.addClient(e,t)),t.on("removeClient",(e,t)=>this.removeClient(e,t)),"number"==typeof i?this._electionSequenceNumber=i:((null==n?void 0:n.clientId)!==i.electedClientId?e.sendErrorEvent({eventName:"InitialElectedClientNotFound",electionSequenceNumber:i.electionSequenceNumber,expectedClientId:i.electedClientId,electedClientId:null==n?void 0:n.clientId,clientCount:t.count}):void 0===n||s(n)||(n=r=this.findFirstEligibleParent(r),e.sendErrorEvent({eventName:"InitialElectedClientIneligible",electionSequenceNumber:i.electionSequenceNumber,expectedClientId:i.electedClientId,electedClientId:null==n?void 0:n.clientId})),this._electedParent=r,this._electedClient=n,this._electionSequenceNumber=i.electionSequenceNumber)}get eligibleCount(){return this._eligibleCount}get electionSequenceNumber(){return this._electionSequenceNumber}get electedClient(){return this._electedClient}get electedParent(){return this._electedParent}tryElectingClient(e,t){let i=!1;const s=(null==e?void 0:e.client.details.type)===o.b,n=this._electedClient;this._electedClient!==e&&(this._electionSequenceNumber=t,this._electedClient=e,i=!0),this._electedParent===e||s||(this._electedParent=e,i=!0),i&&this.emit("election",e,t,n)}tryElectingParent(e,t){this._electedParent!==e&&(this._electedParent=e,this.emit("election",this._electedClient,t,this._electedClient))}findFirstEligibleParent(e){let t=e;for(;void 0!==t&&(!this.isEligibleFn(t)||t.client.details.type===o.b);)t=t.youngerClient;return t}addClient(e,t){var i;if(this.isEligibleFn(e)){this._eligibleCount++;const s=e.client.details.type===o.b,n=(null===(i=this._electedClient)||void 0===i?void 0:i.client.details.type)===o.b;void 0===this._electedClient||!n&&s?this.tryElectingClient(e,t):void 0!==this._electedParent||s||this.tryElectingParent(e,t)}}removeClient(e,t){var i,s,n,a,c;if(this.isEligibleFn(e))if(this._eligibleCount--,this._electedClient===e)if(this._electedParent!==e){if(this._electedClient.client.details.type!==o.b)throw new r.e("Elected client should be a summarizer client 1");this.tryElectingClient(this._electedParent,t)}else{const e=null!==(s=this.findFirstEligibleParent(null===(i=this._electedParent)||void 0===i?void 0:i.youngerClient))&&void 0!==s?s:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingClient(e,t)}else if(this._electedParent===e){if((null===(n=this._electedClient)||void 0===n?void 0:n.client.details.type)!==o.b)throw new r.e("Elected client should be a summarizer client 2");const e=null!==(c=this.findFirstEligibleParent(null===(a=this._electedParent)||void 0===a?void 0:a.youngerClient))&&void 0!==c?c:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingParent(e,t)}}getAllEligibleClients(){return this.orderedClientCollection.getAllClients().filter(this.isEligibleFn)}incrementElectedClient(e){var t,i;const s=null!==(i=this.findFirstEligibleParent(null===(t=this._electedParent)||void 0===t?void 0:t.youngerClient))&&void 0!==i?i:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(s,e):this.tryElectingParent(s,e)}resetElectedClient(e){const t=this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(t,e):this.tryElectingParent(t,e)}peekNextElectedClient(){var e,t;return null!==(t=this.findFirstEligibleParent(null===(e=this._electedParent)||void 0===e?void 0:e.youngerClient))&&void 0!==t?t:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient)}serialize(){var e,t;return{electionSequenceNumber:this.electionSequenceNumber,electedClientId:null===(e=this.electedClient)||void 0===e?void 0:e.clientId,electedParentId:null===(t=this.electedParent)||void 0===t?void 0:t.clientId}}}},28887:function(e,t,i){"use strict";i.d(t,"a",(function(){return S}));var s=i(18269),n=i(28858),r=i(28892),a=i(28836),o=i(28893),c=i(28890),l=i(28876),h=i(28829),u=i(28828),d=i(28830),m=i(28854),g=i(28891),p=i(28894),f=i(28895),b=i(28888);class v extends h.a{constructor(e,t=!1){super(e),this.logged=t,this.errorType="summarizingError",this.canRetry=!0}static wrap(e,t=!1,i){return Object(h.i)(e,e=>new v(e,t),i)}}class S extends s.EventEmitter{constructor(e,t,i,s,r,o,c){super(),this.runtime=t,this.configurationGetter=i,this.internalsProvider=s,this.summaryCollection=o,this.runCoordinatorCreateFn=c,this._disposed=!1,this.starting=!1,this.stopDeferred=new n.a,this.summarizeOnDemand=(...e)=>{var t;try{if(this._disposed||(null===(t=this.runningSummarizer)||void 0===t?void 0:t.disposed))throw new a.e("Summarizer is already disposed.");if(void 0!==this.runtime.summarizerClientId&&this.runtime.summarizerClientId!==this.runtime.clientId)throw new a.e("On-demand summary attempted while an elected summarizer is present");const i=new b.a;if(this.runningSummarizer)return this.runningSummarizer.summarizeOnDemand(i,...e);return this.runCoordinatorCreateFn(this.runtime).then(t=>{this.start(this.runtime.clientId,t).then(async s=>{s.summarizeOnDemand(i,...e);const n=await Promise.race([this.stopDeferred.promise,t.waitCancelled]);await s.waitStop(!1),t.stop(n),this.close()}).catch(e=>{i.fail("Failed to start summarizer",e)})}).catch(e=>{i.fail("Failed to create cancellation token",e)}),i.build()}catch(i){throw v.wrap(i,!1,this.logger)}},this.enqueueSummarize=(...e)=>{if(this._disposed||void 0===this.runningSummarizer||this.runningSummarizer.disposed)throw new a.e("Summarizer is not running or already disposed.");return this.runningSummarizer.enqueueSummarize(...e)},this.logger=u.a.create(this.runtime.logger,"Summarizer"),this.innerHandle=new g.a(this,e,r)}get IFluidLoadable(){return this}get ISummarizer(){return this}get handle(){return this.innerHandle}static async create(e,t){const i={headers:{[r.a.cache]:!1,[r.a.clientDetails]:{capabilities:{interactive:!1},type:m.b},[o.a.summarizingClient]:!0,[r.a.reconnect]:!1},url:t},s=await e.resolve(i),n=await Object(l.c)(s,{url:"_summarizer"});if(void 0===n.ISummarizer)throw new a.e("Fluid object does not implement ISummarizer");return n.ISummarizer}async run(e){try{return await this.runCore(e)}catch(t){throw this.stop("summarizerException"),v.wrap(t,!1,this.logger)}finally{this.close()}}stop(e){this.stopDeferred.resolve(e)}close(){this.dispose(),this.runtime.closeFn()}async runCore(e){const t=await this.runCoordinatorCreateFn(this.runtime),i=Promise.race([t.waitCancelled,this.stopDeferred.promise]);if(i.then(t=>{this.logger.sendTelemetryEvent({eventName:"StoppingSummarizer",onBehalfOf:e,reason:t})}),t.cancelled)return t.waitCancelled;const s=await this.start(e,t),n=await i;return await s.waitStop(!t.cancelled&&S.stopReasonCanRunLastSummary(n)),t.stop(n),n}static stopReasonCanRunLastSummary(e){return"parentNotConnected"===e}async start(e,t){if(this.runningSummarizer){if(this.runningSummarizer.disposed)throw new a.e("Starting a disposed summarizer");return this.runningSummarizer}if(this.starting)throw new a.e("Attempting to start a summarizer that is already starting");this.starting=!0,this.logger.sendTelemetryEvent({eventName:"RunningSummarizer",onBehalfOf:e,initSummarySeqNumber:this.runtime.deltaManager.initialSequenceNumber,config:JSON.stringify(this.configurationGetter())});const i=this.runtime.clientId;if(void 0===i)throw new a.e("clientId should be defined if connected.");const s=await p.a.start(this.logger,this.summaryCollection.createWatcher(i),this.configurationGetter(),async(...e)=>this.internalsProvider.submitSummary(...e),new f.a(this.runtime.deltaManager.lastSequenceNumber,{refSequenceNumber:this.runtime.deltaManager.initialSequenceNumber,summaryTime:Date.now()}),e=>{this._disposed||this.logger.sendErrorEvent({eventName:"summarizingError"},((e,t)=>new v(e,t))(e,!0))},this.summaryCollection,t,e=>t.stop(e));return this.runningSummarizer=s,this.starting=!1,this.handleSummaryAcks().catch(e=>{this.logger.sendErrorEvent({eventName:"HandleSummaryAckFatalError"},e)}),this.systemOpListener=e=>s.handleSystemOp(e),this.runtime.deltaManager.inbound.on("op",this.systemOpListener),this.opListener=(e,t)=>s.handleOp(e,t),this.runtime.on("batchEnd",this.opListener),s}dispose(){this.stop("summarizerClientDisconnected"),this._disposed=!0,this.runningSummarizer&&(this.runningSummarizer.dispose(),this.runningSummarizer=void 0),this.systemOpListener&&this.runtime.deltaManager.inbound.off("op",this.systemOpListener),this.opListener&&this.runtime.removeListener("batchEnd",this.opListener)}async handleSummaryAcks(){var e,t,i,s,n;let r,a=this.runtime.deltaManager.initialSequenceNumber;for(;this.runningSummarizer;){const l=null!==(e=this.runningSummarizer.tryGetCorrelatedLogger(a))&&void 0!==e?e:this.logger;try{r=void 0,r=await this.summaryCollection.waitSummaryAck(a),a=r.summaryOp.referenceSequenceNumber;const e=r.summaryOp.contents.handle,t=r.summaryAck.contents.handle;await this.runningSummarizer.lockedRefreshSummaryAckAction(async()=>this.internalsProvider.refreshLatestSummaryAck(e,t,a,l).catch(async i=>{if(!Object(d.b)(i)||i.errorType!==c.a.fileNotFoundOrAccessDeniedError)throw i;l.sendTelemetryEvent({eventName:"HandleSummaryAckErrorIgnored",referenceSequenceNumber:a,proposalHandle:e,ackHandle:t},i)}))}catch(o){l.sendErrorEvent({eventName:"HandleSummaryAckError",referenceSequenceNumber:a,handle:null===(i=null===(t=null==r?void 0:r.summaryOp)||void 0===t?void 0:t.contents)||void 0===i?void 0:i.handle,ackHandle:null===(n=null===(s=null==r?void 0:r.summaryAck)||void 0===s?void 0:s.contents)||void 0===n?void 0:n.handle},o)}a++}}}},28888:function(e,t,i){"use strict";i.d(t,"c",(function(){return u})),i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return g}));var s=i(28858),n=i(28824),r=i(28857),a=i(28849),o=i(28828),c=i(28829),l=i(28889),h=i(28890);async function u(e,t,i){const s=[e.then(e=>({result:"done",value:e})),t.then(({timerResult:e})=>({result:e}))];return void 0!==i&&s.push(i.waitCancelled.then(()=>({result:"cancelled"}))),Promise.race(s)}const d={submitSummaryFailure:"Error while generating, uploading, or submitting summary",summaryOpWaitTimeout:"Timeout while waiting for summarize op broadcast",summaryAckWaitTimeout:"Timeout while waiting for summaryAck/summaryNack op",summaryNack:"Server rejected summary via summaryNack op",disconnect:"Summary cancelled due to summarizer or main client disconnect"};class m{constructor(){this.summarySubmitted=new s.a,this.summaryOpBroadcasted=new s.a,this.receivedSummaryAckOrNack=new s.a}fail(e,t,i,s){Object(n.a)(!this.receivedSummaryAckOrNack.isCompleted,606);const r={success:!1,message:e,data:void 0,error:t,retryAfterSeconds:s};this.summarySubmitted.resolve(r),this.summaryOpBroadcasted.resolve(r),this.receivedSummaryAckOrNack.resolve(Object.assign(Object.assign({},r),{data:i}))}build(){return{summarySubmitted:this.summarySubmitted.promise,summaryOpBroadcasted:this.summaryOpBroadcasted.promise,receivedSummaryAckOrNack:this.receivedSummaryAckOrNack.promise}}}class g{constructor(e,t,i,s,n,a,o){this.pendingAckTimer=e,this.heuristicData=t,this.submitSummaryCallback=i,this.raiseSummarizingError=s,this.successfulSummaryCallback=n,this.summaryWatcher=a,this.logger=o,this.summarizeTimer=new r.b(2e4,()=>this.summarizeTimerHandler(2e4,1))}summarize(e,t,i,s=new m){return this.summarizeCore(e,t,s,i).catch(t=>{const i="UnexpectedSummarizeError";this.logger.sendErrorEvent(Object.assign({eventName:i},e),t),s.fail(i,t)}),s.build()}async summarizeCore(e,t,i,s){const{refreshLatestAck:r,fullTree:m}=t,g=o.a.create(this.logger,void 0,{all:e});let p={fullTree:m,timeSinceLastAttempt:Date.now()-this.heuristicData.lastAttempt.summaryTime,timeSinceLastSummary:Date.now()-this.heuristicData.lastSuccessfulSummary.summaryTime};const f=o.b.start(g,Object.assign({eventName:"Summarize",refreshLatestAck:r},p)),b=(e,t,n,r)=>{this.raiseSummarizingError(d[e]);const a=Object(l.a)(t),o=s.cancelled||(null==t?void 0:t.errorType)===h.a.offlineError?"generic":"error";f.cancel(Object.assign(Object.assign({},n),{reason:e,category:o,retryAfterSeconds:a}),t),i.fail((e=>`${e}: ${d[e]}`)(e),t,r,a)};let v;this.summarizeTimer.start();try{v=await this.submitSummaryCallback({fullTree:m,refreshLatestAck:r,summaryLogger:g,cancellationToken:s});const e=v.referenceSequenceNumber,t=e-this.heuristicData.lastSuccessfulSummary.refSequenceNumber;if(p=Object.assign(Object.assign({},p),{referenceSequenceNumber:e,minimumSequenceNumber:v.minimumSequenceNumber,opsSinceLastAttempt:e-this.heuristicData.lastAttempt.refSequenceNumber,opsSinceLastSummary:t}),"base"!==v.stage&&(p=Object.assign(Object.assign(Object.assign({},p),v.summaryStats),{generateDuration:v.generateDuration}),"generate"!==v.stage&&(p=Object.assign(Object.assign({},p),{handle:v.handle,uploadDuration:v.uploadDuration}),"upload"!==v.stage&&(p=Object.assign(Object.assign({},p),{clientSequenceNumber:v.clientSequenceNumber})))),"submit"!==v.stage)return b("submitSummaryFailure",v.error,p);if(!m&&!v.forcedFullTree){const{summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:i=0}=v.summaryStats;e>i+t&&g.sendErrorEvent({eventName:"IncrementalSummaryViolation",summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:i,opsSinceLastSummary:t})}f.reportEvent("generate",Object.assign({},p)),i.summarySubmitted.resolve({success:!0,data:v})}catch(S){return b("submitSummaryFailure",S)}finally{this.heuristicData.recordAttempt(null==v?void 0:v.referenceSequenceNumber),this.summarizeTimer.clear()}try{const e=this.pendingAckTimer.start(),t=this.summaryWatcher.watchSummary(v.clientSequenceNumber),r=await u(t.waitBroadcast(),e,s);if("cancelled"===r.result)return b("disconnect");if("done"!==r.result)return b("summaryOpWaitTimeout");const o=r.value,h=Date.now()-this.heuristicData.lastAttempt.summaryTime;i.summaryOpBroadcasted.resolve({success:!0,data:{summarizeOp:o,broadcastDuration:h}}),this.heuristicData.lastAttempt.summarySequenceNumber=o.sequenceNumber,g.sendTelemetryEvent({eventName:"Summarize_Op",duration:h,referenceSequenceNumber:o.referenceSequenceNumber,summarySequenceNumber:o.sequenceNumber,handle:o.contents.handle});const d=await u(t.waitAckNack(),e,s);if("cancelled"===d.result)return b("disconnect");if("done"!==d.result)return b("summaryAckWaitTimeout");const m=d.value;this.pendingAckTimer.clear();const S=Date.now()-this.heuristicData.lastAttempt.summaryTime;if(p=Object.assign({ackWaitDuration:S,ackNackSequenceNumber:m.sequenceNumber,summarySequenceNumber:m.contents.summaryProposal.summarySequenceNumber},p),m.type!==a.a.SummaryAck){Object(n.a)(m.type===a.a.SummaryNack,628);const e=m.contents,t=null==e?void 0:e.message,i=null==e?void 0:e.retryAfter,s=new c.a("Received summaryNack: "+t,{retryAfterSeconds:i});return Object(n.a)(Object(l.a)(s)===i,607),b("summaryNack",s,Object.assign(Object.assign({},p),{nackRetryAfter:i}),{summaryNackOp:m,ackNackDuration:S})}this.heuristicData.markLastAttemptAsSuccessful(),this.successfulSummaryCallback(),f.end(Object.assign(Object.assign({},p),{handle:m.contents.handle})),i.receivedSummaryAckOrNack.resolve({success:!0,data:{summaryAckOp:m,ackNackDuration:S}})}finally{this.pendingAckTimer.clear()}}summarizeTimerHandler(e,t){if(this.logger.sendPerformanceEvent({eventName:"SummarizeTimeout",timeoutTime:e,timeoutCount:t}),t<5){const i=2*e;this.summarizeTimer.start(i,()=>this.summarizeTimerHandler(i,t+1))}}dispose(){this.summarizeTimer.clear()}}},28889:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var s,n,r=i(28890),a=i(28829);!function(e){e[e.Offline=0]="Offline",e[e.Online=1]="Online",e[e.Unknown=2]="Unknown"}(n||(n={}));a.a;class o extends a.a{constructor(e,t){super(e,Object.assign(Object.assign({},t),{statusCode:400})),this.errorType=o.errorType,this.canRetry=!1}}o.errorType=null!==(s=r.a.deltaStreamConnectionForbidden)&&void 0!==s?s:"deltaStreamConnectionForbidden";a.a;a.a;a.a;const c=e=>null==e?void 0:e.retryAfterSeconds},28890:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),function(e){e.genericError="genericError",e.genericNetworkError="genericNetworkError",e.authorizationError="authorizationError",e.fileNotFoundOrAccessDeniedError="fileNotFoundOrAccessDeniedError",e.throttlingError="throttlingError",e.offlineError="offlineError",e.unsupportedClientProtocolVersion="unsupportedClientProtocolVersion",e.writeError="writeError",e.fetchFailure="fetchFailure",e.incorrectServerResponse="incorrectServerResponse",e.fileOverwrittenInStorage="fileOverwrittenInStorage",e.deltaStreamConnectionForbidden="deltaStreamConnectionForbidden",e.locationRedirection="locationRedirection"}(s||(s={}))},28891:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28826);class n extends s.a{async get(){throw Error("Do not try to get a summarizer object from the handle. Reference it directly.")}attach(){}bind(e){}}},28892:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),function(e){e.cache="fluid-cache",e.clientDetails="fluid-client-details",e.loadMode="loadMode",e.reconnect="fluid-reconnect",e.sequenceNumber="fluid-sequence-number",e.version="version"}(s||(s={}))},28893:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),function(e){e.summarizingClient="fluid-client-summarizer",e.createNew="createNew"}(s||(s={}))},28894:function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var s=i(28824),n=i(28857),r=i(28858),a=i(28896),o=i(28836),c=i(28849),l=i(28828),h=i(28895),u=i(28888),d=function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(i[s[n]]=e[s[n]])}return i};class m{constructor(e,t,i,r,a,o,c,d,m){this.summaryWatcher=t,this.configuration=i,this.submitSummaryCallback=r,this.heuristicData=a,this.raiseSummarizingError=o,this.summaryCollection=c,this.cancellationToken=d,this.stopSummarizerCallback=m,this.stopping=!1,this._disposed=!1,this.tryWhileSummarizing=!1,this.summarizeCount=0,this.totalSuccessfulAttempts=0,this.tryGetCorrelatedLogger=e=>this.heuristicData.lastAttempt.refSequenceNumber===e?this.logger:void 0;const g={summarizeCount:()=>this.summarizeCount,summarizerSuccessfulAttempts:()=>this.totalSuccessfulAttempts};this.logger=l.a.create(e,"Running",{all:g}),"disableHeuristics"!==i.state&&(Object(s.a)("enabled"===this.configuration.state,746),this.heuristicRunner=new h.b(a,this.configuration,e=>this.trySummarize(e),this.logger)),Object(s.a)("disabled"!==this.configuration.state,747);const p=Math.min(this.configuration.maxAckWaitTime,6e5);this.pendingAckTimer=new n.a(p,()=>{this.raiseSummarizingError("Pending summary ack not received in time"),this.logger.sendErrorEvent({eventName:"SummaryAckWaitTimeout",maxAckWaitTime:p,referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber,timePending:Date.now()-this.heuristicData.lastAttempt.summaryTime})}),c.setPendingAckTimerTimeoutCallback(p,()=>{this.pendingAckTimer.hasTimer&&(this.logger.sendTelemetryEvent({eventName:"MissingSummaryAckFoundByOps",referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber}),this.pendingAckTimer.clear())}),this.generator=new u.b(this.pendingAckTimer,this.heuristicData,this.submitSummaryCallback,this.raiseSummarizingError,()=>{this.totalSuccessfulAttempts++},this.summaryWatcher,this.logger)}static async start(e,t,i,s,n,r,a,o,c){var l;const h=new m(e,t,i,s,n,r,a,o,c);return await h.waitStart(),null===(l=h.heuristicRunner)||void 0===l||l.run(),h}get disposed(){return this._disposed}dispose(){var e;this.summaryWatcher.dispose(),null===(e=this.heuristicRunner)||void 0===e||e.dispose(),this.heuristicRunner=void 0,this.generator.dispose(),this.pendingAckTimer.clear(),this.disposeEnqueuedSummary(),this._disposed=!0,this.stopping=!0}handleSystemOp(e){switch(e.type){case c.a.ClientLeave:case c.a.ClientJoin:case c.a.Propose:return void this.handleOp(void 0,e);default:return}}handleOp(e,{sequenceNumber:t,type:i,clientId:s,contents:n}){var r;void 0===e&&(this.heuristicData.lastOpSequenceNumber=t,this.tryRunEnqueuedSummary()||null===(r=this.heuristicRunner)||void 0===r||r.run())}async waitStop(e){var t;this.stopping||(this.stopping=!0,this.disposeEnqueuedSummary(),e&&(null===(t=this.heuristicRunner)||void 0===t?void 0:t.shouldRunLastSummary())&&void 0===this.summarizingLock&&this.trySummarizeOnce({reason:"lastSummary"},{}),await this.summarizingLock)}async waitStart(){const e=await Object(u.c)(this.summaryWatcher.waitFlushed(),this.pendingAckTimer.start());this.pendingAckTimer.clear(),this.summaryCollection.unsetPendingAckTimerTimeoutCallback(),"done"===e.result&&void 0!==e.value&&this.heuristicData.updateWithLastSummaryAckInfo({refSequenceNumber:e.value.summaryOp.referenceSequenceNumber,summaryTime:Date.now(),summarySequenceNumber:e.value.summaryOp.sequenceNumber})}async lockedRefreshSummaryAckAction(e){Object(s.a)(void 0===this.refreshSummaryAckLock,"Refresh Summary Ack - Caller is responsible for checking lock");const t=new r.a;return this.refreshSummaryAckLock=t.promise,e().finally(()=>{t.resolve(),this.refreshSummaryAckLock=void 0})}async lockedSummaryAction(e){Object(s.a)(void 0===this.summarizingLock,603);const t=new r.a;return this.summarizingLock=t.promise,this.summarizeCount++,await this.refreshSummaryAckLock,e().finally(()=>{var e;t.resolve(),this.summarizingLock=void 0;const i=this.tryWhileSummarizing;this.tryWhileSummarizing=!1,this.stopping||this.tryRunEnqueuedSummary()||!i||null===(e=this.heuristicRunner)||void 0===e||e.run()})}trySummarizeOnce(e,t,i=this.cancellationToken,s=new u.a){return this.lockedSummaryAction(async()=>this.generator.summarize(e,t,i,s).receivedSummaryAckOrNack).catch(e=>{}),s.build()}trySummarize(e,t=this.cancellationToken){void 0===this.summarizingLock?this.lockedSummaryAction(async()=>{const i=[{refreshLatestAck:!1,fullTree:!1},{refreshLatestAck:!0,fullTree:!1},{refreshLatestAck:!0,fullTree:!1,delaySeconds:120},{refreshLatestAck:!0,fullTree:!0,delaySeconds:600}];let s,n,r=0,o=0;for(let c=0;c<i.length;){if(this.cancellationToken.cancelled)return;if(++r>1&&"lastSummary"===e)return;o++;const l=i[c],{delaySeconds:h=0}=l,u=d(l,["delaySeconds"]),m=null!=s?s:h,g=Object.assign({reason:e,summaryAttempts:r,summaryAttemptsPerPhase:o,summaryAttemptPhase:c+1},u);m>0&&(this.logger.sendPerformanceEvent(Object.assign({eventName:"SummarizeAttemptDelay",duration:m,summaryNackDelay:void 0!==s},g)),await Object(a.a)(1e3*m)),await this.refreshSummaryAckLock;const p=this.generator.summarize(g,u,t),f=await p.receivedSummaryAckOrNack;if(f.success)return;s=f.retryAfterSeconds,(void 0===s||o>1)&&(c++,o=0),n=f}this.logger.sendErrorEvent({eventName:"FailToSummarize",reason:e,message:null==n?void 0:n.message},null==n?void 0:n.error),this.stopSummarizerCallback("failToSummarize")}).catch(e=>{this.logger.sendErrorEvent({eventName:"UnexpectedSummarizeError"},e)}):this.tryWhileSummarizing=!0}summarizeOnDemand(e=new u.a,t){var{reason:i}=t,s=d(t,["reason"]);if(this.stopping)return e.fail("RunningSummarizer stopped or disposed",void 0),e.build();if(void 0!==this.summarizingLock)throw new o.e("Attempted to run an already-running summarizer on demand");return this.trySummarizeOnce({reason:"onDemand/"+i},s,this.cancellationToken,e)}enqueueSummarize(e){var{reason:t,afterSequenceNumber:i=0,override:s=!1}=e,n=d(e,["reason","afterSequenceNumber","override"]);const r="enqueue;"+t;let a=!1;if(void 0!==this.enqueuedSummary){if(!s)return{alreadyEnqueued:!0};this.enqueuedSummary.resultsBuilder.fail("Aborted; overridden by another enqueue summarize attempt",void 0),this.enqueuedSummary=void 0,a=!0}this.enqueuedSummary={reason:r,afterSequenceNumber:i,options:n,resultsBuilder:new u.a};const o=this.enqueuedSummary.resultsBuilder.build();return this.tryRunEnqueuedSummary(),a?Object.assign(Object.assign({},o),{alreadyEnqueued:!0,overridden:!0}):o}tryRunEnqueuedSummary(){if(this.stopping)return this.disposeEnqueuedSummary(),!1;if(void 0===this.enqueuedSummary||this.heuristicData.lastOpSequenceNumber<this.enqueuedSummary.afterSequenceNumber||void 0!==this.summarizingLock)return!1;const{reason:e,resultsBuilder:t,options:i}=this.enqueuedSummary;return this.enqueuedSummary=void 0,this.trySummarizeOnce({reason:"enqueuedSummary/"+e},i,this.cancellationToken,t),!0}disposeEnqueuedSummary(){void 0!==this.enqueuedSummary&&(this.enqueuedSummary.resultsBuilder.fail("RunningSummarizer stopped or disposed",void 0),this.enqueuedSummary=void 0)}}},28895:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r}));var s=i(28857);class n{constructor(e,t){this.lastOpSequenceNumber=e,this._lastAttempt=t,this._lastSuccessfulSummary=Object.assign({},t)}get lastAttempt(){return this._lastAttempt}get lastSuccessfulSummary(){return this._lastSuccessfulSummary}updateWithLastSummaryAckInfo(e){this._lastAttempt=e,this._lastSuccessfulSummary=Object.assign({},e)}recordAttempt(e){this._lastAttempt={refSequenceNumber:null!=e?e:this.lastOpSequenceNumber,summaryTime:Date.now()}}markLastAttemptAsSuccessful(){this._lastSuccessfulSummary=Object.assign({},this.lastAttempt)}}class r{constructor(e,t,i,n){this.heuristicData=e,this.configuration=t,this.trySummarize=i,this.logger=n,this.idleTimer=new s.b(this.configuration.idleTime,()=>this.trySummarize("idle")),this.minOpsForLastSummaryAttempt=this.configuration.minOpsForLastSummaryAttempt}get opsSinceLastAck(){return this.heuristicData.lastOpSequenceNumber-this.heuristicData.lastSuccessfulSummary.refSequenceNumber}run(){const e=Date.now()-this.heuristicData.lastSuccessfulSummary.summaryTime,t=this.opsSinceLastAck;e>this.configuration.maxTime?(this.idleTimer.clear(),this.trySummarize("maxTime")):t>this.configuration.maxOps?(this.idleTimer.clear(),this.trySummarize("maxOps")):this.idleTimer.restart()}shouldRunLastSummary(){const e=this.opsSinceLastAck,t=this.minOpsForLastSummaryAttempt;return this.logger.sendTelemetryEvent({eventName:"ShouldRunLastSummary",opsSinceLastAck:e,minOpsForLastSummaryAttempt:t}),e>=t}dispose(){this.idleTimer.clear()}}},28896:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s=async e=>new Promise(t=>setTimeout(()=>t(),e))},28897:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28858),n=i(28824);new Promise(()=>{});class r{constructor(e){this.runtime=e,this._cancelled=!1,this.stopDeferred=new s.a}get cancelled(){return this._cancelled||Object(n.a)(this.runtime.deltaManager.active,605),this._cancelled}get waitCancelled(){return this.stopDeferred.promise}static async create(e){const t=new r(e);return await t.waitStart(),t}async waitStart(){if(this.runtime.disposed)this.stop("summarizerClientDisconnected");else{if(this.runtime.once("dispose",()=>this.stop("summarizerClientDisconnected")),!this.runtime.connected){const e=new Promise(e=>this.runtime.once("connected",e));await Promise.race([e,this.waitCancelled])}this.runtime.once("disconnected",()=>this.stop("summarizerClientDisconnected"))}}stop(e){this._cancelled||(this._cancelled=!0,this.stopDeferred.resolve(e))}}},28898:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var s=i(28824),n=i(28828),r=i(28890);var a;!function(e){e[e.Off=0]="Off",e[e.Starting=1]="Starting",e[e.Running=2]="Running",e[e.Stopping=3]="Stopping"}(a||(a={}));class o{constructor(e,t,i,s,r,o,{initialDelayMs:c=5e3,opsToBypassInitialDelay:l=4e3}={},h){this.clientElection=e,this.connectedState=t,this.summaryCollection=i,this.requestSummarizerFn=r,this.startThrottler=o,this.disableHeuristics=h,this.state=a.Off,this._disposed=!1,this.handleConnected=e=>{this.latestClientId=e,this.refreshSummarizer()},this.handleDisconnected=()=>{this.refreshSummarizer()},this.refreshSummarizer=()=>{const e=this.getShouldSummarizeState();switch(this.state){case a.Off:return void(e.shouldSummarize&&this.startSummarization());case a.Starting:return;case a.Running:return void(!1===e.shouldSummarize&&this.stop(e.stopReason));case a.Stopping:default:return}},this.summarizeOnDemand=(...e)=>{if(void 0===this.summarizer)throw Error("No running summarizer client");return this.summarizer.summarizeOnDemand(...e)},this.enqueueSummarize=(...e)=>{if(void 0===this.summarizer)throw Error("No running summarizer client");return this.summarizer.enqueueSummarize(...e)},this.logger=n.a.create(s,"SummaryManager",{all:{clientId:()=>this.latestClientId}}),this.connectedState.on("connected",this.handleConnected),this.connectedState.on("disconnected",this.handleDisconnected),this.latestClientId=this.connectedState.clientId,this.opsToBypassInitialDelay=l,this.initialDelayMs=c}get disposed(){return this._disposed}get currentState(){return this.state}start(){this.clientElection.on("electedSummarizerChanged",this.refreshSummarizer),this.refreshSummarizer()}getShouldSummarizeState(){return this.connectedState.clientId!==this.clientElection.electedParentId||this.state!==a.Running&&this.connectedState.clientId!==this.clientElection.electedClientId?{shouldSummarize:!1,stopReason:"parentShouldNotSummarize"}:this.connectedState.connected?this.disposed?void Object(s.a)(!1,608):{shouldSummarize:!0}:{shouldSummarize:!1,stopReason:"parentNotConnected"}}startSummarization(){Object(s.a)(this.state===a.Off,609),this.state=a.Starting,Object(s.a)(void 0===this.summarizer,610),this.delayBeforeCreatingSummarizer().then(async e=>{if(e&&!1===this.getShouldSummarizeState().shouldSummarize)return"early exit";Object(s.a)(this.state===a.Starting,611),this.state=a.Running;const t=await this.requestSummarizerFn();this.summarizer=t;const i=this.getShouldSummarizeState();if(!1===i.shouldSummarize)return this.state=a.Starting,t.stop(i.stopReason),"early exit after starting summarizer";const r=this.latestClientId;return n.b.timedExecAsync(this.logger,{eventName:"RunningSummarizer",attempt:this.startThrottler.numAttempts},async()=>t.run(r,this.disableHeuristics))}).then(e=>{this.logger.sendTelemetryEvent({eventName:"EndingSummarizer",reason:e})}).catch(e=>{if(this.logger.sendTelemetryEvent({eventName:"EndingSummarizer",reason:"exception"},e),this.getShouldSummarizeState().shouldSummarize||void 0!==this.summarizer){const t=(null==e?void 0:e.errorType)===r.a.offlineError?"generic":"error";this.logger.sendTelemetryEvent({eventName:"SummarizerException",category:t},e)}}).finally(()=>{var e;Object(s.a)(this.state!==a.Off,612),this.state=a.Off,null===(e=this.summarizer)||void 0===e||e.close(),this.summarizer=void 0,this.getShouldSummarizeState().shouldSummarize&&this.startSummarization()})}stop(e){var t;o.isStartingOrRunning(this.state)&&(this.state=a.Stopping,null===(t=this.summarizer)||void 0===t||t.stop(e))}async delayBeforeCreatingSummarizer(){let e=this.startThrottler.getDelay();this.logger.sendTelemetryEvent({eventName:"CreatingSummarizer",throttlerDelay:e,initialDelay:this.initialDelayMs,startThrottlerMaxDelayMs:this.startThrottler.maxDelayMs,opsSinceLastAck:this.summaryCollection.opsSinceLastAck,opsToBypassInitialDelay:this.opsToBypassInitialDelay});let t=!1;if(this.summaryCollection.opsSinceLastAck<this.opsToBypassInitialDelay&&(t=!0,e=Math.max(e,this.initialDelayMs)),e>0){let t,i;const s=()=>{this.summaryCollection.opsSinceLastAck>=this.opsToBypassInitialDelay&&(clearTimeout(t),i())},n=new Promise(i=>{t=setTimeout(()=>i(),e)}),r=new Promise(e=>{i=e});this.summaryCollection.addOpListener(s),await Promise.race([n,r]),this.summaryCollection.removeOpListener(s)}return t}dispose(){this.clientElection.off("electedSummarizerChanged",this.refreshSummarizer),this.connectedState.off("connected",this.handleConnected),this.connectedState.off("disconnected",this.handleDisconnected),this._disposed=!0}}o.isStartingOrRunning=e=>e===a.Starting||e===a.Running},28899:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));class s{constructor(e,t,i){this.delayWindowMs=e,this.maxDelayMs=t,this.delayFn=i,this.startTimes=[]}get numAttempts(){return this.startTimes.length}getAttempts(){return[...this.startTimes]}get latestAttemptTime(){return this.startTimes.length>0?this.startTimes[this.startTimes.length-1]:void 0}getDelay(){const e=Date.now(),t=this.latestAttemptTime;if(void 0!==t){const i=t-e;i>0&&(this.startTimes=this.startTimes.map(e=>e-i))}this.startTimes=this.startTimes.filter(t=>e-t<this.delayWindowMs);const i=Math.min(this.delayFn(this.startTimes.length),this.maxDelayMs);return this.startTimes.push(e),this.startTimes=this.startTimes.map(e=>e+i),i===this.maxDelayMs&&this.startTimes.shift(),i}}const n=({multiplier:e=2,coefficient:t=1,offset:i=0,initialDelay:s}={})=>n=>Math.max(0,n<=0&&void 0!==s?s:t*Math.pow(e,n)+i)},28900:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var s=i(28834),n=i(28824),r=i(28828);class a{constructor(e,t,i,a,o=(()=>s.a.now())){this.batchEventEmitter=e,this.trackedBatchCount=0,this.logger=r.a.create(t,"Batching"),this.batchEventEmitter.on("batchBegin",e=>{this.startBatchSequenceNumber=e.sequenceNumber,this.batchProcessingStartTimeStamp=o(),this.trackedBatchCount++}),this.batchEventEmitter.on("batchEnd",(e,t)=>{Object(n.a)(void 0!==this.startBatchSequenceNumber&&void 0!==this.batchProcessingStartTimeStamp,698);const s=t.sequenceNumber-this.startBatchSequenceNumber+1;s>=i&&this.logger.sendErrorEvent({eventName:"LengthTooBig",length:s,threshold:i,batchEndSequenceNumber:t.sequenceNumber,duration:o()-this.batchProcessingStartTimeStamp,batchError:void 0!==e}),this.trackedBatchCount%a==0&&this.logger.sendPerformanceEvent({eventName:"Length",length:s,samplingRate:a,batchEndSequenceNumber:t.sequenceNumber,duration:o()-this.batchProcessingStartTimeStamp}),this.startBatchSequenceNumber=void 0,this.batchProcessingStartTimeStamp=void 0})}}const o=(e,t,i=1e3,s=1e3)=>new a(e,t,i,s)},28901:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28850);class n{constructor(e,t){this.messageSize=new Map,this._nonSystemOpCount=0,this._opsSizeAccumulator=0,t||(e.inbound.on("push",e=>{var t;const i="string"==typeof e.contents?e.contents:null!==(t=JSON.stringify(e.contents))&&void 0!==t?t:"",s=n.messageHasData(e)?e.data:"";this.messageSize[n.messageId(e)]=i.length+s.length}),e.on("op",e=>{var t;this._nonSystemOpCount+=Object(s.a)(e)?1:0;const i=n.messageId(e);this._opsSizeAccumulator+=null!==(t=this.messageSize[i])&&void 0!==t?t:0,this.messageSize.delete(i)}))}get nonSystemOpCount(){return this._nonSystemOpCount}get opsSizeAccumulator(){return this._opsSizeAccumulator}static messageId(e){return e.sequenceNumber}static messageHasData(e){return void 0!==e.data}reset(){this._nonSystemOpCount=0,this._opsSizeAccumulator=0}}},28902:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28862),n=i(28824);class r{constructor(e,t){this.storageGetter=e,this.blobs=t}static async serializeTree(e,t){const i={};return await this.serializeTreeCore(e,i,t),i}static async serializeTreeCore(e,t,i){const n=[];for(const s of Object.values(e.trees))n.push(this.serializeTreeCore(s,t,i));for(const r of Object.values(e.blobs)){const e=await i.readBlob(r);t[r]=Object(s.c)(e,"utf8")}return Promise.all(n)}static serializeTreeWithBlobContents(e){const t={};return this.serializeTreeWithBlobContentsCore(e,t),t}static serializeTreeWithBlobContentsCore(e,t){for(const i of Object.values(e.trees))this.serializeTreeWithBlobContentsCore(i,t);for(const i of Object.values(e.blobs)){const r=e.blobsContents[i];Object(n.a)(!!r,748),t[i]=Object(s.c)(r,"utf8")}}get storage(){return this._storage||(this._storage=this.storageGetter()),this._storage}get repositoryUrl(){return this.storage.repositoryUrl}async readBlob(e){return void 0!==this.blobs[e]?Object(s.d)(this.blobs[e],"utf8"):this.storage.readBlob(e)}async getSnapshotTree(e){return this.storage.getSnapshotTree(e)}async getVersions(e,t){return this.storage.getVersions(e,t)}async createBlob(e){return this.storage.createBlob(e)}async uploadSummaryWithContext(e,t){return this.storage.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this.storage.downloadSummary(e)}}},28903:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28836);class n{constructor(e){this.map=new Map;for(const t of e){if(this.map.has(t[0]))throw new s.e("Duplicate entry names exist");this.map.set(t[0],t[1])}}get IFluidDataStoreRegistry(){return this}async get(e){if(this.map.has(e))return this.map.get(e)}}},28904:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(e){this.request=e;const t=this.request.url.indexOf("?");this.query=t>=0?this.request.url.substring(t):""}static getPathParts(e){const t=e.indexOf("?");return e.substring(0,t<0?e.length:t).split("/").reduce((e,t)=>(void 0!==t&&t.length>0&&e.push(decodeURIComponent(t)),e),[])}static create(e){return e instanceof s?e:new s(e)}get url(){return this.request.url}get headers(){return this.request.headers}get pathParts(){return void 0===this.requestPathParts&&(this.requestPathParts=s.getPathParts(this.url)),this.requestPathParts}isLeaf(e){return""===this.query&&this.pathParts.length===e}createSubRequest(e){const t=this.pathParts.length;if(e<0||e>t)throw new Error("incorrect sub-request");if(e===t&&this.url.includes("?"))return{url:"/"+this.query,headers:this.headers};const i="/"+this.pathParts.slice(e).join("/");return{url:""===this.query?i:`${i}/${this.query}`,headers:this.headers}}}},28905:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));function s(e,t,i,s){try{i?t.emit("connected",s):t.emit("disconnected")}catch(n){e.sendErrorEvent({eventName:"RaiseConnectedEventError"},n)}}},28906:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28834);class n{constructor(e){this.startTick=e,this.lastTick=e}static start(){const e=s.a.now();return new n(e)}trace(){const e=s.a.now(),t={totalTimeElapsed:e-this.startTick,duration:e-this.lastTick,tick:e};return this.lastTick=e,t}}},28907:function(e,t,i){"use strict";async function s(e,t){const i=e.trees[".protocol"].blobs.attributes;return(await t(i)).sequenceNumber}i.d(t,"a",(function(){return s}))},28908:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28839);class n extends s.a{constructor(){super(...arguments),this.serializedRoutes=new Set}getSerializedRoutes(){return Array.from(this.serializedRoutes)}serializeHandle(e,t){return this.serializedRoutes.add(e.absolutePath),super.serializeHandle(e,t)}}},28909:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var s=i(28911),n=i(28824),r=i(28910);function a(e){return void 0!==e&&"number"==typeof e.pendingMessageId&&("add"===e.type||"edit"===e.type)}function o(e){return void 0!==e&&"clear"===e.type&&"number"==typeof e.pendingMessageId}class c{constructor(e,t,i,s,n){this.serializer=e,this.handle=t,this.submitMessage=i,this.isAttached=s,this.eventEmitter=n,this.messageHandlers=new Map,this.data=new Map,this.pendingKeys=new Map,this.pendingMessageId=-1,this.pendingClearMessageIds=[],this.localValueMaker=new r.a(e),this.messageHandlers=this.getMessageHandlers()}get size(){return this.data.size}keys(){return this.data.keys()}entries(){const e=this.data.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}values(){const e=this.data.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}[Symbol.iterator](){return this.entries()}forEach(e){this.data.forEach((t,i,s)=>{e(t.value,i,s)})}get(e){const t=this.data.get(e);return void 0===t?void 0:t.value}has(e){return this.data.has(e)}set(e,t){if(null==e)throw new Error("Undefined and null keys are not supported");const i=this.localValueMaker.fromInMemory(t),s=Object(r.b)(i,this.serializer,this.handle),n=this.setCore(e,i,!0);if(!this.isAttached())return;const a={key:e,type:"set",value:s};this.submitMapKeyMessage(a,n)}delete(e){const t=this.deleteCore(e,!0);if(!this.isAttached())return void 0!==t;const i={key:e,type:"delete"};return this.submitMapKeyMessage(i,t),void 0!==t}clear(){const e=this.isAttached()?new Map(this.data):void 0;if(this.clearCore(!0),!this.isAttached())return;this.submitMapClearMessage({type:"clear"},e)}getSerializedStorage(e){const t={};return this.data.forEach((i,s)=>{t[s]=i.makeSerialized(e,this.handle)}),t}getSerializableStorage(e){const t={};return this.data.forEach((i,s)=>{t[s]=Object(r.b)(i,e,this.handle)}),t}serialize(e){return JSON.stringify(this.getSerializableStorage(e))}populateFromSerializable(e){for(const[t,i]of Object.entries(e)){const e={key:t,value:this.makeLocal(t,i)};this.data.set(e.key,e.value)}}populate(e){this.populateFromSerializable(JSON.parse(e))}trySubmitMessage(e,t){const i=this.messageHandlers.get(e.type);return void 0!==i&&(i.submit(e,t),!0)}tryGetStashedOpLocalMetadata(e){const t=this.messageHandlers.get(e.type);if(void 0===t)throw new Error("no apply stashed op handler");return t.getStashedOpLocalMetadata(e)}tryProcessMessage(e,t,i){const s=this.messageHandlers.get(e.type);return void 0!==s&&(s.process(e,t,i),!0)}rollback(e,t){if(void 0===(i=t)||"number"!=typeof i.pendingMessageId||"add"!==i.type&&"edit"!==i.type&&"clear"!==i.type)throw new Error("Invalid localOpMetadata");var i;if("clear"===e.type&&"clear"===t.type){if(void 0===t.previousMap)throw new Error("Cannot rollback without previous map");t.previousMap.forEach((e,t)=>{this.setCore(t,e,!0)});const e=this.pendingClearMessageIds.pop();if(void 0===e||e!==t.pendingMessageId)throw new Error("Rollback op does match last clear")}else{if("delete"!==e.type&&"set"!==e.type)throw new Error("Unsupported op for rollback");{if("add"===t.type)this.deleteCore(e.key,!0);else{if("edit"!==t.type||void 0===t.previousValue)throw new Error("Cannot rollback without previous value");this.setCore(e.key,t.previousValue,!0)}const i=this.pendingKeys.get(e.key),s=null==i?void 0:i.pop();if(!i||s!==t.pendingMessageId)throw new Error("Rollback op does not match last pending");0===i.length&&this.pendingKeys.delete(e.key)}}}setCore(e,t,i){const s=this.data.get(e),n=null==s?void 0:s.value;return this.data.set(e,t),this.eventEmitter.emit("valueChanged",{key:e,previousValue:n},i,this.eventEmitter),s}clearCore(e){this.data.clear(),this.eventEmitter.emit("clear",e,this.eventEmitter)}deleteCore(e,t){const i=this.data.get(e),s=null==i?void 0:i.value;return this.data.delete(e)&&this.eventEmitter.emit("valueChanged",{key:e,previousValue:s},t,this.eventEmitter),i}clearExceptPendingKeys(){const e=new Map;this.pendingKeys.forEach((t,i)=>{e.set(i,this.data.get(i))}),this.clearCore(!1),e.forEach((e,t)=>{this.setCore(t,e,!0)})}makeLocal(e,t){if(t.type===s.a[s.a.Plain]||t.type===s.a[s.a.Shared])return this.localValueMaker.fromSerializable(t);throw new Error("Unknown local value type")}needProcessKeyOperation(e,t,i){if(this.pendingClearMessageIds.length>0)return t&&Object(n.a)(void 0!==i&&a(i)&&i.pendingMessageId<this.pendingClearMessageIds[0],19),!1;if(void 0!==this.pendingKeys.get(e.key)){if(t){Object(n.a)(void 0!==i&&a(i),20);const t=this.pendingKeys.get(e.key);Object(n.a)(void 0!==t&&t[0]===i.pendingMessageId,762),t.shift(),0===t.length&&this.pendingKeys.delete(e.key)}return!1}return!t}getMessageHandlers(){const e=new Map;return e.set("clear",{process:(e,t,i)=>{if(t){Object(n.a)(o(i),21);const e=this.pendingClearMessageIds.shift();Object(n.a)(e===i.pendingMessageId,763)}else 0===this.pendingKeys.size?this.clearCore(t):this.clearExceptPendingKeys()},submit:(e,t)=>{Object(n.a)(o(t),764);const i=this.pendingClearMessageIds.shift();Object(n.a)(i===t.pendingMessageId,765),this.submitMapClearMessage(e,t.previousMap)},getStashedOpLocalMetadata:e=>({type:"clear",pendingMessageId:this.getMapClearMessageId()})}),e.set("delete",{process:(e,t,i)=>{this.needProcessKeyOperation(e,t,i)&&this.deleteCore(e.key,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},getStashedOpLocalMetadata:e=>({type:"edit",pendingMessageId:this.getMapKeyMessageId(e)})}),e.set("set",{process:(e,t,i)=>{if(!this.needProcessKeyOperation(e,t,i))return;const s=this.makeLocal(e.key,e.value);this.setCore(e.key,s,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},getStashedOpLocalMetadata:e=>({type:"edit",pendingMessageId:this.getMapKeyMessageId(e)})}),e}getMapClearMessageId(){const e=++this.pendingMessageId;return this.pendingClearMessageIds.push(e),e}submitMapClearMessage(e,t){const i={type:"clear",pendingMessageId:this.getMapClearMessageId(),previousMap:t};this.submitMessage(e,i)}getMapKeyMessageId(e){const t=++this.pendingMessageId,i=this.pendingKeys.get(e.key);return void 0!==i?i.push(t):this.pendingKeys.set(e.key,[t]),t}submitMapKeyMessage(e,t){const i=this.getMapKeyMessageId(e),s=t?{type:"edit",pendingMessageId:i,previousValue:t}:{type:"add",pendingMessageId:i};this.submitMessage(e,s)}resubmitMapKeyMessage(e,t){Object(n.a)(a(t),766);const i=this.pendingKeys.get(e.key);Object(n.a)(void 0!==i&&i[0]===t.pendingMessageId,767),i.shift(),0===i.length&&this.pendingKeys.delete(e.key);const s=this.getMapKeyMessageId(e),r="edit"===t.type?{type:"edit",pendingMessageId:s,previousValue:t.previousValue}:{type:"add",pendingMessageId:s};this.submitMessage(e,r)}}},28910:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return o}));var s=i(28911),n=i(28912);function r(e,t,i){const s=e.makeSerialized(t,i);return{type:s.type,value:s.value&&JSON.parse(s.value)}}class a{constructor(e){this.value=e}get type(){return s.a[s.a.Plain]}makeSerialized(e,t){const i=Object(n.d)(this.value,e,t);return{type:this.type,value:i}}}class o{constructor(e){this.serializer=e}fromSerializable(e){if(e.type===s.a[s.a.Shared]){e.type=s.a[s.a.Plain];const t={type:"__fluid_handle__",url:e.value};e.value=t}const t=Object(n.c)(e.value,this.serializer);return new a(t)}fromInMemory(e){return new a(e)}}},28911:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),function(e){e[e.Shared=0]="Shared",e[e.Plain=1]="Plain"}(s||(s={}))},28912:function(e,t,i){"use strict";i.d(t,"d",(function(){return n})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return a})),i.d(t,"a",(function(){return o}));var s=i(28870);function n(e,t,i){return void 0!==e?t.stringify(e,i):e}function r(e,t,i){return t.encode(e,i)}function a(e,t){return void 0!==e?t.parse(JSON.stringify(e)):e}function o(e,t){const i=new s.a;return i.addBlob(e,t),i.getSummaryTree()}},28913:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28941),n=i(28914);class r extends n.a{constructor(e,t,i){super(e,t,i,s.b.segmentFromSpec),this.id=t}static create(e,t){return e.createChannel(t,s.b.Type)}static getFactory(){return new s.b}getRange(e,t){return this.getItems(e,t)}}},28914:function(e,t,i){"use strict";i.d(t,"b",(function(){return a})),i.d(t,"a",(function(){return o}));var s=i(28915),n=i(28926),r=i(28928);class a extends s.a{constructor(e){super(),this.items=e,this.type=a.typeString,this.cachedLength=e.length}static is(e){return e.type===a.typeString}static fromJSONObject(e){if(e&&"object"==typeof e&&"items"in e){const t=new a(e.items);return e.props&&t.addProperties(e.props),t}}toJSONObject(){const e={items:this.items};return super.addSerializedProps(e),e}clone(e=0,t){const i=this.items.slice(e,t),s=new a(i);return this.cloneInto(s),s}canAppend(e){return a.is(e)&&(this.cachedLength<=128||e.cachedLength<=128)}toString(){return this.items.toString()}append(e){if(!a.is(e))throw new Error("can only append another run segment");n.b.append(this,e),this.items=this.items.concat(e.items),this.cachedLength=this.items.length}removeRange(e,t){let i=[];const s=this.items.length;return e>0&&(i=i.concat(this.items.slice(0,e))),t<s&&(i=i.concat(this.items.slice(t))),this.items=i,this.cachedLength=this.items.length,0===this.items.length}createSplitSegmentAt(e){if(e>0){const t=this.items.slice(e);this.items=this.items.slice(0,e),this.cachedLength=this.items.length;return new a(t)}}}a.typeString="SubSequence";class o extends r.a{constructor(e,t,i,s){super(e,t,i,s),this.id=t}insert(e,t,i){const s=new a(t);i&&s.addProperties(i);const n=this.client.insertSegmentLocal(e,s);n&&this.submitSequenceMessage(n)}remove(e,t){this.removeRange(e,t)}getItemCount(){return this.getLength()}getItems(e,t){const i=[];let s;return void 0!==t&&t<=e||(this.walkSegments(e=>(a.is(e)&&(void 0===s&&(s=e),i.push(...e.items)),!0),e,t),void 0!==s&&i.splice(0,e-this.getPosition(s)),void 0!==t&&i.splice(t-e)),i}}},28915:function(e,t,i){"use strict";i.d(t,"f",(function(){return f})),i.d(t,"a",(function(){return k})),i.d(t,"b",(function(){return N})),i.d(t,"d",(function(){return I})),i.d(t,"e",(function(){return j})),i.d(t,"c",(function(){return F}));var s=i(28824),n=i(28836),r=i(28919),a=i(28916),o=i(28926),c=i(28925),l=i(28922),h=i(28918),u=i(28927),d=i(28920),m=i(28917),g=i(28921),p=i(28924);function f(e){if(void 0!==(null==e?void 0:e.removedClientIds)&&void 0!==(null==e?void 0:e.removedSeq))return e;Object(s.a)(void 0===(null==e?void 0:e.removedClientIds)&&void 0===(null==e?void 0:e.removedSeq),703)}function b(e){const t=f(e);return void 0!==t&&t.removedSeq!==a.d}class v{constructor(){this.index=0,this.ordinal="",this.cachedLength=0}isLeaf(){return!1}}function S(e,t){const i=Object(m.e)(e);if(i)for(const s of i)t[s]=e}function y(e,t){const i=Object(m.e)(e);if(i)for(const s of i)void 0===t[s]&&(t[s]=e)}function C(e,t){for(const i in t){const s=t[i];if(!s.empty()){let t=e[i];void 0===t&&(t=new r.f,e[i]=t);for(const e of s.items)O(t,e)}}}function O(e,t){if(Object(m.j)(t,h.b.NestBegin))return e.push(t),!0;{const i=e.top();return i&&Object(m.j)(i,h.b.NestBegin)?e.pop():e.push(t),!1}}class w extends v{constructor(e){super(),this.childCount=e,this.children=new Array(8)}hierBlock(){}setOrdinal(e,t){let i,n=this.childCount;8===n&&(n=7),Object(s.a)(n>=1&&n<=7,64);const r=1<<8-(n+1);if(0===t)i=r-1;else{const e=this.children[t-1].ordinal;i=e.charCodeAt(e.length-1)+r}e.ordinal=this.ordinal+String.fromCharCode(i),Object(s.a)(e.ordinal.length===this.ordinal.length+1,65),t>0&&Object(s.a)(e.ordinal>this.children[t-1].ordinal,66)}assignChild(e,t,i=!0){e.parent=this,e.index=t,i&&this.setOrdinal(e,t),this.children[t]=e}}class T extends w{constructor(e){super(e),this.rightmostTiles=Object(d.d)(),this.leftmostTiles=Object(d.d)(),this.rangeStacks=Object(d.d)()}addNodeReferences(e,t){!function(e,t,i,s,n){var a;function o(e,t){let i=n[e];void 0===i&&(i=new r.f,n[e]=i),O(i,t)}if(t.isLeaf()){const n=t;if((null!==(a=e.localNetLength(n))&&void 0!==a?a:0)>0)if(N.is(n)){const t=n.getId();if(t&&e.mapIdToSegment(t,n),Object(m.j)(n,h.b.Tile)&&(S(n,i),y(n,s)),n.refType&(h.b.NestBegin|h.b.NestEnd)){const e=Object(m.d)(n);if(e)for(const t of e)o(t,n)}}else{const e=t;if(e.localRefs&&void 0!==e.localRefs.hierRefCount&&e.localRefs.hierRefCount>0)for(const t of e.localRefs)if(Object(m.j)(t,h.b.Tile)&&(S(t,i),y(t,s)),t.refType&(h.b.NestBegin|h.b.NestEnd))for(const e of Object(m.d)(t))o(e,t)}}else{const e=t;C(n,e.rangeStacks),Object(d.e)(i,e.rightmostTiles),Object(d.f)(s,e.leftmostTiles)}}(e,t,this.rightmostTiles,this.leftmostTiles,this.rangeStacks)}hierBlock(){return this}hierToString(e){let t="";for(const i in this.rangeStacks){const s=this.rangeStacks[i];t+=M(e),t+=i+": ";for(const e of s.items)t+=e.toString()+" ";t+="\n"}return t}}class k extends v{constructor(){super(...arguments),this.clientId=a.a,this.seq=a.e,this.segmentGroups=new g.a(this),this.trackingCollection=new l.a(this)}addProperties(e,t,i,s){return this.propertyManager||(this.propertyManager=new p.a),this.properties||(this.properties=Object(d.d)()),this.propertyManager.addProperties(this.properties,e,t,i,s&&s.collaborating)}hasProperty(e){return!!this.properties&&void 0!==this.properties[e]}isLeaf(){return!0}cloneInto(e){var t;e.clientId=this.clientId,e.properties=Object(d.b)(this.properties),e.removedClientIds=null===(t=this.removedClientIds)||void 0===t?void 0:t.slice(),e.removedSeq=this.removedSeq,e.seq=this.seq}canAppend(e){return!1}addSerializedProps(e){this.properties&&(e.props=this.properties)}ack(e,t,i){const n=this.segmentGroups.dequeue();switch(Object(s.a)(n===e,67),t.op.type){case h.a.ANNOTATE:return Object(s.a)(!!this.propertyManager,68),this.propertyManager.ackPendingProperties(t.op),!0;case h.a.INSERT:return Object(s.a)(this.seq===a.d,69),this.seq=t.sequencedMessage.sequenceNumber,this.localSeq=void 0,!0;case h.a.REMOVE:const e=f(this);return Object(s.a)(void 0!==e,70),this.localRemovedSeq=void 0,e.removedSeq===a.d&&(e.removedSeq=t.sequencedMessage.sequenceNumber,!0);default:throw new Error(t.op.type+" is in unrecognized operation type")}}splitAt(e){var t;if(e>0){const i=this.createSplitSegmentAt(e);return i&&(this.copyPropertiesTo(i),i.parent=this.parent,i.ordinal=this.ordinal+String.fromCharCode(0),i.removedClientIds=null===(t=this.removedClientIds)||void 0===t?void 0:t.slice(),i.removedSeq=this.removedSeq,i.localRemovedSeq=this.localRemovedSeq,i.seq=this.seq,i.localSeq=this.localSeq,i.clientId=this.clientId,this.segmentGroups.copyTo(i),this.trackingCollection.copyTo(i),this.localRefs&&this.localRefs.split(e,i)),i}}copyPropertiesTo(e){this.propertyManager&&this.properties&&(e.propertyManager=new p.a,e.properties=this.propertyManager.copyTo(this.properties,e.properties,e.propertyManager))}}class N extends k{constructor(e){super(),this.refType=e,this.type=N.type,this.cachedLength=1}static is(e){return e.type===N.type}static make(e,t){const i=new N(e);return t&&i.addProperties(t),i}toJSONObject(){const e={marker:{refType:this.refType}};return super.addSerializedProps(e),e}static fromJSONObject(e){if(e&&"object"==typeof e&&"marker"in e)return N.make(e.marker.refType,e.props)}clone(){const e=N.make(this.refType,this.properties);return this.cloneInto(e),e}getSegment(){return this}getOffset(){return 0}hasSimpleType(e){return!!this.properties&&this.properties.markerSimpleType===e}getProperties(){return this.properties}getId(){if(this.properties&&this.properties.markerId)return this.properties.markerId}hasTileLabels(){return Object(m.i)(this)}hasRangeLabels(){return Object(m.g)(this)}hasTileLabel(e){return Object(m.h)(this,e)}hasRangeLabel(e){return Object(m.f)(this,e)}getTileLabels(){return Object(m.e)(this)}getRangeLabels(){return Object(m.d)(this)}toString(){let e="";Object(m.j)(this,h.b.Tile)&&(e+="Tile"),Object(m.j)(this,h.b.NestBegin)&&(e.length>0&&(e+="; "),e+="RangeBegin"),Object(m.j)(this,h.b.NestEnd)&&(e.length>0&&(e+="; "),e+="RangeEnd");let t="";const i=this.getId();i&&(e+=` (${i}) `);const s=Object(m.e)(this);if(s){t+="tile -- ";for(let e=0,i=s.length;e<i;e++){e>0&&(t+="; "),t+=s[e]}}const n=Object(m.d)(this);if(n){let e="begin";Object(m.j)(this,h.b.NestEnd)&&(e="end"),s&&(t+=" "),t+=`range ${e} -- `;const i=n;for(let s=0,n=i.length;s<n;s++){s>0&&(t+="; "),t+=i[s]}}let r="";return this.properties&&(r+=JSON.stringify(this.properties,(e,t)=>{const i=!!t&&t.IFluidHandle;return i?`#Handle(${i.routeContext.path}/${i.path})`:t})),`M ${e}: ${t} ${r}`}createSplitSegmentAt(e){}canAppend(e){return!1}append(){throw new Error("Can not append to marker")}}var q;N.type="Marker",function(e){e[e.Go=0]="Go",e[e.Stop=1]="Stop",e[e.Yield=2]="Yield"}(q||(q={}));class R{constructor(e,t,i,s,n,r,a,o,c=0){this.block=e,this.actions=t,this.pos=i,this.refSeq=s,this.clientId=n,this.context=r,this.start=a,this.end=o,this.childIndex=c,this.op=q.Go}}class P{constructor(){this.clientId=a.a,this.collaborating=!1,this.minSeq=0,this.currentSeq=0,this.localSeq=0}loadFrom(e){this.clientId=e.clientId,this.collaborating=e.collaborating,this.minSeq=e.minSeq,this.currentSeq=e.currentSeq}}const I=(e,t)=>e-t,j=(e,t)=>e.localeCompare(t),L=[""," ","  "];function M(e){if(void 0===L[e]){L[e]="";for(let t=0;t<e;t++)L[e]+=" "}return L[e]}const E={min:{maxSeq:-2},compare:(e,t)=>e.maxSeq-t.maxSeq};function A(e,t){for(const i of t.rangeLabels)if(Object(m.f)(e,i)){let s=t.stacks[i];void 0===s&&(s=new r.f,t.stacks[i]=s),O(s,e)}}function x(e,t,i,s,n,r,a){return N.is(e)&&e.refType&(h.b.NestBegin|h.b.NestEnd)&&A(e,a),!1}function z(e,t,i,s,n,r,a){var o;if(e.isLeaf()){const t=e;(null!==(o=a.mergeTree.localNetLength(t))&&void 0!==o?o:0)>0&&N.is(t)&&t.refType&(h.b.NestBegin|h.b.NestEnd)&&A(t,a)}else{const t=e;C(a.stacks,t.rangeStacks)}return!0}function D(e,t,i,s,n,r,a){return N.is(e)&&Object(m.h)(e,a.tileLabel)&&(a.tile=e),!1}function B(e,t,i,s,n,r,a){if(e.isLeaf()){const t=e;a.mergeTree.localNetLength(t)>0&&N.is(t)&&Object(m.h)(t,a.tileLabel)&&(a.tile=t)}else{const t=e;let i;i=a.posPrecedesTile?t.rightmostTiles[a.tileLabel]:t.leftmostTiles[a.tileLabel],void 0!==i&&(a.tile=i)}return!0}const _={min:{minRequired:Number.MIN_VALUE,onMinGE:()=>{Object(s.a)(!1,72)}},compare:(e,t)=>e.minRequired-t.minRequired};class F{constructor(e){this.options=e,this.blockUpdateActions=F.initBlockUpdateActions,this.collabWindow=new P,this.idToSegment=new Map,this.splitLeafSegment=(e,t)=>{if(!(t>0&&e))return{};const i=e.splitAt(t);return this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({operation:c.a.SPLIT,deltaSegments:[{segment:e},{segment:i}]},void 0),{next:i}},this.root=this.makeBlock(0)}makeBlock(e){const t=new T(e);return t.ordinal="",t}clone(){const e=new F(this.options);e.root=e.blockClone(this.root)}blockClone(e,t){const i=this.makeBlock(e.childCount);for(let s=0;s<e.childCount;s++){const n=e.children[s];if(n.isLeaf()){const e=this.segmentClone(n);i.assignChild(e,s),t&&t.push(e)}else i.assignChild(this.blockClone(n,t),s)}return this.nodeUpdateLengthNewStructure(i),this.nodeUpdateOrdinals(i),i}segmentClone(e){return e.clone()}localNetLength(e){return void 0!==f(e)?0:e.cachedLength}mapIdToSegment(e,t){this.idToSegment.set(e,t)}addNode(e,t){const i=e.childCount++;return e.assignChild(t,i,!1),i}reloadFromSegments(e){Object(s.a)(!this.collabWindow.collaborating,73);const t=e=>{const i=Math.ceil(e.length/7),s=new Array(i);for(let t=0,n=0;n<i;n++){const i=s[n]=this.makeBlock(0);for(let s=0;s<7&&t<e.length;s++,t++)this.addNode(i,e[t]);this.blockUpdate(i)}return 1===s.length?s[0]:t(s)};e.length>0?(this.root=t(e),this.nodeUpdateOrdinals(this.root)):this.root=this.makeBlock(0)}startCollaboration(e,t,i){this.collabWindow.clientId=e,this.collabWindow.minSeq=t,this.collabWindow.collaborating=!0,this.collabWindow.currentSeq=i,this.segmentsToScour=new r.a([],E),this.pendingSegments=Object(r.c)(),this.nodeUpdateLengthNewStructure(this.root,!0)}addToLRUSet(e,t){!0!==e.parent.needsScour&&t>this.collabWindow.currentSeq&&(e.parent.needsScour=!0,this.segmentsToScour.add({segment:e,maxSeq:t}))}underflow(e){return e.childCount<4}scourNode(e,t){let i;for(let s=0;s<e.childCount;s++){const n=e.children[s];if(n.isLeaf()){const e=n;if(e.segmentGroups.empty)if(void 0!==e.removedSeq)e.removedSeq>this.collabWindow.minSeq?t.push(e):e.trackingCollection.empty?(this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({operation:c.a.UNLINK,deltaSegments:[{segment:e}]},void 0),e.parent=void 0):t.push(e),i=void 0;else if(e.seq<=this.collabWindow.minSeq){i&&i.canAppend(e)&&Object(d.g)(i.properties,e.properties)&&i.trackingCollection.matches(e.trackingCollection)&&this.localNetLength(e)>0?(i.append(e),this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({operation:c.a.APPEND,deltaSegments:[{segment:i},{segment:e}]},void 0),e.parent=void 0,e.trackingCollection.trackingGroups.forEach(t=>t.unlink(e))):(t.push(e),i=this.localNetLength(e)>0?e:void 0)}else t.push(e),i=void 0;else t.push(e),i=void 0}else t.push(n),i=void 0}}packParent(e){const t=e.children;let i,s;const n=[];for(i=0;i<e.childCount;i++)s=t[i],this.scourNode(s,n),s.parent=void 0;const r=n.length;let o=Math.min(7,Math.floor(r/4));o<1&&(o=1);const c=Math.floor(r/o);let l=r%o;const h=new Array(8);let u=0;for(let a=0;a<o;a++){let t=c;l>0&&(t++,l--);const i=this.makeBlock(t);for(let e=0;e<t;e++){const t=n[u++];i.assignChild(t,e,!1)}i.parent=e,h[a]=i,this.nodeUpdateLengthNewStructure(i)}e.children=h;for(let a=0;a<o;a++)e.assignChild(h[a],a,!1);e.childCount=o,this.underflow(e)&&e.parent?this.packParent(e.parent):(this.nodeUpdateOrdinals(e),this.blockUpdatePathLengths(e,a.d,-1,!0))}zamboniSegments(e=F.zamboniSegmentsMaxCount){if(this.collabWindow.collaborating)for(let t=0;t<e;t++){let e=this.segmentsToScour.peek();if(!e||e.maxSeq>this.collabWindow.minSeq)break;if(e=this.segmentsToScour.get(),e.segment.parent&&!1!==e.segment.parent.needsScour){const t=e.segment.parent,i=[];this.scourNode(t,i),t.needsScour=!1;const s=i.length;if(s<t.childCount){t.childCount=s,t.children=i;for(let e=0;e<s;e++)t.assignChild(i[e],e,!1);this.underflow(t)&&t.parent?this.packParent(t.parent):(this.nodeUpdateOrdinals(t),this.blockUpdatePathLengths(t,a.d,-1,!0))}}}}getCollabWindow(){return this.collabWindow}getStats(){const e=t=>{const i={maxHeight:0,nodeCount:0,leafCount:0,removedLeafCount:0,liveCount:0,histo:[]};for(let e=0;e<8;e++)i.histo[e]=0;for(let s=0;s<t.childCount;s++){const n=t.children[s];let r=1;if(n.isLeaf()){i.leafCount++;void 0!==n.removedSeq&&i.removedLeafCount++}else{const t=e(n);r=1+t.maxHeight,i.nodeCount+=t.nodeCount,i.leafCount+=t.leafCount,i.removedLeafCount+=t.removedLeafCount,i.liveCount+=t.liveCount;for(let e=0;e<8;e++)i.histo[e]+=t.histo[e]}r>i.maxHeight&&(i.maxHeight=r)}return i.histo[t.childCount]++,i.nodeCount++,i.liveCount+=t.childCount,i};return e(this.root)}getLength(e,t){return this.blockLength(this.root,e,t)}get length(){return this.root.cachedLength}getPosition(e,t,i){var s;let n,r=0,a=e.parent;for(;a;){const o=a.children;for(let c=0;c<a.childCount;c++){const a=o[c];if(n&&a===n||a===e)break;r+=null!==(s=this.nodeLength(a,t,i))&&void 0!==s?s:0}n=a,a=a.parent}return r}getContainingSegment(e,t,i){let s,n;return this.searchBlock(this.root,e,0,t,i,{leaf:(e,t,i,r,a)=>(s=e,n=a,!1)},void 0),{segment:s,offset:n}}_getSlideToSegment(e){if(!e.segment||!b(e.segment))return e;let t;const i=e=>!(e.seq!==a.d&&!b(e))||(t=e,!1);return this.rightExcursion(e.segment,i),t?{segment:t,offset:0}:(this.leftExcursion(e.segment,i),t=t,t?{segment:t,offset:t.cachedLength-1}:{segment:void 0,offset:0})}slideReferences(e,t){var i,n,r,c,l;Object(s.a)(b(e),753),Object(s.a)(!!e.localRefs,754);const h=this._getSlideToSegment({segment:e,offset:0}),u=h.segment;u&&!u.localRefs&&(u.localRefs=new o.b(u));for(const a of t){null===(n=null===(i=a.callbacks)||void 0===i?void 0:i.beforeSlide)||void 0===n||n.call(i);const t=e.localRefs.removeLocalRef(a);Object(s.a)(a===t,755),u?(a.segment=u,a.offset=null!==(r=h.offset)&&void 0!==r?r:0,Object(s.a)(!!u.localRefs,756),u.localRefs.addLocalRef(a)):(a.segment=void 0,a.offset=0),null===(l=null===(c=a.callbacks)||void 0===c?void 0:c.afterSlide)||void 0===l||l.call(c)}u&&this.blockUpdatePathLengths(u.parent,a.c,a.a)}updateSegmentRefsAfterMarkRemoved(e,t){if(!e.localRefs||e.localRefs.empty)return;const i=[],s=[];for(const n of e.localRefs)Object(m.j)(n,h.b.StayOnRemove)?s.push(n):Object(m.j)(n,h.b.SlideOnRemove)&&(t?s.push(n):i.push(n));t||this.slideReferences(e,i),e.localRefs.clear();for(const n of s)n.segment=e,e.localRefs.addLocalRef(n)}blockLength(e,t,i){return this.collabWindow.collaborating&&i!==this.collabWindow.clientId?e.partialLengths.getPartialLength(t,i):e.cachedLength}nodeLength(e,t,i){if(this.collabWindow.collaborating&&this.collabWindow.clientId!==i){if(e.isLeaf()){const s=e,n=f(s);if(void 0!==n&&n.removedSeq!==a.d&&n.removedSeq<=t)return;if(s.clientId===i||s.seq!==a.d&&s.seq<=t)return void 0!==n&&n.removedClientIds.includes(i)?0:s.cachedLength;if(void 0!==n&&n.removedSeq!==a.d)return;return 0}return e.partialLengths.getPartialLength(t,i)}return e.isLeaf()?this.localNetLength(e):e.cachedLength}addMinSeqListener(e,t){this.minSeqListeners||(this.minSeqListeners=new r.a([],_)),this.minSeqListeners.add({minRequired:e,onMinGE:t})}notifyMinSeqListeners(){if(this.minSeqListeners)for(;this.minSeqListeners.count()>0&&this.minSeqListeners.peek().minRequired<=this.collabWindow.minSeq;){this.minSeqListeners.get().onMinGE(this.collabWindow.minSeq)}}setMinSeq(e){Object(s.a)(e<=this.collabWindow.currentSeq,78),Object(s.a)(this.collabWindow.minSeq<=e,79),e>this.collabWindow.minSeq&&(this.collabWindow.minSeq=e,F.options.zamboniSegments&&this.zamboniSegments(),this.notifyMinSeqListeners())}referencePositionToLocalPosition(e,t=this.collabWindow.currentSeq,i=this.collabWindow.clientId){const s=e.getSegment();if(s&&s.parent){return(s.removedSeq?0:e.getOffset())+this.getPosition(s,t,i)}return o.a.DetachedPosition}getStackContext(e,t,i){const s={mergeTree:this,stacks:Object(d.d)(),rangeLabels:i};return this.search(e,a.e,t,{leaf:x,shift:z},s),s.stacks}findTile(e,t,i,s=!0){const n={mergeTree:this,posPrecedesTile:s,tileLabel:i};if(s?this.search(e,a.e,t,{leaf:D,shift:B},n):this.backwardSearch(e,a.e,t,{leaf:D,shift:B},n),n.tile){let e;if(n.tile.isLeaf()){const i=n.tile;e=this.getPosition(i,a.e,t)}else{e=n.tile.toPosition()}return{tile:n.tile,pos:e}}}search(e,t,i,s,n){return this.searchBlock(this.root,e,0,t,i,s,n)}searchBlock(e,t,i,s,n,r,a){var o;let c=t,l=i;const h=e.children;r&&r.pre&&r.pre(e,l,s,n,void 0,void 0,a);const u=r&&r.contains;for(let d=0;d<e.childCount;d++){const e=h[d],t=null!==(o=this.nodeLength(e,s,n))&&void 0!==o?o:0;if(!u&&c<t||u&&u(e,c,s,n,void 0,void 0,a))return e.isLeaf()?(r&&r.leaf&&r.leaf(e,l,s,n,c,-1,a),e):this.searchBlock(e,c,l,s,n,r,a);r&&r.shift&&r.shift(e,l,s,n,c,void 0,a),c-=t,l+=t}r&&r.post&&r.post(e,l,s,n,void 0,void 0,a)}backwardSearch(e,t,i,s,n){const r=this.getLength(t,i);if(!(e>r))return this.backwardSearchBlock(this.root,e,r,t,i,s,n)}backwardSearchBlock(e,t,i,s,n,r,a){var o;let c=i;const l=e.children;r&&r.pre&&r.pre(e,c,s,n,void 0,void 0,a);const h=r&&r.contains;for(let u=e.childCount-1;u>=0;u--){const e=l[u],i=c-(null!==(o=this.nodeLength(e,s,n))&&void 0!==o?o:0);if(!h&&t>=i||h&&h(e,t,s,n,void 0,void 0,a))return e.isLeaf()?(r&&r.leaf&&r.leaf(e,i,s,n,t,-1,a),e):this.backwardSearchBlock(e,t,c,s,n,r,a);r&&r.shift&&r.shift(e,i,s,n,t,void 0,a),c=i}r&&r.post&&r.post(e,c,s,n,void 0,void 0,a)}updateRoot(e){if(void 0!==e){const t=this.makeBlock(2);t.assignChild(this.root,0,!1),t.assignChild(e,1,!1),this.root=t,this.nodeUpdateOrdinals(this.root),this.nodeUpdateLengthNewStructure(this.root)}}ackPendingSegment(e){const t=e.sequencedMessage.sequenceNumber,i=this.pendingSegments.dequeue(),s=[];let n=!1;if(void 0!==i){const r=[];i.segments.map(a=>{const o=!a.ack(i,e,this);n=o||n,o||e.op.type!==h.a.REMOVE||this.updateSegmentRefsAfterMarkRemoved(a,!1),F.options.zamboniSegments&&this.addToLRUSet(a,t),s.includes(a.parent)||s.push(a.parent),r.push({segment:a})}),this.mergeTreeMaintenanceCallback&&this.mergeTreeMaintenanceCallback({deltaSegments:r,operation:c.a.ACKNOWLEDGED},e);const a=this.collabWindow.clientId;for(const e of s)this.blockUpdatePathLengths(e,t,a,n)}F.options.zamboniSegments&&this.zamboniSegments()}addToPendingList(e,t,i){let s=t;return void 0===s&&(s={segments:[],localSeq:i},this.pendingSegments.enqueue(s)),e.segmentGroups.enqueue(s),s}getMarkerFromId(e){return this.idToSegment.get(e)}posFromRelativePos(e,t=this.collabWindow.currentSeq,i=this.collabWindow.clientId){let s,n=-1;return e.id&&(s=this.getMarkerFromId(e.id)),s&&(n=this.getPosition(s,t,i),e.before?void 0!==e.offset&&(n-=e.offset):(n+=s.cachedLength,void 0!==e.offset&&(n+=e.offset))),n}insertSegments(e,t,i,s,n,r){this.ensureIntervalBoundary(e,i,s);const o=n===a.d?++this.collabWindow.localSeq:void 0;this.blockInsert(e,i,s,n,o,t),this.mergeTreeDeltaCallback&&void 0!==r&&this.mergeTreeDeltaCallback(r,{operation:h.a.INSERT,deltaSegments:t.map(e=>({segment:e}))}),this.collabWindow.collaborating&&F.options.zamboniSegments&&n!==a.d&&this.zamboniSegments()}insertAtReferencePosition(e,t,i){if(0===t.cachedLength)return;if(t.parent||t.removedSeq||t.seq!==a.e)throw new Error("Cannot insert segment that has already been inserted.");const n=e=>{let t=e.parent,i=t;for(;void 0!==t;){if(t.childCount>=8){const e=this.split(t);t===this.root?(this.updateRoot(e),i=void 0):(this.insertChildNode(t.parent,e,t.index+1),i=e.parent,this.blockUpdateLength(t.parent,a.d,r))}else this.blockUpdateLength(t,a.d,r);t=t.parent}i&&this.nodeUpdateOrdinals(i)},r=this.collabWindow.clientId,o=e.getSegment(),c=e.getOffset(),l=this.nodeLength(o,this.collabWindow.currentSeq,r);let u=o;if(0!==c&&void 0!==l&&0!==l){const e=this.splitLeafSegment(o,c);Object(s.a)(!!e.next,80),this.insertChildNode(o.parent,e.next,o.index+1),n(e.next),u=e.next}if(this.leftExcursion(u,e=>{if(!e.isLeaf())return!0;const t=this.nodeLength(e,this.collabWindow.currentSeq,r);return void 0===t||0===t&&(this.breakTie(0,e,a.d)&&(u=e),!0)}),this.collabWindow.collaborating?(t.localSeq=++this.collabWindow.localSeq,t.seq=a.d):t.seq=a.e,t.clientId=r,N.is(t)){const e=t.getId();e&&this.mapIdToSegment(e,t)}this.insertChildNode(u.parent,t,u.index),n(t),this.mergeTreeDeltaCallback&&this.mergeTreeDeltaCallback(i,{deltaSegments:[{segment:t}],operation:h.a.INSERT}),this.collabWindow.collaborating&&this.addToPendingList(t,void 0,t.localSeq)}resolveRemoteClientPosition(e,t,i){if(t<this.collabWindow.minSeq)return;const s=this.getContainingSegment(e,t,i),n=this.getCollabWindow();if(s&&s.segment){return this.getPosition(s.segment,n.currentSeq,n.clientId)+s.offset}return e===this.getLength(t,i)?this.getLength(n.currentSeq,n.clientId):void 0}insertChildNode(e,t,i){Object(s.a)(e.childCount<8,81);for(let s=e.childCount;s>i;s--)e.children[s]=e.children[s-1],e.children[s].index=s;e.childCount++,e.assignChild(t,i,!1)}blockInsert(e,t,i,s,n,r){let o=!1;const c=e=>(e.seq===a.d&&(o=!0),!1),l=e=>(o=!1,this.rightExcursion(e,c),o);let h;const u=e=>{this.collabWindow.collaborating&&(e.seq===a.d&&i===this.collabWindow.clientId?h=this.addToPendingList(e,h,n):e.seq>this.collabWindow.minSeq&&F.options.zamboniSegments&&this.addToLRUSet(e,e.seq))},d=(e,t,i)=>{const s={};return e?(s.replaceCurrent=i.candidateSegment,s.next=e):s.next=i.candidateSegment,s};let m=e;for(const a of r)if(o=!1,a.cachedLength>0){if(a.seq=s,a.localSeq=n,a.clientId=i,N.is(a)){const e=a.getId();e&&this.mapIdToSegment(e,a)}const e=this.insertingWalk(this.root,m,t,i,s,{leaf:d,candidateSegment:a,continuePredicate:l});if(void 0===a.parent)throw new Error("MergeTree insert failed: "+JSON.stringify({currentSeq:this.collabWindow.currentSeq,minSeq:this.collabWindow.minSeq,segSeq:a.seq}));this.updateRoot(e),u(a),m+=a.cachedLength}}ensureIntervalBoundary(e,t,i){const s=this.insertingWalk(this.root,e,t,i,a.c,{leaf:this.splitLeafSegment});this.updateRoot(s)}breakTie(e,t,i){var s;if(t.isLeaf()){if(0===e){return(i===a.d?Number.MAX_SAFE_INTEGER:i)>(t.seq===a.d?Number.MAX_SAFE_INTEGER-1:null!==(s=t.seq)&&void 0!==s?s:0)}return!1}return!0}leftExcursion(e,t){let i=!0,s=e,n=s.parent;for(;n;){const e=n.children;let r,o,c=!1;for(r=n.childCount-1;r>=0;r--)if(o=e[r],c){if(o.isLeaf())i=t(o,0,a.e,this.collabWindow.clientId,0,0,void 0);else{const e=o;i=this.nodeMapReverse(e,t,0,a.e,this.collabWindow.clientId)}if(!i)return}else c=s===o;s=n,n=n.parent}}rightExcursion(e,t){let i=!0,s=e,n=s.parent;for(;n;){const e=n.children;let r,a,o=!1;for(r=0;r<n.childCount;r++)if(a=e[r],o){if(a.isLeaf())i=t(a);else{const e=a;i=this.walkAllSegments(e,t)}if(!i)return}else o=s===a;s=n,n=n.parent}}insertingWalk(e,t,i,s,n,r){let o=t;const c=e.children;let l,h,u,d;for(l=0;l<e.childCount;l++){h=c[l];const t=this.nodeLength(h,i,s);if(void 0!==t){if(o<t||o===t&&this.breakTie(o,h,n)){if(h.isLeaf()){const t=h,i=r.leaf(t,o,r);if(i.replaceCurrent&&(e.assignChild(i.replaceCurrent,l,!1),i.replaceCurrent.ordinal=h.ordinal),!i.next)return void(r.structureChange&&this.nodeUpdateLengthNewStructure(e));u=i.next,l++}else{const a=h,c=this.insertingWalk(a,o,i,s,n,r);if(void 0===c)return void(r.structureChange?this.nodeUpdateLengthNewStructure(e):this.blockUpdateLength(e,n,s));if(c===F.theUnfinishedNode){o-=t;continue}u=c,d=c,l++}break}o-=t}}if(!u&&0===o){if(n!==a.d&&r.continuePredicate&&r.continuePredicate(e))return F.theUnfinishedNode;u=r.leaf(void 0,o,r).next}if(u){for(let t=e.childCount;t>l;t--)e.children[t]=e.children[t-1],e.children[t].index=t;return e.assignChild(u,l,!1),e.childCount++,e.setOrdinal(u,l),e.childCount<8?(d&&this.nodeUpdateOrdinals(d),void(r.structureChange?this.nodeUpdateLengthNewStructure(e):this.blockUpdateLength(e,n,s))):this.split(e)}}split(e){const t=this.makeBlock(4);e.childCount=4,this.nodeUpdateOrdinals(e);for(let i=0;i<4;i++)t.assignChild(e.children[4+i],i,!1),e.children[4+i]=void 0;return this.nodeUpdateLengthNewStructure(e),this.nodeUpdateLengthNewStructure(t),t}nodeUpdateOrdinals(e){for(let t=0;t<e.childCount;t++){const i=e.children[t];e.setOrdinal(i,t),i.isLeaf()||this.nodeUpdateOrdinals(i)}}annotateRange(e,t,i,s,n,r,o,c){this.ensureIntervalBoundary(e,n,r),this.ensureIntervalBoundary(t,n,r);const l=[],u=o===a.d?++this.collabWindow.localSeq:void 0;let d;this.mapRange({leaf:e=>{const t=e.addProperties(i,s,o,this.collabWindow);return l.push({segment:e,propertyDeltas:t}),this.collabWindow.collaborating&&(o===a.d?d=this.addToPendingList(e,d,u):F.options.zamboniSegments&&this.addToLRUSet(e,o)),!0}},n,r,void 0,e,t),this.mergeTreeDeltaCallback&&l.length>0&&this.mergeTreeDeltaCallback(c,{operation:h.a.ANNOTATE,deltaSegments:l}),this.collabWindow.collaborating&&o!==a.d&&F.options.zamboniSegments&&this.zamboniSegments()}markRangeRemoved(e,t,i,s,n,r=!1,o){let c,l=r;this.ensureIntervalBoundary(e,i,s),this.ensureIntervalBoundary(t,i,s);const u=[],d=[],m=n===a.d?++this.collabWindow.localSeq:void 0;this.mapRange({leaf:(e,t,i,r)=>{const o=f(e);return void 0!==o?(l=!0,o.removedSeq===a.d?(o.removedClientIds.unshift(s),o.removedSeq=n,e.localRemovedSeq=void 0):o.removedClientIds.push(s)):(e.removedClientIds=[s],e.removedSeq=n,e.localRemovedSeq=m,u.push({segment:e})),e.localRefs&&!e.localRefs.empty&&d.push(e),this.collabWindow.collaborating&&(e.removedSeq===a.d&&s===this.collabWindow.clientId?c=this.addToPendingList(e,c,m):F.options.zamboniSegments&&this.addToLRUSet(e,n)),!0},post:(e,t,i,r)=>(l?this.nodeUpdateLengthNewStructure(e):this.blockUpdateLength(e,n,s),!0)},i,s,void 0,e,t);const g=this.collabWindow.collaborating&&s===this.collabWindow.clientId;for(const a of d)this.updateSegmentRefsAfterMarkRemoved(a,g);this.mergeTreeDeltaCallback&&u.length>0&&this.mergeTreeDeltaCallback(o,{operation:h.a.REMOVE,deltaSegments:u}),this.collabWindow.collaborating&&n!==a.d&&F.options.zamboniSegments&&this.zamboniSegments()}nodeUpdateLengthNewStructure(e,t=!1){this.blockUpdate(e),this.collabWindow.collaborating&&(e.partialLengths=u.a.combine(this,e,this.collabWindow,t))}removeLocalReferencePosition(e){var t;const i=e.getSegment();if(i){const s=null===(t=null==i?void 0:i.localRefs)||void 0===t?void 0:t.removeLocalRef(e);return void 0!==s&&this.blockUpdatePathLengths(i.parent,a.c,a.a),s}}createLocalReferencePosition(e,t,i,s,r){var c;if(function(e){return void 0!==f(e)}(e)&&!Object(m.j)(i,h.b.SlideOnRemove|h.b.Transient))throw new n.e("Can only create SlideOnRemove or Transient local reference position on a removed segment");const l=null!==(c=e.localRefs)&&void 0!==c?c:new o.b(e);e.localRefs=l;const u=l.createLocalRef(t,i,s,r);return this.blockUpdatePathLengths(e.parent,a.c,a.a),u}removeLocalReference(e,t){if(e.localRefs){e.localRefs.removeLocalRef(t)&&this.blockUpdatePathLengths(e.parent,a.c,a.a)}}addLocalReference(e){const t=e.segment;let i=t.localRefs;i||(i=new o.b(t),t.localRefs=i),i.addLocalRef(e),this.blockUpdatePathLengths(t.parent,a.c,a.a)}blockUpdate(e){var t;let i=0;const s=e.hierBlock();s&&(s.rightmostTiles=Object(d.d)(),s.leftmostTiles=Object(d.d)(),s.rangeStacks={});for(let a=0;a<e.childCount;a++){const o=e.children[a];i+=null!==(n=this,t=(r=o).isLeaf()?n.localNetLength(r):r.cachedLength)&&void 0!==t?t:0,s&&s.addNodeReferences(this,o),this.blockUpdateActions&&this.blockUpdateActions.child(e,a)}var n,r;e.cachedLength=i}blockUpdatePathLengths(e,t,i,s=!1){let n=e;for(;void 0!==n;)s?this.nodeUpdateLengthNewStructure(n):this.blockUpdateLength(n,t,i),n=n.parent}blockUpdateLength(e,t,i){this.blockUpdate(e),this.collabWindow.collaborating&&t!==a.d&&t!==a.c&&(void 0!==e.partialLengths&&F.options.incrementalUpdate&&i!==a.b?e.partialLengths.update(this,e,t,i,this.collabWindow):e.partialLengths=u.a.combine(this,e,this.collabWindow))}map(e,t,i,s){this.nodeMap(this.root,e,0,t,i,s)}mapRange(e,t,i,s,n,r,a=!1){a&&(n&&this.ensureIntervalBoundary(n,t,i),r&&this.ensureIntervalBoundary(r,t,i)),this.nodeMap(this.root,e,0,t,i,s,n,r)}incrementalBlockMap(e){for(var t;!e.empty();){const i=e.top();if(i.op!==q.Go)return;if(0===i.childIndex&&(void 0===i.start&&(i.start=0),void 0===i.end&&(i.end=this.blockLength(i.block,i.refSeq,i.clientId)),i.actions.pre&&i.actions.pre(i)),i.op===q.Go&&i.childIndex<i.block.childCount){const s=i.block.children[i.childIndex],n=null!==(t=this.nodeLength(s,i.refSeq,i.clientId))&&void 0!==t?t:0;if(n>0&&i.start<n&&i.end>0)if(s.isLeaf())i.actions.leaf(s,i);else{const t=new R(s,i.actions,i.pos,i.refSeq,i.clientId,i.context,i.start,i.end,0);e.push(t)}i.pos+=n,i.start-=n,i.end-=n,i.childIndex++}else i.childIndex===i.block.childCount&&(i.op===q.Go&&i.actions.post&&i.actions.post(i),e.pop())}}nodeMap(e,t,i,s,n,r,a,o){var c;let l=a,h=o,u=i;void 0===l&&(l=0),void 0===h&&(h=this.blockLength(e,s,n));let d=!0;if(t.pre&&(d=t.pre(e,u,s,n,l,h,r),!d))return!0;const m=e.children;for(let g=0;g<e.childCount;g++){const e=m[g],i=null!==(c=this.nodeLength(e,s,n))&&void 0!==c?c:0;if(d&&h>0&&i>0&&l<i&&(e.isLeaf()?t.leaf&&(d=t.leaf(e,u,s,n,l,h,r)):d&&(d=this.nodeMap(e,t,u,s,n,r,l,h))),!d)break;t.shift&&t.shift(e,u,s,n,l,h,r),u+=i,l-=i,h-=i}return d&&t.post&&(d=t.post(e,u,s,n,l,h,r)),d}walkAllSegments(e,t,i){let s=!0;const n=e.children;for(let r=0;s&&r<e.childCount;r++){const e=n[r];s=e.isLeaf()?t(e,i):this.walkAllSegments(e,t,i)}return s}nodeMapReverse(e,t,i,s,n){let r=!0;const a=e.children;for(let o=e.childCount-1;o>=0;o--){const e=a[o];if(r&&(e.isLeaf()?r=t(e,i,s,n,0,0,void 0):r&&(r=this.nodeMapReverse(e,t,i,s,n))),!r)break}return r}}F.zamboniSegmentsMaxCount=2,F.options={incrementalUpdate:!0,insertAfterRemovedSegs:!0,zamboniSegments:!0},F.theUnfinishedNode={childCount:-1}},28916:function(e,t,i){"use strict";i.d(t,"e",(function(){return s})),i.d(t,"d",(function(){return n})),i.d(t,"c",(function(){return r})),i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return o}));const s=0,n=-1,r=-2,a=-1,o=-2},28917:function(e,t,i){"use strict";i.d(t,"k",(function(){return n})),i.d(t,"j",(function(){return r})),i.d(t,"e",(function(){return a})),i.d(t,"d",(function(){return o})),i.d(t,"h",(function(){return c})),i.d(t,"f",(function(){return l})),i.d(t,"i",(function(){return h})),i.d(t,"g",(function(){return u})),i.d(t,"c",(function(){return d})),i.d(t,"b",(function(){return m})),i.d(t,"a",(function(){return g}));var s=i(28918);const n="referenceRangeLabels";function r(e,t){return 0!=(("number"==typeof e?e:e.refType)&t)}const a=e=>r(e,s.b.Tile)&&e.properties?e.properties.referenceTileLabels:void 0,o=e=>r(e,s.b.NestBegin|s.b.NestEnd)&&e.properties?e.properties[n]:void 0;function c(e,t){const i=a(e);if(i)for(const s of i)if(t===s)return!0;return!1}function l(e,t){const i=o(e);if(i)for(const s of i)if(t===s)return!0;return!1}function h(e){return void 0!==a(e)}function u(e){return void 0!==o(e)}function d(e,t){return g(e,t)<0?e:t}function m(e,t){return g(e,t)>0?e:t}function g(e,t){const i=e.getSegment(),s=t.getSegment();return i===s?e.getOffset()-t.getOffset():void 0===i||void 0!==s&&i.ordinal<s.ordinal?-1:1}},28918:function(e,t,i){"use strict";var s;i.d(t,"b",(function(){return s})),i.d(t,"a",(function(){return n})),function(e){e[e.Simple=0]="Simple",e[e.Tile=1]="Tile",e[e.NestBegin=2]="NestBegin",e[e.NestEnd=4]="NestEnd",e[e.RangeBegin=16]="RangeBegin",e[e.RangeEnd=32]="RangeEnd",e[e.SlideOnRemove=64]="SlideOnRemove",e[e.StayOnRemove=128]="StayOnRemove",e[e.Transient=256]="Transient"}(s||(s={}));const n={INSERT:0,REMOVE:1,ANNOTATE:2,GROUP:3}},28919:function(e,t,i){"use strict";i.d(t,"f",(function(){return s})),i.d(t,"d",(function(){return n})),i.d(t,"c",(function(){return a})),i.d(t,"a",(function(){return c})),i.d(t,"e",(function(){return u})),i.d(t,"b",(function(){return m}));class s{constructor(){this.items=[]}push(e){this.items.push(e)}empty(){return 0===this.items.length}top(){return this.items[this.items.length-1]}pop(){return this.items.pop()}}function n(e){if(void 0!==e&&!e.isHead)return e.next.prev=e.prev,e.prev.next=e.next,e}function r(e){return new o(!1,e)}function a(){return new o(!0,void 0)}class o{constructor(e,t){this.isHead=e,this.data=t,this.prev=this,this.next=this}clear(){this.isHead&&(this.prev=this,this.next=this)}add(e){const t=r(e);return this.prev.next=t,t.next=this,t.prev=this.prev,this.prev=t,t}dequeue(){if(!this.empty()){return n(this.next).data}}enqueue(e){return this.add(e)}walk(e){for(let t=this.next;!t.isHead;t=t.next)e(t.data,t)}some(e,t){const i=[];for(let s=t?this.prev:this.next;!s.isHead;s=t?s.prev:s.next){const n=s.data;e(n,s)&&(t?i.unshift(n):i.push(n))}return i}count(){let e,t;for(e=this.next,t=0;!e.isHead;t++)e=e.next;return t}first(){if(!this.empty())return this.next.data}last(){if(!this.empty())return this.prev.data}empty(){return this.next===this}push(e){this.unshift(e)}unshift(e){const t=r(e);t.data=e,t.isHead=!1,t.next=this.next,t.prev=this,this.next=t,t.next.prev=t}[Symbol.iterator](){let e=this;return{next(){for(;e&&!1===e.next.isHead;)if(e=e.next,void 0!==e.data)return{value:e.data,done:!1};return{value:void 0,done:!0}},[Symbol.iterator](){return this}}}}class c{constructor(e,t){this.comp=t,this.L=[t.min];for(let i=0,s=e.length;i<s;i++)this.add(e[i])}count(){return this.L.length-1}peek(){return this.L[1]}get(){const e=this.L[1];return this.L[1]=this.L[this.count()],this.L.pop(),this.fixDown(1),e}add(e){this.L.push(e),this.fixup(this.count())}fixup(e){let t=e;for(;t>1&&this.comp.compare(this.L[t>>1],this.L[t])>0;){const e=this.L[t>>1];this.L[t>>1]=this.L[t],this.L[t]=e,t>>=1}}fixDown(e){let t=e;for(;t<<1<=this.count();){let e=t<<1;if(e<this.count()&&this.comp.compare(this.L[e],this.L[e+1])>0&&e++,this.comp.compare(this.L[t],this.L[e])<=0)break;const i=this.L[t];this.L[t]=this.L[e],this.L[e]=i,t=e}}}const l=0,h=1;class u{constructor(e,t){this.compareKeys=e,this.aug=t}makeNode(e,t,i,s){return{key:e,data:t,color:i,size:s}}isRed(e){return!!e&&e.color===l}nodeSize(e){return e?e.size:0}size(){return this.nodeSize(this.root)}isEmpty(){return!this.root}get(e){if(void 0!==e)return this.nodeGet(this.root,e)}nodeGet(e,t){let i=e;for(;i;){const e=this.compareKeys(t,i.key);if(e<0)i=i.left;else{if(!(e>0))return i;i=i.right}}}contains(e){return this.get(e)}gather(e,t){const i=[];return void 0!==e&&this.nodeGather(this.root,i,e,t),i}nodeGather(e,t,i,s){e&&(s.continueSubtree(e.left,i)&&this.nodeGather(e.left,t,i,s),s.matchNode(e,i)&&t.push(e),s.continueSubtree(e.right,i)&&this.nodeGather(e.right,t,i,s))}walkExactMatchesForward(e,t,i,s){this.nodeWalkExactMatchesForward(this.root,e,t,i,s)}nodeWalkExactMatchesForward(e,t,i,s,n){if(!e)return;const r=t(e);s(r)&&this.nodeWalkExactMatchesForward(e.left,t,i,s,n),0===r&&i(e),n(r)&&this.nodeWalkExactMatchesForward(e.right,t,i,s,n)}walkExactMatchesBackward(e,t,i,s){this.nodeWalkExactMatchesBackward(this.root,e,t,i,s)}nodeWalkExactMatchesBackward(e,t,i,s,n){if(!e)return;const r=t(e);n(r)&&this.nodeWalkExactMatchesBackward(e.right,t,i,s,n),0===r&&i(e),s(r)&&this.nodeWalkExactMatchesBackward(e.left,t,i,s,n)}put(e,t,i){void 0!==e&&(void 0===t?this.remove(e):(this.root=this.nodePut(this.root,e,t,i),this.root.color=h))}nodePut(e,t,i,s){let n=e;if(n){const e=this.compareKeys(t,n.key);if(e<0)n.left=this.nodePut(n.left,t,i,s);else if(e>0)n.right=this.nodePut(n.right,t,i,s);else if(s){const e=s(t,n.key,i,n.data);e.key&&(n.key=e.key),e.data?n.data=e.data:n.data=i}else n.data=i;return this.isRed(n.right)&&!this.isRed(n.left)&&(n=this.rotateLeft(n)),this.isRed(n.left)&&this.isRed(n.left.left)&&(n=this.rotateRight(n)),this.isRed(n.left)&&this.isRed(n.right)&&this.flipColors(n),n.size=this.nodeSize(n.left)+this.nodeSize(n.right)+1,this.aug&&this.updateLocal(n),n}return this.makeNode(t,i,l,1)}updateLocal(e){this.aug&&(this.isRed(e.left)&&this.aug.update(e.left),this.isRed(e.right)&&this.aug.update(e.right),this.aug.update(e))}nodeRemoveMin(e){let t=e;if(t.left)return this.isRed(t.left)||this.isRed(t.left.left)||(t=this.moveRedLeft(t)),t.left=this.nodeRemoveMin(t.left),this.balance(t)}remove(e){if(void 0!==e){if(!this.contains(e))return;this.removeExisting(e)}}removeExisting(e){this.isRed(this.root.left)||this.isRed(this.root.right)||(this.root.color=l),this.root=this.nodeRemove(this.root,e)}nodeRemove(e,t){let i=e;if(this.compareKeys(t,i.key)<0)this.isRed(i.left)||this.isRed(i.left.left)||(i=this.moveRedLeft(i)),i.left=this.nodeRemove(i.left,t);else{if(this.isRed(i.left)&&(i=this.rotateRight(i)),0===this.compareKeys(t,i.key)&&!i.right)return;if(this.isRed(i.right)||this.isRed(i.right.left)||(i=this.moveRedRight(i)),0===this.compareKeys(t,i.key)){const e=this.nodeMin(i.right);i.key=e.key,i.data=e.data,i.right=this.nodeRemoveMin(i.right)}else i.right=this.nodeRemove(i.right,t)}return this.balance(i)}floor(e){if(!this.isEmpty())return this.nodeFloor(this.root,e)}nodeFloor(e,t){if(e){const i=this.compareKeys(t,e.key);if(0===i)return e;if(i<0)return this.nodeFloor(e.left,t);{const i=this.nodeFloor(e.right,t);return i||e}}}ceil(e){if(!this.isEmpty())return this.nodeCeil(this.root,e)}nodeCeil(e,t){if(e){const i=this.compareKeys(t,e.key);if(0===i)return e;if(i>0)return this.nodeCeil(e.right,t);{const i=this.nodeCeil(e.left,t);return i||e}}}min(){if(this.root)return this.nodeMin(this.root)}nodeMin(e){return e.left?this.nodeMin(e.left):e}max(){if(this.root)return this.nodeMax(this.root)}nodeMax(e){return e.right?this.nodeMax(e.right):e}rotateRight(e){const t=e.left;return e.left=t.right,t.right=e,t.color=t.right.color,t.right.color=l,t.size=e.size,e.size=this.nodeSize(e.left)+this.nodeSize(e.right)+1,this.aug&&(this.updateLocal(e),this.updateLocal(t)),t}rotateLeft(e){const t=e.right;return e.right=t.left,t.left=e,t.color=t.left.color,t.left.color=l,t.size=e.size,e.size=this.nodeSize(e.left)+this.nodeSize(e.right)+1,this.aug&&(this.updateLocal(e),this.updateLocal(t)),t}oppositeColor(e){return e===h?l:h}flipColors(e){e.color=this.oppositeColor(e.color),e.left.color=this.oppositeColor(e.left.color),e.right.color=this.oppositeColor(e.right.color)}moveRedLeft(e){let t=e;return this.flipColors(t),this.isRed(t.right.left)&&(t.right=this.rotateRight(t.right),t=this.rotateLeft(t),this.flipColors(t)),t}moveRedRight(e){let t=e;return this.flipColors(t),this.isRed(t.left.left)&&(t=this.rotateRight(t),this.flipColors(t)),t}balance(e){let t=e;return this.isRed(t.right)&&(t=this.rotateLeft(t)),this.isRed(t.left)&&this.isRed(t.left.left)&&(t=this.rotateRight(t)),this.isRed(t.left)&&this.isRed(t.right)&&this.flipColors(t),t.size=this.nodeSize(t.left)+this.nodeSize(t.right)+1,this.aug&&this.aug.update(t),t}mapRange(e,t,i,s){this.nodeMap(this.root,e,i,s)}map(e,t){this.nodeMap(this.root,e,t)}keys(){const e=[],t={showStructure:!0,infix:t=>(e.push(t.key),!0)};return this.walk(t),e}walk(e){this.nodeWalk(this.root,e)}walkBackward(e){this.nodeWalkBackward(this.root,e)}nodeWalk(e,t){let i=!0;return e&&(t.pre&&(t.showStructure||e.color===h)&&(i=t.pre(e)),e.left&&(i=this.nodeWalk(e.left,t)),i&&t.infix&&(t.showStructure||e.color===h)&&(i=t.infix(e)),i&&(i=this.nodeWalk(e.right,t)),i&&t.post&&(t.showStructure||e.color===h)&&(i=t.post(e))),i}nodeWalkBackward(e,t){let i=!0;return e&&(t.pre&&(t.showStructure||e.color===h)&&(i=t.pre(e)),e.right&&(i=this.nodeWalkBackward(e.right,t)),i&&t.infix&&(t.showStructure||e.color===h)&&(i=t.infix(e)),i&&(i=this.nodeWalkBackward(e.left,t)),i&&t.post&&(t.showStructure||e.color===h)&&(i=t.post(e))),i}nodeMap(e,t,i,s,n){let r=s,a=n;if(!e)return!0;void 0===r&&(r=this.nodeMin(e).key),void 0===a&&(a=this.nodeMax(e).key);const o=this.compareKeys(r,e.key),c=this.compareKeys(a,e.key);let l=!0;return o<0&&(l=this.nodeMap(e.left,t,i,r,a)),l&&o<=0&&c>=0&&(l=t(e,i)),l&&c>0&&(l=this.nodeMap(e.right,t,i,r,a)),l}}const d=(e,t)=>e.compare(t);class m{constructor(){this.intervals=new u(d,this)}remove(e){this.intervals.remove(e)}removeExisting(e){this.intervals.removeExisting(e)}put(e,t){let i;t&&(i=(e,i)=>({key:t(e,i)})),this.intervals.put(e,{minmax:e.clone()},i)}map(e){const t={infix:t=>(e(t.key),!0),showStructure:!0};this.intervals.walk(t)}mapUntil(e){const t={infix:t=>e(t.key),showStructure:!0};this.intervals.walk(t)}mapBackward(e){const t={infix:t=>(e(t.key),!0),showStructure:!0};this.intervals.walkBackward(t)}match(e){return this.intervals.gather(e,this)}matchNode(e,t){return!!e&&e.key.overlaps(t)}continueSubtree(e,t){return!!e&&e.data.minmax.overlaps(t)}update(e){e.left&&e.right?e.data.minmax=e.key.union(e.left.data.minmax.union(e.right.data.minmax)):e.left?e.data.minmax=e.key.union(e.left.data.minmax):e.right?e.data.minmax=e.key.union(e.right.data.minmax):e.data.minmax=e.key.clone()}}},28920:function(e,t,i){"use strict";function s(e,t,i,s){let n=t;switch(void 0===n&&(n=e.defaultValue),e.name){case"incr":n+=i,e.minValue&&n<e.minValue&&(n=e.minValue);break;case"consensus":if(void 0===n){n={value:i,seq:s}}else{const e=n;-1===e.seq&&(e.seq=s)}}return n}function n(e,t){if(e){if(!t)return!1;for(const i in e){if(void 0===t[i])return!1;if("object"==typeof t[i]){if(!n(e[i],t[i]))return!1}else if(t[i]!==e[i])return!1}for(const i in t)if(void 0===e[i])return!1}else if(t)return!1;return!0}function r(e,t,i,n){if(void 0!==t)for(const r in t){const a=t[r];null===a?delete e[r]:i&&"rewrite"!==i.name?e[r]=s(i,e[r],a,n):e[r]=a}return e}function a(e){if(void 0===e)return;const t=l();for(const i in e){const s=e[i];null!==s&&(t[i]=s)}return t}function o(e,t,i,s){let n=e;return(!n||i&&"rewrite"===i.name)&&(n=l()),r(n,t,i,s),n}function c(e,t){if(void 0!==t)for(const i in t)void 0===e[i]&&(e[i]=t[i]);return e}function l(){return Object.create(null)}i.d(t,"c",(function(){return s})),i.d(t,"g",(function(){return n})),i.d(t,"e",(function(){return r})),i.d(t,"b",(function(){return a})),i.d(t,"a",(function(){return o})),i.d(t,"f",(function(){return c})),i.d(t,"d",(function(){return l}))},28921:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28919);class n{constructor(e){this.segment=e,this.segmentGroups=Object(s.c)()}get size(){return this.segmentGroups.count()}get empty(){return this.segmentGroups.empty()}enqueue(e){this.segmentGroups.enqueue(e),e.segments.push(this.segment)}dequeue(){return this.segmentGroups.dequeue()}clear(){this.segmentGroups.clear()}copyTo(e){this.segmentGroups.walk(t=>e.segmentGroups.enqueue(t))}}},28922:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));i(28923);class s{constructor(e){this.segment=e,this.trackingGroups=new Set}link(e){e&&(this.trackingGroups.has(e)||this.trackingGroups.add(e),e.has(this.segment)||e.link(this.segment))}unlink(e){e.has(this.segment)&&e.unlink(this.segment),this.trackingGroups.delete(e)}copyTo(e){this.trackingGroups.forEach(t=>e.trackingCollection.link(t))}get empty(){return 0===this.trackingGroups.size}matches(e){if(!e||this.trackingGroups.size!==e.trackingGroups.size)return!1;for(const t of this.trackingGroups.values())if(!e.trackingGroups.has(t))return!1;return!0}}},28923:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(){this.ordinalSortedItems=[]}get size(){return this.ordinalSortedItems.length}get items(){return this.ordinalSortedItems}addOrUpdate(e,t){const i=this.findOrdinalPosition(this.getOrdinal(e));i.exists?t&&t(this.ordinalSortedItems[i.index],e):this.ordinalSortedItems.splice(i.index,0,e)}remove(e){const t=this.findOrdinalPosition(this.getOrdinal(e));return!!t.exists&&(this.ordinalSortedItems.splice(t.index,1),!0)}has(e){return this.findOrdinalPosition(this.getOrdinal(e)).exists}getOrdinal(e){const t=e;if(null==t?void 0:t.segment)return t.segment.ordinal;return e.ordinal}findOrdinalPosition(e,t,i){if(0===this.ordinalSortedItems.length)return{exists:!1,index:0};if(void 0===t||void 0===i)return this.findOrdinalPosition(e,0,this.ordinalSortedItems.length-1);const s=t+Math.floor((i-t)/2);return this.getOrdinal(this.ordinalSortedItems[s])>e?t===s?{exists:!1,index:s}:this.findOrdinalPosition(e,t,s-1):this.getOrdinal(this.ordinalSortedItems[s])<e?s===i?{exists:!1,index:s+1}:this.findOrdinalPosition(e,s+1,i):{exists:!0,index:s}}}},28924:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var s=i(28824),n=i(28916),r=i(28920);class a{constructor(){this.pendingRewriteCount=0}ackPendingProperties(e){var t,i;e.combiningOp&&"rewrite"===e.combiningOp.name&&this.pendingRewriteCount--;for(const n of Object.keys(e.props))void 0!==(null===(t=this.pendingKeyUpdateCount)||void 0===t?void 0:t[n])&&(Object(s.a)(this.pendingKeyUpdateCount[n]>0,92),this.pendingKeyUpdateCount[n]--,0===(null===(i=this.pendingKeyUpdateCount)||void 0===i?void 0:i[n])&&delete this.pendingKeyUpdateCount[n])}addProperties(e,t,i,s,a=!1){var o;if(this.pendingKeyUpdateCount||(this.pendingKeyUpdateCount=Object(r.d)()),this.pendingRewriteCount>0&&s!==n.d&&a)return;const c=i&&"rewrite"===i.name,l=c?void 0:i||void 0,h=e=>{var t;return!(s!==n.d&&void 0!==(null===(t=this.pendingKeyUpdateCount)||void 0===t?void 0:t[e])&&!l)},u={};if(c){a&&s===n.d&&this.pendingRewriteCount++;for(const i of Object.keys(e))!t[i]&&h(i)&&(u[i]=e[i],delete e[i])}for(const d of Object.keys(t)){if(a)if(s===n.d)void 0===(null===(o=this.pendingKeyUpdateCount)||void 0===o?void 0:o[d])&&(this.pendingKeyUpdateCount[d]=0),this.pendingKeyUpdateCount[d]++;else if(!h(d))continue;const i=e[d];let c;u[d]=void 0===i?null:i,c=l?Object(r.c)(l,i,c,s):t[d],null===c?delete e[d]:e[d]=c}return u}copyTo(e,t,i){if(e){if(t||(t=Object(r.d)()),!i)throw new Error("Must provide new PropertyManager");for(const i of Object.keys(e))t[i]=e[i];i.pendingRewriteCount=this.pendingRewriteCount,i.pendingKeyUpdateCount=Object(r.d)();for(const e of Object.keys(this.pendingKeyUpdateCount))i.pendingKeyUpdateCount[e]=this.pendingKeyUpdateCount[e]}return t}hasPendingProperties(){return this.pendingRewriteCount>0||Object.keys(this.pendingKeyUpdateCount).length>0}}},28925:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s={APPEND:-1,SPLIT:-2,UNLINK:-3,ACKNOWLEDGED:-4}},28926:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return u}));var s=i(28824),n=i(28836),r=i(28919),a=i(28918),o=i(28920),c=i(28917);class l{constructor(e,t,i=0,s=a.b.Simple,r){this.client=e,this.offset=i,this.refType=s,function(e){let t=0;if(Object(c.j)(e,a.b.Transient)&&++t,Object(c.j)(e,a.b.SlideOnRemove)&&++t,Object(c.j)(e,a.b.StayOnRemove)&&++t,t>1)throw new n.e("Reference types can only be one of Transient, SlideOnRemove, and StayOnRemove")}(s),this.segment=t,this.properties=r}min(e){return Object(c.c)(this,e)}max(e){return Object(c.b)(this,e)}compare(e){return Object(c.a)(this,e)}toPosition(){return this.getClient().localReferencePositionToPosition(this)}hasTileLabels(){return Object(c.i)(this)}hasRangeLabels(){return Object(c.g)(this)}hasTileLabel(e){return Object(c.h)(this,e)}hasRangeLabel(e){return Object(c.f)(this,e)}getTileLabels(){return Object(c.e)(this)}getRangeLabels(){return Object(c.d)(this)}isLeaf(){return!1}addProperties(e,t){this.properties=Object(o.a)(this.properties,e,t)}getClient(){return this.client}getSegment(){return this.segment}getOffset(){return this.offset}getProperties(){return this.properties}}function h(e){Object(s.a)(e instanceof l,736)}l.DetachedPosition=-1;class u{constructor(e,t=new Array(e.cachedLength)){this.segment=e,this.hierRefCount=0,this.refCount=0,this.refsByOffset=t}static append(e,t){t.localRefs&&!t.localRefs.empty?(e.localRefs||(e.localRefs=new u(e)),Object(s.a)(e.localRefs.refsByOffset.length===e.cachedLength,702),e.localRefs.append(t.localRefs)):e.localRefs&&(e.localRefs.refsByOffset.length+=t.cachedLength)}[Symbol.iterator](){const e=[];for(const t of this.refsByOffset)t&&(t.before&&e.push(t.before[Symbol.iterator]()),t.at&&e.push(t.at[Symbol.iterator]()),t.after&&e.push(t.after[Symbol.iterator]()));return{next(){for(;e.length>0;){const t=e[0].next();if(!0!==t.done)return t;e.shift()}return{value:void 0,done:!0}},[Symbol.iterator](){return this}}}clear(){this.refCount=0,this.hierRefCount=0;const e=e=>{if(e)for(const t of e)t.segment===this.segment&&(t.segment=void 0)};for(let t=0;t<this.refsByOffset.length;t++){const i=this.refsByOffset[t];i&&(e(i.before),e(i.at),e(i.before),this.refsByOffset[t]=void 0)}}get empty(){return 0===this.refCount}createLocalRef(e,t,i,s){const n=new l(s,this.segment,e,t,i);return Object(c.j)(n,a.b.Transient)||this.addLocalRef(n),n}addLocalRef(e){var t,i;Object(s.a)(!Object(c.j)(e,a.b.Transient),735),h(e);const n=this.refsByOffset[e.offset]=null!==(t=this.refsByOffset[e.offset])&&void 0!==t?t:{at:Object(r.c)()};(n.at=null!==(i=n.at)&&void 0!==i?i:Object(r.c)()).enqueue(e),(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount++,this.refCount++}removeLocalRef(e){h(e);const t=t=>{if(t){let i=t;do{if(i=i.next,i.data===e)return Object(r.d)(i),(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount--,this.refCount--,e}while(!i.isHead)}},i=this.refsByOffset[e.offset];if(void 0!==i){let e=t(i.before);if(e)return e;if(e=t(i.at),e)return e;if(e=t(i.after),e)return e}}append(e){if(e&&!e.empty){this.hierRefCount+=e.hierRefCount,this.refCount+=e.refCount,e.hierRefCount=0;for(const t of e)t.segment=this.segment,t.offset+=this.refsByOffset.length;this.refsByOffset.push(...e.refsByOffset)}}split(e,t){if(this.empty)this.refsByOffset.length=e;else{const i=new u(t,this.refsByOffset.splice(e,this.refsByOffset.length-e));t.localRefs=i;for(const s of i)s.segment=t,s.offset-=e,(Object(c.g)(s)||Object(c.i)(s))&&(this.hierRefCount--,i.hierRefCount++),this.refCount--,i.refCount++}}addBeforeTombstones(...e){var t,i,s,n,o;const l=null!==(i=null===(t=this.refsByOffset[0])||void 0===t?void 0:t.before)&&void 0!==i?i:Object(r.c)();for(const r of e)for(const e of r)h(e),Object(c.j)(e,a.b.SlideOnRemove)?(l.push(e),e.segment=this.segment,e.offset=0,(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount++,this.refCount++):e.segment=void 0;if(!l.empty()&&void 0===(null===(s=this.refsByOffset[0])||void 0===s?void 0:s.before)){const e=this.refsByOffset[0]=null!==(n=this.refsByOffset[0])&&void 0!==n?n:{before:l};e.before=null!==(o=e.before)&&void 0!==o?o:l}}addAfterTombstones(...e){var t,i,s,n,o;const l=this.refsByOffset.length-1,u=null!==(i=null===(t=this.refsByOffset[l])||void 0===t?void 0:t.after)&&void 0!==i?i:Object(r.c)();for(const r of e)for(const e of r)h(e),Object(c.j)(e,a.b.SlideOnRemove)?(u.push(e),e.segment=this.segment,e.offset=this.segment.cachedLength-1,(Object(c.g)(e)||Object(c.i)(e))&&this.hierRefCount++,this.refCount++):e.segment=void 0;if(!u.empty()&&void 0===(null===(s=this.refsByOffset[l])||void 0===s?void 0:s.after)){const e=this.refsByOffset[l]=null!==(n=this.refsByOffset[l])&&void 0!==n?n:{after:u};e.after=null!==(o=e.after)&&void 0!==o?o:u}}}},28927:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var s=i(28824),n=i(28919),r=i(28916),a=i(28915);function o(e,t){let i=-1,s=0,n=e.length-1;for(;s<=n;){const r=s+Math.floor((n-s)/2);e[r].seq<=t?((i<0||e[i].seq<e[r].seq)&&(i=r),s=r+1):n=r-1}return i}class c{constructor(e){this.minSeq=e,this.minLength=0,this.segmentCount=0,this.partialLengths=[],this.clientSeqNumbers=[]}static combine(e,t,i,s=!1){return c.combineBranch(e,t,i,s)}static combineBranch(e,t,i,s=!1){let r,o=new c(i.minSeq);function l(e){if(!e)return;const t=new n.e(a.d);return e.map(e=>(t.put(e.data.clientId,Object.assign({},e.data)),!0)),t}function h(e){const t=e.seq;let i=0;if(r){if(r.seq===e.seq)return r.seglen+=e.seglen,r.len+=e.seglen,void function(e,t){const i=e.overlapRemoveClients;i?t.overlapRemoveClients&&t.overlapRemoveClients.map(e=>{const t=i.get(e.key);return t?t.data.seglen+=e.data.seglen:i.put(e.data.clientId,Object.assign({},e.data)),!0}):e.overlapRemoveClients=l(t.overlapRemoveClients)}(r,e);i=r.len,o.addClientSeqNumberFromPartial(r)}r={clientId:e.clientId,len:i+e.seglen,overlapRemoveClients:l(e.overlapRemoveClients),seglen:e.seglen,seq:t},o.partialLengths.push(r)}c.fromLeaves(o,t,i);const u=[];for(let n=0;n<t.childCount;n++){const r=t.children[n];if(!r.isLeaf()){const t=r;s&&(t.partialLengths=c.combine(e,t,i,!0)),u.push(t.partialLengths)}}let d=u.length;if(0!==d){o.partialLengths.length>0&&(u.push(o),d++,o=new c(i.minSeq));const e=new Array(d),t=new Array(d);for(let i=0;i<d;i++)e[i]=0,t[i]=u[i].partialLengths.length,o.minLength+=u[i].minLength,o.segmentCount+=u[i].segmentCount;let s,n=0;for(;n>=0;){n=-1;for(let i=0;i<d;i++)if(e[i]<t[i]){const t=u[i].partialLengths[e[i]];(n<0||t.seq<s.seq)&&(n=i,s=t)}n>=0&&(h(s),e[n]++)}r&&o.addClientSeqNumberFromPartial(r)}return c.options.zamboni&&o.zamboni(i),c.options.verify&&o.verify(),o}static fromLeaves(e,t,i){function s(e,t){return void 0!==e&&e!==r.d&&e<=t}e.minLength=0,e.segmentCount=t.childCount;for(let h=0;h<t.childCount;h++){const n=t.children[h];if(n.isLeaf()){const t=n;s(t.seq,i.minSeq)?e.minLength+=t.cachedLength:t.seq!==r.d&&c.insertSegment(e,t);const o=Object(a.f)(t);s(null==o?void 0:o.removedSeq,i.minSeq)?e.minLength-=t.cachedLength:void 0!==o&&o.removedSeq!==r.d&&c.insertSegment(e,t,o)}}const n=e.partialLengths,o=n.length;let l=0;for(let r=0;r<o;r++)n[r].len=l+n[r].seglen,l=n[r].len,e.addClientSeqNumberFromPartial(n[r]);c.options.verify&&e.verify()}static getOverlapClients(e,t){const i=new n.e(a.d);for(const s of e)i.put(s,{clientId:s,seglen:t});return i}static accumulateRemoveClientOverlap(e,t,i){if(e.overlapRemoveClients)for(const s of t){const t=e.overlapRemoveClients.get(s);t?t.data.seglen+=i:e.overlapRemoveClients.put(s,{clientId:s,seglen:i})}else e.overlapRemoveClients=c.getOverlapClients(t,i)}static insertSegment(e,t,i){let s,n=t.seq,r=t.cachedLength,a=t.clientId;i&&(n=i.removedSeq,r=-r,a=i.removedClientIds[0],s=i.removedClientIds.length>1?i.removedClientIds.slice(1):void 0);const o=e.partialLengths,l=o.length;let h=0;for(;h<l&&!(o[h].seq>=n);h++);if(h<l&&o[h].seq===n)o[h].seglen+=r,s&&c.accumulateRemoveClientOverlap(o[h],s,r);else{let e;if(s){e={seq:n,clientId:a,len:0,seglen:r,overlapRemoveClients:c.getOverlapClients(s,r)}}else e={seq:n,clientId:a,len:0,seglen:r};if(h<l){for(let e=l;e>h;e--)o[e]=o[e-1];o[h]=e}else o.push(e)}}static addSeq(e,t,i,s){let n,r,a=o(e,t);if(a>=0){const i=e[a];i.seq===t?(n=i,a=o(e,t-1),a>=0&&(r=e[a])):r=i}void 0===n?(n={clientId:s,seglen:i,seq:t},e.push(n)):n.seglen=i,n.len=void 0!==r?n.seglen+r.len:n.seglen}update(e,t,i,s,n){let r=0,l=0;for(let c=0;c<t.childCount;c++){const e=t.children[c];if(e.isLeaf()){const t=e,s=Object(a.f)(t);t.seq===i?(null==s?void 0:s.removedSeq)!==i&&(r+=t.cachedLength):(null==s?void 0:s.removedSeq)===i&&(r-=t.cachedLength),l++}else{const t=e.partialLengths,s=t.partialLengths,n=o(s,i);if(n>=0){const e=s[n];e.seq===i&&(r+=e.seglen)}l+=t.segmentCount}}this.segmentCount=l,c.addSeq(this.partialLengths,i,r,s),void 0===this.clientSeqNumbers[s]&&(this.clientSeqNumbers[s]=[]),c.addSeq(this.clientSeqNumbers[s],i,r),c.options.zamboni&&this.zamboni(n),c.options.verify&&this.verify()}getPartialLength(e,t){let i=this.minLength;const s=o(this.partialLengths,e),n=this.cliLatest(t),r=this.clientSeqNumbers[t];if(s>=0){if(i+=this.partialLengths[s].len,n>=0){const s=r[n];if(s.seq>e){i+=s.len;const n=this.cliLatestLEQ(t,e);n>=0&&(i-=r[n].len)}}}else if(n>=0){i+=r[n].len}return i}toString(e,t=0){let i="";for(const s of this.partialLengths)i+=`(${s.seq},${s.len}) `;for(const s in this.clientSeqNumbers)if(this.clientSeqNumbers[s].length>0){i+="Client ",i+=e?""+e(+s):""+s,i+="[";for(const e of this.clientSeqNumbers[s])i+=`(${e.seq},${e.len})`;i+="]"}return i=`min(seq ${this.minSeq}): ${this.minLength}; sc: ${this.segmentCount};${i}`,i}zamboni(e){function t(t){const i=o(t,e.minSeq);let s=0;if(i>=0){s=t[i].len;const e=t.length;if(i<=e-1){const n=e-i-1;for(let e=0;e<n;e++)t[e]=t[e+i+1],t[e].len-=s;t.length=n}}return s}this.minLength+=t(this.partialLengths);for(const i in this.clientSeqNumbers){const e=this.clientSeqNumbers[i];e&&t(e)}}addClientSeqNumber(e,t,i){void 0===this.clientSeqNumbers[e]&&(this.clientSeqNumbers[e]=[]);const s=this.clientSeqNumbers[e];let n=i;s.length>0&&(n+=s[s.length-1].len),s.push({seq:t,len:n,seglen:i})}addClientSeqNumberFromPartial(e){this.addClientSeqNumber(e.clientId,e.seq,e.seglen),e.overlapRemoveClients&&e.overlapRemoveClients.map(t=>(this.addClientSeqNumber(t.data.clientId,e.seq,t.data.seglen),!0))}cliLatestLEQ(e,t){const i=this.clientSeqNumbers[e];return i?o(i,t):-1}cliLatest(e){const t=this.clientSeqNumbers[e];return t&&t.length>0?t.length-1:-1}verifyPartialLengths(e,t){if(0===e.length)return 0;let i=0,n=0,r=0;for(const a of e)r++,Object(s.a)(this.minSeq<=a.seq,84),Object(s.a)(i<a.seq,85),i=a.seq,n+=a.seglen,n!==a.len&&Object(s.a)(!1,86),t||this.minLength+a.len<0&&Object(s.a)(!1,87),a.overlapRemoveClients&&(Object(s.a)(!t,88),r+=a.overlapRemoveClients.size());return r}verify(){if(this.clientSeqNumbers){let e=0;for(const i of this.clientSeqNumbers)i&&(e+=this.verifyPartialLengths(i,!0));Object(s.a)(!!this.partialLengths,89);const t=this.verifyPartialLengths(this.partialLengths,!1);Object(s.a)(t===e,90)}else Object(s.a)(!this.partialLengths,91)}}c.options={verify:!1,zamboni:!0}},28928:function(e,t,i){"use strict";i.d(t,"a",(function(){return y}));var s=i(28858),n=i(28862),r=i(28824),a=i(28828),o=i(28849),c=i(28929),l=i(28918),h=i(28920),u=i(28930),d=i(28926),m=i(28870),g=i(28940),p=i(28821),f=i(28912),b=i(28939),v=i(28937),S=i(28936);class y extends p.a{constructor(e,t,i,n){super(t,e,i,"fluid_sequence_"),this.dataStoreRuntime=e,this.id=t,this.segmentFromSpec=n,this.loadedDeferred=new s.a,this.loadedDeferredOutgoingOps=[],this.deferIncomingOps=!0,this.loadedDeferredIncomingOps=[],this.messagesSinceMSNChange=[],this.loadedDeferred.promise.catch(e=>{this.logger.sendErrorEvent({eventName:"SequenceLoadFailed"},e)}),this.client=new c.a(n,a.a.create(this.logger,"SharedSegmentSequence.MergeTreeClient"),e.options),super.on("newListener",e=>{switch(e){case"sequenceDelta":this.client.mergeTreeDeltaCallback||(this.client.mergeTreeDeltaCallback=(e,t)=>{this.emit("sequenceDelta",new S.a(e,t,this.client),this)});break;case"maintenance":this.client.mergeTreeMaintenanceCallback||(this.client.mergeTreeMaintenanceCallback=(e,t)=>{this.emit("maintenance",new S.b(t,e,this.client),this)})}}),super.on("removeListener",e=>{switch(e){case"sequenceDelta":0===super.listenerCount(e)&&(this.client.mergeTreeDeltaCallback=void 0);break;case"maintenance":0===super.listenerCount(e)&&(this.client.mergeTreeMaintenanceCallback=void 0)}}),this.intervalCollections=new v.a(this.serializer,this.handle,(e,t)=>this.submitLocalMessage(e,t),new b.a)}get loaded(){return this.loadedDeferred.promise}static createOpsFromDelta(e){var t,i;const s=[];for(const n of e.ranges)switch(e.deltaOperation){case l.a.ANNOTATE:{const e=s[s.length-1],r={};for(const s of Object.keys(n.propertyDeltas))r[s]=null!==(i=null===(t=n.segment.properties)||void 0===t?void 0:t[s])&&void 0!==i?i:null;e&&e.pos2===n.position&&Object(h.g)(e.props,r)?e.pos2+=n.segment.cachedLength:s.push(Object(u.b)(n.position,n.position+n.segment.cachedLength,r,void 0));break}case l.a.INSERT:s.push(Object(u.d)(n.position,n.segment.clone().toJSONObject()));break;case l.a.REMOVE:{const e=s[s.length-1];(null==e?void 0:e.pos1)===n.position?e.pos2+=n.segment.cachedLength:s.push(Object(u.f)(n.position,n.position+n.segment.cachedLength));break}}return s}removeRange(e,t){const i=this.client.removeRangeLocal(e,t);return i&&this.submitSequenceMessage(i),i}groupOperation(e){this.client.localTransaction(e),this.submitSequenceMessage(e)}getContainingSegment(e){return this.client.getContainingSegment(e)}getLength(){return this.client.getLength()}getPosition(e){return this.client.getPosition(e)}annotateRange(e,t,i,s){const n=this.client.annotateRangeLocal(e,t,i,s);n&&this.submitSequenceMessage(n)}getPropertiesAtPosition(e){return this.client.getPropertiesAtPosition(e)}getRangeExtentsOfPosition(e){return this.client.getRangeExtentsOfPosition(e)}createPositionReference(e,t,i){const s=new d.a(this.client,e,t,i);return i!==l.b.Transient&&this.addLocalReference(s),s}createLocalReferencePosition(e,t,i,s){return this.client.createLocalReferencePosition(e,t,i,s)}localRefToPos(e){return this.client.localReferencePositionToPosition(e)}localReferencePositionToPosition(e){return this.client.localReferencePositionToPosition(e)}resolveRemoteClientPosition(e,t,i){return this.client.resolveRemoteClientPosition(e,t,i)}submitSequenceMessage(e){if(!this.isAttached())return;const t=Object(f.b)(e,this.serializer,this.handle),i=this.client.peekPendingSegmentGroups(e.type===l.a.GROUP?e.ops.length:1);this.loadedDeferred.isCompleted?this.submitLocalMessage(t,i):this.loadedDeferredOutgoingOps.push([t,i])}addLocalReference(e){return this.client.addLocalReference(e)}removeLocalReference(e){return this.client.removeLocalReferencePosition(e)}removeLocalReferencePosition(e){return this.client.removeLocalReferencePosition(e)}posFromRelativePos(e){return this.client.posFromRelativePos(e)}walkSegments(e,t,i,s,n=!1){return this.client.walkSegments(e,t,i,s,n)}getStackContext(e,t){return this.client.getStackContext(e,t)}getCurrentSeq(){return this.client.getCurrentSeq()}insertAtReferencePosition(e,t){const i=this.client.insertAtReferencePositionLocal(e,t);i&&this.submitSequenceMessage(i)}async waitIntervalCollection(e){return this.intervalCollections.get(e)}getIntervalCollection(e){return this.intervalCollections.get(e)}getIntervalCollectionLabels(){return this.intervalCollections.keys()}summarizeCore(e,t){const i=new m.a;return this.intervalCollections.size>0&&i.addBlob("header",this.intervalCollections.serialize(e)),i.addWithStats("content",this.summarizeMergeTree(e)),i.getSummaryTree()}processGCDataCore(e){this.intervalCollections.size>0&&this.intervalCollections.serialize(e),this.client.serializeGCData(this.handle,e)}replaceRange(e,t,i){const s=Math.max(e,t),n=this.client.insertSegmentLocal(s,i);if(n)if(e<t){const i=this.client.removeRangeLocal(e,t);this.submitSequenceMessage(Object(u.c)(n,i))}else this.submitSequenceMessage(n)}onConnect(){this.client.startOrUpdateCollaboration(this.runtime.clientId)}onDisconnect(){}reSubmitCore(e,t){this.intervalCollections.tryResubmitMessage(e,t)||this.submitSequenceMessage(this.client.regeneratePendingOp(e,t))}async loadCore(e){var t;if(await e.contains("header")){const t=await e.readBlob("header"),i=Object(n.c)(t,"utf8");this.intervalCollections.populate(i)}try{const{catchupOpsP:i}=await this.client.load(this.runtime,new g.a(e,"content"),this.serializer),s=i.then(e=>{e.forEach(e=>{const t=this.client.getCollabWindow();if(e.minimumSequenceNumber<t.minSeq||e.referenceSequenceNumber<t.minSeq||e.sequenceNumber<=t.minSeq||e.sequenceNumber<=t.currentSeq)throw new Error("Invalid catchup operations in snapshot: "+JSON.stringify({op:{seq:e.sequenceNumber,minSeq:e.minimumSequenceNumber,refSeq:e.referenceSequenceNumber},collabWindow:{seq:t.currentSeq,minSeq:t.minSeq}}));this.processMergeTreeMsg(e)}),this.loadFinished()}).catch(e=>{this.loadFinished(e)});!0!==(null===(t=this.dataStoreRuntime.options)||void 0===t?void 0:t.sequenceInitializeFromHeaderOnly)&&await s}catch(i){this.loadFinished(i)}}processCore(e,t,i){if(this.deferIncomingOps)Object(r.a)(!t,114),this.loadedDeferredIncomingOps.push(e);else{Object(r.a)(e.type===o.a.Operation,115);this.intervalCollections.tryProcessMessage(e.contents,t,e,i)||this.processMergeTreeMsg(e,t)}}didAttach(){var e;this.isAttached()&&this.client.startOrUpdateCollaboration(null!==(e=this.runtime.clientId)&&void 0!==e?e:"attached")}initializeLocalCore(){super.initializeLocalCore(),this.loadFinished()}applyStashedOp(e){return this.client.applyStashedOp(e)}summarizeMergeTree(e){Object(r.a)(this.loadedDeferred.isCompleted,116);const t=this.runtime.deltaManager.minimumSequenceNumber;return this.processMinSequenceNumberChanged(t),this.messagesSinceMSNChange.forEach(e=>{e.minimumSequenceNumber=t}),this.client.summarize(this.runtime,this.handle,e,this.messagesSinceMSNChange)}processMergeTreeMsg(e,t){var i,s;const n=Object(f.c)(e,this.serializer),r=[];function a(e){r.push(...y.createOpsFromDelta(e))}const o=n.referenceSequenceNumber!==n.sequenceNumber-1;let c=n;!0!==(null===(i=this.runtime.options)||void 0===i?void 0:i.newMergeTreeSnapshotFormat)&&o&&this.on("sequenceDelta",a),this.client.applyMsg(n,t),!0!==(null===(s=this.runtime.options)||void 0===s?void 0:s.newMergeTreeSnapshotFormat)&&(o&&(this.removeListener("sequenceDelta",a),c=Object.assign(Object.assign({},n),{referenceSequenceNumber:c.sequenceNumber-1,contents:1!==r.length?Object(u.c)(...r):r[0]})),this.messagesSinceMSNChange.push(c),this.messagesSinceMSNChange.length>20&&this.messagesSinceMSNChange[20].sequenceNumber<n.minimumSequenceNumber&&this.processMinSequenceNumberChanged(n.minimumSequenceNumber))}processMinSequenceNumberChanged(e){let t=0;for(;t<this.messagesSinceMSNChange.length&&!(this.messagesSinceMSNChange[t].sequenceNumber>e);t++);0!==t&&(this.messagesSinceMSNChange=this.messagesSinceMSNChange.slice(t))}loadFinished(e){if(!this.loadedDeferred.isCompleted){if(this.initializeIntervalCollections(),e)throw this.loadedDeferred.reject(e),e;this.deferIncomingOps=!1;for(const e of this.loadedDeferredIncomingOps)this.processCore(e,!1,void 0);this.loadedDeferredIncomingOps.length=0,this.loadedDeferred.resolve();for(const[e,t]of this.loadedDeferredOutgoingOps)this.reSubmitCore(e,t);this.loadedDeferredOutgoingOps.length=0}}initializeIntervalCollections(){this.intervalCollections.eventEmitter.on("create",({key:e,previousValue:t},i)=>{const s=this.intervalCollections.get(e);s.attached||s.attachGraph(this.client,e),Object(r.a)(void 0===t,705),this.emit("createIntervalCollection",e,i,this)});for(const e of this.intervalCollections.keys()){this.intervalCollections.get(e).attachGraph(this.client,e)}}}},28929:function(e,t,i){"use strict";i.d(t,"a",(function(){return S}));var s=i(28849),n=i(28906),r=i(28824),a=i(28868),o=i(28829),c=i(28919),l=i(28916),h=i(28926),u=i(28915),d=i(28930),m=i(28918),g=i(28933),p=i(28935),f=i(28931),b=i(28932);function v(e){return 1e3*e.trace().duration}class S{constructor(e,t,i){this.specToSegment=e,this.logger=t,this.measureOps=!1,this.accumTime=0,this.localTime=0,this.localOps=0,this.accumWindowTime=0,this.accumWindow=0,this.accumOps=0,this.maxWindowTime=0,this.clientNameToIds=new c.e(u.e),this.shortClientIdMap=[],this.pendingConsensus=new Map,this.mergeTree=new u.c(i)}get mergeTreeDeltaCallback(){return this.mergeTree.mergeTreeDeltaCallback}set mergeTreeDeltaCallback(e){this.mergeTree.mergeTreeDeltaCallback=e}get mergeTreeMaintenanceCallback(){return this.mergeTree.mergeTreeMaintenanceCallback}set mergeTreeMaintenanceCallback(e){this.mergeTree.mergeTreeMaintenanceCallback=e}peekPendingSegmentGroups(e=1){var t,i;if(1===e)return null===(t=this.mergeTree.pendingSegments)||void 0===t?void 0:t.last();let s=0;return null===(i=this.mergeTree.pendingSegments)||void 0===i?void 0:i.some(()=>s<e&&(s++,!0),!0)}annotateMarkerNotifyConsensus(e,t,i){const s=this.annotateMarker(e,t,{name:"consensus"});if(s){const t={callback:i,marker:e};return this.pendingConsensus.set(e.getId(),t),s}}annotateMarker(e,t,i){const s=Object(d.a)(e,t,i);return this.applyAnnotateRangeOp({op:s})?s:void 0}annotateRangeLocal(e,t,i,s){const n=Object(d.b)(e,t,i,s);if(this.applyAnnotateRangeOp({op:n}))return n}removeRangeLocal(e,t){const i=Object(d.f)(e,t);if(this.applyRemoveRangeOp({op:i}))return i}insertSegmentLocal(e,t){if(t.cachedLength<=0)return;const i=Object(d.e)(e,t);return this.applyInsertOp({op:i})?i:void 0}insertAtReferencePositionLocal(e,t){const i=this.mergeTree.referencePositionToLocalPosition(e,this.getCurrentSeq(),this.getClientId());if(i===h.a.DetachedPosition)return;const s=Object(d.e)(i,t),r={op:s};let a;return this.measureOps&&(a=n.a.start()),this.mergeTree.insertAtReferencePosition(e,t,r),this.completeAndLogOp(r,this.getClientSequenceArgs(r),{start:s.pos1},a),s}walkSegments(e,t,i,s,n=!1){this.mergeTree.mapRange({leaf:e},this.getCurrentSeq(),this.getClientId(),s,t,i,n)}serializeGCData(e,t){this.mergeTree.walkAllSegments(this.mergeTree.root,i=>(void 0===i.removedSeq&&t.stringify(i.clone().toJSONObject(),e),!0))}getCollabWindow(){return this.mergeTree.getCollabWindow()}getPosition(e){return void 0===(null==e?void 0:e.parent)?-1:this.mergeTree.getPosition(e,this.getCurrentSeq(),this.getClientId())}addLocalReference(e){return this.mergeTree.addLocalReference(e)}removeLocalReference(e){return this.removeLocalReferencePosition(e)}createLocalReferencePosition(e,t,i,s){return this.mergeTree.createLocalReferencePosition(e,t,i,s,this)}removeLocalReferencePosition(e){return this.mergeTree.removeLocalReferencePosition(e)}localReferencePositionToPosition(e){return this.mergeTree.referencePositionToLocalPosition(e)}posFromRelativePos(e){return this.mergeTree.posFromRelativePos(e)}getMarkerFromId(e){return this.mergeTree.getMarkerFromId(e)}applyRemoveRangeOp(e){Object(r.a)(e.op.type===m.a.REMOVE,45);const t=e.op,i=this.getClientSequenceArgs(e),s=this.getValidOpRange(t,i);if(!s)return!1;let a;return this.measureOps&&(a=n.a.start()),this.mergeTree.markRangeRemoved(s.start,s.end,i.referenceSequenceNumber,i.clientId,i.sequenceNumber,!1,e),this.completeAndLogOp(e,i,s,a),!0}applyAnnotateRangeOp(e){Object(r.a)(e.op.type===m.a.ANNOTATE,46);const t=e.op,i=this.getClientSequenceArgs(e),s=this.getValidOpRange(t,i);if(!s)return!1;let a;return this.measureOps&&(a=n.a.start()),this.mergeTree.annotateRange(s.start,s.end,t.props,t.combiningOp,i.referenceSequenceNumber,i.clientId,i.sequenceNumber,e),this.completeAndLogOp(e,i,s,a),!0}applyInsertOp(e){Object(r.a)(e.op.type===m.a.INSERT,47);const t=e.op,i=this.getClientSequenceArgs(e),s=this.getValidOpRange(t,i);if(!s)return!1;let a,o;return t.seg&&(a=[this.specToSegment(t.seg)]),!(!a||0===a.length)&&(this.measureOps&&(o=n.a.start()),this.mergeTree.insertSegments(s.start,a,i.referenceSequenceNumber,i.clientId,i.sequenceNumber,e),this.completeAndLogOp(e,i,s,o),!0)}completeAndLogOp(e,t,i,s){e.sequencedMessage?(Object(r.a)(this.mergeTree.getCollabWindow().currentSeq<t.sequenceNumber,48),Object(r.a)(this.mergeTree.getCollabWindow().minSeq<=e.sequencedMessage.minimumSequenceNumber,49),s&&(this.accumTime+=v(s),this.accumOps++,this.accumWindow+=this.getCurrentSeq()-this.getCollabWindow().minSeq)):s&&(this.localTime+=v(s),this.localOps++)}getValidOpRange(e,t){let i=e.pos1;void 0===i&&e.relativePos1&&(i=this.mergeTree.posFromRelativePos(e.relativePos1,t.referenceSequenceNumber,t.clientId));let s=e.pos2;if(void 0===s&&e.relativePos2&&(s=this.mergeTree.posFromRelativePos(e.relativePos2,t.referenceSequenceNumber,t.clientId)),t.clientId===this.getClientId()){const t=this.getLength(),n=[];if((void 0===i||i<0||i>t||i===t&&e.type!==m.a.INSERT)&&n.push("start"),e.type===m.a.INSERT&&void 0===s||(void 0===s||s<=i)&&n.push("end"),n.length>0)throw new o.a("RangeOutOfBounds",{usageError:!0,end:s,invalidPositions:n.toString(),length:t,opPos1:e.pos1,opPos1Relative:void 0!==e.relativePos1,opPos2:e.pos2,opPos2Relative:void 0!==e.relativePos2,opType:e.type,start:i})}return{start:i,end:s}}getClientSequenceArgsForMessage(e){if(e)return{clientId:this.getOrAddShortClientId(e.clientId),referenceSequenceNumber:e.referenceSequenceNumber,sequenceNumber:e.sequenceNumber};{const e=this.getCollabWindow();return{clientId:e.clientId,referenceSequenceNumber:e.currentSeq,sequenceNumber:this.getLocalSequenceNumber()}}}getClientSequenceArgs(e){return this.getClientSequenceArgsForMessage(e.sequencedMessage)}ackPendingSegment(e){const t=e=>{let t;this.measureOps&&(t=n.a.start()),this.mergeTree.ackPendingSegment(e),e.op.type===m.a.ANNOTATE&&e.op.combiningOp&&"consensus"===e.op.combiningOp.name&&this.updateConsensusProperty(e.op,e.sequencedMessage),t&&(this.accumTime+=v(t),this.accumOps++,this.accumWindow+=this.getCurrentSeq()-this.getCollabWindow().minSeq)};if(e.op.type===m.a.GROUP)for(const i of e.op.ops)t({groupOp:e.op,op:i,sequencedMessage:e.sequencedMessage});else t(e)}cloneFromSegments(){const e=new S(this.specToSegment,this.logger,this.mergeTree.options),t=this.mergeTree.blockClone(this.mergeTree.root,[]);return e.mergeTree.root=t,e}getOrAddShortClientId(e){return this.clientNameToIds.get(e)||this.addLongClientId(e),this.getShortClientId(e)}getShortClientId(e){return this.clientNameToIds.get(e).data}getLongClientId(e){return e>=0?this.shortClientIdMap[e]:"original"}addLongClientId(e){this.clientNameToIds.put(e,this.shortClientIdMap.length),this.shortClientIdMap.push(e)}findReconnectionPosition(e,t){Object(r.a)(t<=this.mergeTree.collabWindow.localSeq,50);let i=0;return this.mergeTree.walkAllSegments(this.mergeTree.root,s=>s!==e&&((void 0===s.localSeq||s.localSeq<=t)&&(void 0===s.removedSeq||s.localRemovedSeq>t)&&(i+=s.cachedLength),!0)),i}rebasePosition(e,t,i){let s;Object(r.a)(i<=this.mergeTree.collabWindow.localSeq,768);let n=0,a=e;this.mergeTree.walkAllSegments(this.mergeTree.root,o=>(Object(r.a)(void 0!==o.seq||void 0!==o.localSeq,769),s=o,(e=>void 0!==e.seq&&e.seq!==l.d&&e.seq<=t||void 0!==e.localSeq&&e.localSeq<=i)(o)&&!(({removedSeq:e,localRemovedSeq:s})=>void 0!==e&&e!==l.d&&e<=t||void 0!==s&&s<=i)(o)&&(n+=o.cachedLength,a>=o.cachedLength&&(a-=o.cachedLength)),n<=e)),Object(r.a)(void 0!==s,770);const o=this.getCollabWindow().currentSeq;return(void 0!==s.removedSeq&&s.removedSeq!==l.d&&s.removedSeq<=o||void 0!==s.localRemovedSeq&&s.localRemovedSeq<=i)&&(a=0),Object(r.a)(0<=a&&a<s.cachedLength,771),this.findReconnectionPosition(s,i)+a}resetPendingDeltaToOps(e,t){var i,s;Object(r.a)(!!t,51);const n=null===(i=this.mergeTree.pendingSegments)||void 0===i?void 0:i.dequeue();Object(r.a)(t===n,52);const a=[];for(const o of t.segments.sort((e,t)=>e.ordinal<t.ordinal?-1:1)){const i=o.segmentGroups.dequeue();Object(r.a)(t===i,53);const n=this.findReconnectionPosition(o,t.localSeq);let c;switch(e.type){case m.a.ANNOTATE:Object(r.a)(!0===(null===(s=o.propertyManager)||void 0===s?void 0:s.hasPendingProperties()),54),void 0!==o.removedSeq&&void 0===o.localRemovedSeq||(c=Object(d.b)(n,n+o.cachedLength,e.props,e.combiningOp));break;case m.a.INSERT:Object(r.a)(o.seq===l.d,55);let t=o;"object"==typeof e.seg&&void 0!==e.seg.props&&(t=o.clone(),t.properties=e.seg.props),c=Object(d.e)(n,t);break;case m.a.REMOVE:void 0!==o.localRemovedSeq&&(c=Object(d.f)(n,n+o.cachedLength));break;default:throw new Error("Invalid op type")}if(c){const e={segments:[],localSeq:t.localSeq};o.segmentGroups.enqueue(e),this.mergeTree.pendingSegments.enqueue(e),a.push(c)}}return a}applyRemoteOp(e){const t=e.op,i=e.sequencedMessage;switch(this.getOrAddShortClientId(i.clientId),t.type){case m.a.INSERT:this.applyInsertOp(e);break;case m.a.REMOVE:this.applyRemoveRangeOp(e);break;case m.a.ANNOTATE:this.applyAnnotateRangeOp(e);break;case m.a.GROUP:for(const e of t.ops)this.applyRemoteOp({op:e,groupOp:t,sequencedMessage:i})}}applyStashedOp(e){let t;switch(e.type){case m.a.INSERT:this.applyInsertOp({op:e}),t=this.peekPendingSegmentGroups();break;case m.a.REMOVE:this.applyRemoveRangeOp({op:e}),t=this.peekPendingSegmentGroups();break;case m.a.ANNOTATE:this.applyAnnotateRangeOp({op:e}),t=this.peekPendingSegmentGroups();break;case m.a.GROUP:return e.ops.map(e=>this.applyStashedOp(e));default:Object(a.a)(e,"unrecognized op type")}return Object(r.a)(!!t,731),t}applyMsg(e,t=!1){var i;if(this.getOrAddShortClientId(e.clientId),e.type===s.a.Operation){const s={op:e.contents,sequencedMessage:e};(null===(i=s.sequencedMessage)||void 0===i?void 0:i.clientId)===this.longClientId||t?this.ackPendingSegment(s):this.applyRemoteOp(s)}this.updateSeqNumbers(e.minimumSequenceNumber,e.sequenceNumber)}updateSeqNumbers(e,t){const i=this.mergeTree.getCollabWindow();Object(r.a)(i.currentSeq<=t,56),i.currentSeq=t,Object(r.a)(e<=t,57),this.updateMinSeq(e)}resolveRemoteClientPosition(e,t,i){const s=this.getOrAddShortClientId(i);return this.mergeTree.resolveRemoteClientPosition(e,t,s)}regeneratePendingOp(e,t){const i=[];if(e.type===m.a.GROUP)if(Array.isArray(t)){Object(r.a)(e.ops.length===t.length,58);for(let s=0;s<e.ops.length;s++)i.push(...this.resetPendingDeltaToOps(e.ops[s],t[s]))}else Object(r.a)(1===e.ops.length,59),i.push(...this.resetPendingDeltaToOps(e.ops[0],t));else Object(r.a)(e.type!==m.a.GROUP,60),Object(r.a)(!Array.isArray(t),61),i.push(...this.resetPendingDeltaToOps(e,t));return 1===i.length?i[0]:Object(d.c)(...i)}createTextHelper(){return new f.a(this.mergeTree)}summarize(e,t,i,s){var n;const a=e.deltaManager,o=a.minimumSequenceNumber;if(this.updateSeqNumbers(o,a.lastSequenceNumber),Object(r.a)(this.getCollabWindow().minSeq===o,62),!0===(null===(n=this.mergeTree.options)||void 0===n?void 0:n.newMergeTreeSnapshotFormat)){Object(r.a)(void 0===s||0===s.length,63);const e=new b.a(this.mergeTree,this.logger,e=>this.getLongClientId(e));return e.extractSync(),e.emit(i,t)}{const e=new g.a(this.mergeTree,this.logger);return e.extractSync(),e.emit(s,i,t)}}async load(e,t,i){return new p.a(e,this,this.mergeTree,this.logger,i).initialize(t)}getStackContext(e,t){return this.mergeTree.getStackContext(e,this.getCollabWindow().clientId,t)}getLocalSequenceNumber(){return this.getCollabWindow().collaborating?l.d:l.e}localTransaction(e){for(const t of e.ops){const i={op:t,groupOp:e};switch(t.type){case m.a.INSERT:this.applyInsertOp(i);break;case m.a.ANNOTATE:this.applyAnnotateRangeOp(i);break;case m.a.REMOVE:this.applyRemoveRangeOp(i)}}}updateConsensusProperty(e,t){const i=e.relativePos1.id,s=this.pendingConsensus.get(i);s&&s.marker.addProperties(e.props,e.combiningOp,t.sequenceNumber),this.mergeTree.addMinSeqListener(t.sequenceNumber,()=>s.callback(s.marker))}updateMinSeq(e){let t;if(this.measureOps&&(t=n.a.start()),this.mergeTree.setMinSeq(e),t){const e=v(t);this.accumWindowTime+=e,e>this.maxWindowTime&&(this.maxWindowTime=e)}}getContainingSegment(e,t){const i=this.getClientSequenceArgsForMessage(t);return this.mergeTree.getContainingSegment(e,i.referenceSequenceNumber,i.clientId)}getSlideToSegment(e){return this.mergeTree._getSlideToSegment(e)}getPropertiesAtPosition(e){let t;const i=this.getContainingSegment(e).segment;return i&&(t=i.properties),t}getRangeExtentsOfPosition(e){let t,i;const s=this.getContainingSegment(e).segment;return s&&(t=this.getPosition(s),i=t+s.cachedLength),{posStart:t,posAfterEnd:i}}getCurrentSeq(){return this.getCollabWindow().currentSeq}getClientId(){return this.getCollabWindow().clientId}getLength(){return this.mergeTree.length}startOrUpdateCollaboration(e,t=0,i=0){if(void 0!==e)if(void 0===this.longClientId)this.longClientId=e,this.addLongClientId(this.longClientId),this.mergeTree.startCollaboration(this.getShortClientId(this.longClientId),t,i);else{const t=this.longClientId,i=this.clientNameToIds.get(t).data;this.longClientId=e,this.clientNameToIds.put(e,i),this.shortClientIdMap[i]=e}}findTile(e,t,i=!0){const s=this.getClientId();return this.mergeTree.findTile(e,s,t,i)}}},28930:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r})),i.d(t,"f",(function(){return a})),i.d(t,"e",(function(){return o})),i.d(t,"d",(function(){return c})),i.d(t,"c",(function(){return l}));var s=i(28918);function n(e,t,i){const n=e.getId();if(n)return{combiningOp:i,props:t,relativePos1:{id:n,before:!0},relativePos2:{id:n},type:s.a.ANNOTATE}}function r(e,t,i,n){return{combiningOp:n,pos1:e,pos2:t,props:i,type:s.a.ANNOTATE}}function a(e,t){return{pos1:e,pos2:t,type:s.a.REMOVE}}function o(e,t){return c(e,t.toJSONObject())}function c(e,t){return{pos1:e,seg:t,type:s.a.INSERT}}function l(...e){return{ops:e,type:s.a.GROUP}}},28931:function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return o}));var s=i(28915),n=i(28926);class r extends s.a{constructor(e){super(),this.text=e,this.type=r.type,this.cachedLength=e.length}static is(e){return e.type===r.type}static make(e,t){const i=new r(e);return t&&i.addProperties(t),i}static fromJSONObject(e){if("string"==typeof e)return new r(e);if(e&&"object"==typeof e&&"text"in e){const t=e;return r.make(t.text,t.props)}}toJSONObject(){return this.properties?{text:this.text,props:this.properties}:this.text}clone(e=0,t){const i=this.text.substring(e,t),s=r.make(i,this.properties);return this.cloneInto(s),s}canAppend(e){return!this.text.endsWith("\n")&&r.is(e)&&(this.cachedLength<=256||e.cachedLength<=256)}toString(){return this.text}append(e){if(!r.is(e))throw new Error("can only append text segment");n.b.append(this,e),this.text+=e.text,this.cachedLength=this.text.length}removeRange(e,t){let i="";const s=this.text.length;return e>0&&(i+=this.text.substring(0,e)),t<s&&(i+=this.text.substring(t)),this.text=i,this.cachedLength=i.length,0===i.length}createSplitSegmentAt(e){if(e>0){const t=this.text.substring(e);this.text=this.text.substring(0,e),this.cachedLength=this.text.length;return new r(t)}}}function a(e){return!0===e.parallelArrays}r.type="TextSegment";class o{constructor(e){this.mergeTree=e,this.gatherText=(e,t,i,s,n,o,c)=>{var l,h;let u=n;if(r.is(e)){let t="",i="";if(a(c)){const s=[],n=[];(null===(l=e.properties)||void 0===l?void 0:l["font-weight"])&&s.push("b"),(null===(h=e.properties)||void 0===h?void 0:h["text-decoration"])&&s.push("u");const r=[];if(s.length>0){for(const e of s)c.tagsInProgress.includes(e)||(t+=`<${e}>`,n.push(e));for(const e of c.tagsInProgress)s.includes(e)||(i+=`</${e}>`,r.push(e));for(const e of n.reverse())c.tagsInProgress.push(e)}else for(const e of c.tagsInProgress)i+=`</${e}>`,r.push(e);for(const e of r){const t=c.tagsInProgress.indexOf(e);t>=0&&c.tagsInProgress.splice(t,1)}}c.textSegment.text+=i,c.textSegment.text+=t,u<=0&&o>=e.text.length?c.textSegment.text+=e.text:(u<0&&(u=0),o>=e.text.length?c.textSegment.text+=e.text.substring(u):c.textSegment.text+=e.text.substring(u,o))}else if(c.placeholder&&c.placeholder.length>0)if("*"===c.placeholder){const t=e;c.textSegment.text+="\n"+t.toString()}else for(let r=0;r<e.cachedLength;r++)c.textSegment.text+=c.placeholder;else if(a(c)){const t=e;t.hasTileLabel(c.parallelMarkerLabel)&&(c.parallelMarkers.push(t),c.parallelText.push(c.textSegment.text),c.textSegment.text="")}return!0}}getTextAndMarkers(e,t,i,s,n){const a=this.getValidRange(s,n,e,t),o={parallelArrays:!0,parallelMarkerLabel:i,parallelMarkers:[],parallelText:[],tagsInProgress:[],textSegment:new r("")};return this.mergeTree.mapRange({leaf:this.gatherText},e,t,o,a.start,a.end),{parallelText:o.parallelText,parallelMarkers:o.parallelMarkers}}getText(e,t,i="",s,n){const a=this.getValidRange(s,n,e,t),o={textSegment:new r(""),placeholder:i};return this.mergeTree.mapRange({leaf:this.gatherText},e,t,o,a.start,a.end),o.textSegment.text}getValidRange(e,t,i,s){return{end:null!=t?t:this.mergeTree.getLength(i,s),start:null!=e?e:0}}}},28932:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var s=i(28824),n=i(28862),r=i(28828),a=i(28870),o=i(28916),c=i(28920),l=i(28934),h=i(28933);class u{constructor(e,t,i,s,n){var a,o;this.mergeTree=e,this.getLongClientId=i,this.filename=s,this.onCompletion=n,this.logger=r.a.create(t,"Snapshot"),this.chunkSize=null!==(o=null===(a=null==e?void 0:e.options)||void 0===a?void 0:a.mergeTreeSnapshotChunkSize)&&void 0!==o?o:u.chunkSize;const{currentSeq:c,minSeq:l}=e.getCollabWindow();this.header={minSequenceNumber:l,sequenceNumber:c,orderedChunkMetadata:[],totalLength:0,totalSegmentCount:0},this.segments=[],this.segmentLengths=[]}getSeqLengthSegs(e,t,i,s=0){const n=[];let r=0,a=0;for(;r<i&&s+a<e.length;){const i=e[s+a];n.push(i),r+=t[s+a],a++}return{version:"1",segmentCount:a,length:r,segments:n,startIndex:s,headerMetadata:void 0}}emit(e,t){const i=[];this.header.totalSegmentCount=0,this.header.totalLength=0;do{const e=this.getSeqLengthSegs(this.segments,this.segmentLengths,this.chunkSize,this.header.totalSegmentCount);i.push(e),this.header.totalSegmentCount+=e.segmentCount,this.header.totalLength+=e.length}while(this.header.totalSegmentCount<this.segments.length);const s=i.shift();s.headerMetadata=this.header,s.headerMetadata.orderedChunkMetadata=[{id:h.a.header}];const n=[];i.forEach((i,s)=>{const r=`${h.a.body}_${s}`;this.header.orderedChunkMetadata.push({id:r}),n.push([r,Object(l.b)(r,i,this.logger,this.mergeTree.options,e,t)])});const r=new a.a;return r.addBlob(h.a.header,Object(l.b)(h.a.header,s,this.logger,this.mergeTree.options,e,t)),n.forEach(e=>{r.addBlob(e[0],e[1])}),r.getSummaryTree()}extractSync(){const e=this.mergeTree,t=this.header.minSequenceNumber,i=(e,t)=>{this.segments.push(e),this.segmentLengths.push(t)},n=e=>{e&&i(e.toJSONObject(),e.cachedLength)};let r;return e.walkAllSegments(e.root,e=>{var a;if(e.seq===o.d||e.removedSeq<=t)return!0;if(e.seq<=t&&(void 0===e.removedSeq||e.removedSeq===o.d))r?r.canAppend(e)&&Object(c.g)(r.properties,e.properties)?(r=r.clone(),r.append(e.clone())):(n(r),r=e):r=e;else{n(r),r=void 0;const c={json:e.toJSONObject()};e.seq>t&&(c.seq=e.seq,c.client=this.getLongClientId(e.clientId)),void 0!==e.removedSeq&&(Object(s.a)(e.removedSeq!==o.d&&e.removedSeq>t,101),c.removedSeq=e.removedSeq,c.removedClient=void 0!==e.removedClientIds?this.getLongClientId(e.removedClientIds[0]):void 0,c.removedClientIds=null===(a=e.removedClientIds)||void 0===a?void 0:a.map(e=>this.getLongClientId(e))),Object(s.a)(void 0!==c.seq&&void 0!==c.client||void 0!==c.removedSeq&&void 0!==c.removedClient,102),i(c,e.cachedLength)}return!0},this),n(r),this.segments}static async loadChunk(e,t,i,s,r){const a=await e.readBlob(t),o=Object(n.c)(a,"utf8");return u.processChunk(t,o,i,s,r)}static processChunk(e,t,i,s,n){const r=n?n.parse(t):JSON.parse(t);return Object(l.d)(e,r,i,s)}}u.chunkSize=1e4},28933:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var s=i(28824),n=i(28828),r=i(28870),a=i(28916),o=i(28920),c=i(28934);class l{constructor(e,t,i,s){var r,a;this.mergeTree=e,this.filename=i,this.onCompletion=s,this.logger=n.a.create(t,"Snapshot"),this.chunkSize=null!==(a=null===(r=null==e?void 0:e.options)||void 0===r?void 0:r.mergeTreeSnapshotChunkSize)&&void 0!==a?a:l.sizeOfFirstChunk}getSeqLengthSegs(e,t,i,s=0){const n=[];let r=0,a=0;for(;r<i&&s+a<e.length;){const i=e[s+a];n.push(i),r+=t[s+a],a++}return{version:void 0,chunkStartSegmentIndex:s,chunkSegmentCount:a,chunkLengthChars:r,totalLengthChars:this.header.segmentsTotalLength,totalSegmentCount:e.length,chunkSequenceNumber:this.header.seq,segmentTexts:n}}emit(e,t,i){var n,a;const o=this.getSeqLengthSegs(this.segments,this.segmentLengths,this.chunkSize);let h=o.chunkLengthChars,u=o.chunkSegmentCount;const d=new r.a;if(d.addBlob(l.header,Object(c.c)(l.header,o,this.logger,this.mergeTree.options,t,i)),o.chunkSegmentCount<o.totalSegmentCount){const e=this.getSeqLengthSegs(this.segments,this.segmentLengths,this.header.segmentsTotalLength,o.chunkSegmentCount);h+=e.chunkLengthChars,u+=e.chunkSegmentCount,d.addBlob(l.body,Object(c.c)(l.body,e,this.logger,this.mergeTree.options,t,i))}return Object(s.a)(h===this.header.segmentsTotalLength,93),Object(s.a)(u===o.totalSegmentCount,94),void 0!==e&&e.length>0&&d.addBlob(null!==(a=null===(n=this.mergeTree.options)||void 0===n?void 0:n.catchUpBlobName)&&void 0!==a?a:l.catchupOps,t?t.stringify(e,i):JSON.stringify(e)),d.getSummaryTree()}extractSync(){const e=this.mergeTree.getCollabWindow();this.seq=e.minSeq,this.header={segmentsTotalLength:this.mergeTree.getLength(this.mergeTree.collabWindow.minSeq,a.b),seq:this.mergeTree.collabWindow.minSeq};const t=[];let i;this.mergeTree.map({leaf:(e,s,n,r,c,l)=>(e.seq!==a.d&&e.seq<=this.seq&&(void 0===e.removedSeq||e.removedSeq===a.d||e.removedSeq>this.seq)&&((null==i?void 0:i.canAppend(e))&&Object(o.g)(i.properties,e.properties)?(i=i.clone(),i.append(e.clone())):(i&&t.push(i),i=e)),!0)},this.seq,a.b,void 0),i&&t.push(i),this.segments=[],this.segmentLengths=[];let s=0;return t.map(e=>{s+=e.cachedLength,this.segments.push(e.toJSONObject()),this.segmentLengths.push(e.cachedLength)}),this.header.segmentsTotalLength!==s&&(this.logger.sendErrorEvent({eventName:"SegmentsTotalLengthMismatch",totalLength:s,segmentsTotalLength:this.header.segmentsTotalLength}),this.header.segmentsTotalLength=s),this.segments}}l.header="header",l.body="body",l.catchupOps="catchupOps",l.sizeOfFirstChunk=1e4},28934:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"c",(function(){return r})),i.d(t,"b",(function(){return a})),i.d(t,"d",(function(){return o}));var s=i(28933);function n(e){return!!e&&"object"==typeof e&&"json"in e}function r(e,t,i,n,r,a){let o;switch(void 0!==t.version&&i.send({eventName:"MergeTreeChunk:serializeAsMinSupportedVersion",category:"generic",fromChunkVersion:t.version,toChunkVersion:void 0}),t.version){case void 0:o=t,o.headerMetadata=c(e,o,n);break;case"1":const i=t,r=e===s.a.header?i.headerMetadata:void 0;o={version:void 0,chunkStartSegmentIndex:i.startIndex,chunkLengthChars:i.length,chunkSegmentCount:i.segmentCount,segmentTexts:i.segments,totalLengthChars:null==r?void 0:r.totalLength,totalSegmentCount:null==r?void 0:r.totalSegmentCount,chunkSequenceNumber:null==r?void 0:r.sequenceNumber,chunkMinSequenceNumber:null==r?void 0:r.minSequenceNumber,headerMetadata:r};break;default:throw new Error(`Unsupported chunk path: ${e} version: ${t.version}`)}return r.stringify(o,a)}function a(e,t,i,s,n,r){const a=o(e,t,i,s);return n.stringify(a,r)}function o(e,t,i,s){switch(t.version){case void 0:{const i=t;return{version:"1",length:i.chunkLengthChars,segmentCount:i.chunkSegmentCount,headerMetadata:c(e,i,s),segments:i.segmentTexts,startIndex:i.chunkStartSegmentIndex}}case"1":return t;default:throw new Error(`Unsupported chunk path: ${e} version: ${t.version}`)}}function c(e,t,i){if(e===s.a.header){if(void 0!==t.headerMetadata)return t.headerMetadata;const e=[{id:s.a.header}];return t.chunkLengthChars<t.totalLengthChars&&e.push({id:s.a.body}),{orderedChunkMetadata:e,minSequenceNumber:t.chunkMinSequenceNumber,sequenceNumber:t.chunkSequenceNumber,totalLength:t.totalLengthChars,totalSegmentCount:t.totalSegmentCount}}}},28935:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var s=i(28824),n=i(28862),r=i(28828),a=i(28838),o=i(28916),c=i(28934),l=i(28932),h=i(28933);class u{constructor(e,t,i,s,n){this.runtime=e,this.client=t,this.mergeTree=i,this.serializer=n,this.specToSegment=e=>{var t;let i;return Object(c.a)(e)?(i=this.client.specToSegment(e.json),i.clientId=void 0!==e.client?this.client.getOrAddShortClientId(e.client):o.b,i.seq=void 0!==e.seq?e.seq:o.e,void 0!==e.removedSeq&&(i.removedSeq=e.removedSeq),void 0!==e.removedClient&&(i.removedClientIds=[this.client.getOrAddShortClientId(e.removedClient)]),void 0!==e.removedClientIds&&(i.removedClientIds=null===(t=e.removedClientIds)||void 0===t?void 0:t.map(e=>this.client.getOrAddShortClientId(e)))):(i=this.client.specToSegment(e),i.seq=o.e,i.clientId=o.b),i},this.logger=r.a.create(s,"SnapshotLoader")}async initialize(e){const t=e.readBlob(h.a.header).then(e=>(Object(s.a)(!!e,95),this.loadHeader(Object(n.c)(e,"utf8")))),i=this.loadBodyAndCatchupOps(t,e);return i.catch(e=>this.logger.sendErrorEvent({eventName:"CatchupOpsLoadFailure"},e)),await t,{catchupOpsP:i}}async loadBodyAndCatchupOps(e,t){const i=t.list(""),n=await e;await this.loadBody(n,t);const r=await i;if(r.length===n.headerMetadata.orderedChunkMetadata.length+1)return n.headerMetadata.orderedChunkMetadata.forEach(e=>r.splice(r.indexOf(e.id),1)),Object(s.a)(1===r.length,96),this.loadCatchupOps(t.readBlob(r[0]));if(r.length!==n.headerMetadata.orderedChunkMetadata.length)throw new Error("Unexpected blobs in snapshot");return[]}loadHeader(e){var t;const i=l.a.processChunk(h.a.header,e,this.logger,this.mergeTree.options,this.serializer),s=i.segments.map(this.specToSegment);if(this.mergeTree.reloadFromSegments(s),void 0===i.headerMetadata)throw new Error("header metadata not available");return this.runtime.attachState!==a.a.Detached&&this.client.startOrUpdateCollaboration(null!==(t=this.runtime.clientId)&&void 0!==t?t:"snapshot",void 0!==i.headerMetadata.minSequenceNumber?i.headerMetadata.minSequenceNumber:i.headerMetadata.sequenceNumber,i.headerMetadata.sequenceNumber),i}async loadBody(e,t){if(Object(s.a)(e.length<=e.headerMetadata.totalLength,97),Object(s.a)(e.segmentCount<=e.headerMetadata.totalSegmentCount,98),e.segmentCount===e.headerMetadata.totalSegmentCount)return;const i=[];let n=e.length;for(let s=1;s<e.headerMetadata.orderedChunkMetadata.length;s++){const r=await l.a.loadChunk(t,e.headerMetadata.orderedChunkMetadata[s].id,this.logger,this.mergeTree.options,this.serializer);n+=r.length,i.push(...r.segments.map(this.specToSegment))}Object(s.a)(n===e.headerMetadata.totalLength,99),Object(s.a)(e.segmentCount+i.length===e.headerMetadata.totalSegmentCount,100);const r=this.mergeTree,a=(e,t,i)=>{r.insertSegments(r.root.cachedLength,e,o.e,t,i,void 0)},c=[],h=()=>{c.length>0&&a(c,o.b,o.e)};for(const s of i){const e=s.clientId,t=s.seq;e===o.b&&t===o.e?c.push(s):(h(),a([s],e,t))}h()}async loadCatchupOps(e){return JSON.parse(Object(n.c)(await e,"utf8"))}}},28936:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return o}));var s=i(28824),n=i(28923);class r{constructor(e,t){this.deltaArgs=e,this.mergeTreeClient=t,Object(s.a)(e.deltaSegments.length>0,728),this.isEmpty=!1,this.deltaOperation=e.operation,this.sortedRanges=new c(()=>{const e=new n.a;return this.deltaArgs.deltaSegments.forEach(t=>{const i={operation:this.deltaArgs.operation,position:this.mergeTreeClient.getPosition(t.segment),propertyDeltas:t.propertyDeltas,segment:t.segment};e.addOrUpdate(i)}),e}),this.pFirst=new c(()=>this.sortedRanges.value.items[0]),this.pLast=new c(()=>this.sortedRanges.value.items[this.sortedRanges.value.size-1])}get ranges(){return this.sortedRanges.value.items}get clientId(){return this.mergeTreeClient.longClientId}get first(){return this.pFirst.value}get last(){return this.pLast.value}}class a extends r{constructor(e,t,i){super(t,i),this.opArgs=e,this.isLocal=void 0===e.sequencedMessage}}class o extends r{constructor(e,t,i){super(t,i),this.opArgs=e}}class c{constructor(e){this.valueGenerator=e,this.pEvaluated=!1}get evaluated(){return this.pEvaluated}get value(){return this.pEvaluated||(this.pEvaluated=!0,this.pValue=this.valueGenerator()),this.pValue}}},28937:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var s=i(28911),n=i(28912),r=i(28823),a=i(28824),o=i(28938);class c{constructor(e,t,i,s,n=new r.a){this.serializer=e,this.handle=t,this.submitMessage=i,this.type=s,this.eventEmitter=n,this.messageHandlers=new Map,this.data=new Map,this.messageHandlers=this.getMessageHandlers()}get size(){return this.data.size}keys(){return this.data.keys()}entries(){const e=this.data.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}values(){const e=this.data.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}[Symbol.iterator](){return this.entries()}forEach(e){this.data.forEach((t,i,s)=>{e(t.value,i,s)})}get(e){var t;return(null!==(t=this.data.get(e))&&void 0!==t?t:this.createCore(e,!0)).value}has(e){return this.data.has(e)}getSerializedStorage(e){const t={};return this.data.forEach((i,s)=>{t[s]=i.makeSerialized(e,this.handle)}),t}getSerializableStorage(e){const t={};return this.data.forEach((i,s)=>{t[s]=Object(o.b)(i,e,this.handle)}),t}serialize(e){return JSON.stringify(this.getSerializableStorage(e))}populateFromSerializable(e){for(const[t,i]of Object.entries(e)){if(i.type===s.a[s.a.Plain]||i.type===s.a[s.a.Shared])continue;const e={key:t.startsWith("intervalCollections/")?t.substring(20):t,value:this.makeLocal(t,i)};this.data.set(e.key,e.value)}}populate(e){this.populateFromSerializable(JSON.parse(e))}tryResubmitMessage(e,t){const i=e.type,s=this.messageHandlers.get(i);return void 0!==s&&(s.resubmit(e,t),!0)}tryGetStashedOpLocalMetadata(e){const t=e.type;if(this.messageHandlers.has(t))return this.messageHandlers.get(t).getStashedOpLocalMetadata(e);throw new Error("no apply stashed op handler")}tryProcessMessage(e,t,i,s){const n=this.messageHandlers.get(e.type);return void 0!==n&&(n.process(e,t,i,s),!0)}createCore(e,t){const i=new o.a(this.type.factory.load(this.makeMapValueOpEmitter(e),void 0),this.type),s=this.data.get(e);this.data.set(e,i);const n={key:e,previousValue:s};return this.eventEmitter.emit("create",n,t,this.eventEmitter),i}makeLocal(e,t){Object(a.a)(t.type!==s.a[s.a.Plain]&&t.type!==s.a[s.a.Shared],737),t.value=Object(n.c)(t.value,this.serializer);const i=this.type.factory.load(this.makeMapValueOpEmitter(e),t.value);return new o.a(i,this.type)}getMessageHandlers(){const e=new Map;return e.set("act",{process:(e,t,i,s)=>{var r;const a=null!==(r=this.data.get(e.key))&&void 0!==r?r:this.createCore(e.key,t),o=a.getOpHandler(e.value.opName),c=a.value,l=Object(n.c)(e.value.value,this.serializer);o.process(c,l,t,i,s);const h={key:e.key,previousValue:c};this.eventEmitter.emit("valueChanged",h,t,i,this.eventEmitter)},submit:(e,t)=>{this.submitMessage(e,t)},resubmit:(e,t)=>{const i=this.data.get(e.key),s=i.getOpHandler(e.value.opName),{rebasedOp:n,rebasedLocalOpMetadata:r}=s.rebase(i.value,e.value,t);this.submitMessage(Object.assign(Object.assign({},e),{value:n}),r)},getStashedOpLocalMetadata:e=>{Object(a.a)(!1,22)}}),e}makeMapValueOpEmitter(e){return{emit:(t,i,s,r)=>{const a=Object(n.b)(s,this.serializer,this.handle),o={key:e,type:"act",value:{opName:t,value:a}};this.submitMessage(o,r);const c={key:e,previousValue:i};this.eventEmitter.emit("valueChanged",c,!0,null,this.eventEmitter)}}}}},28938:function(e,t,i){"use strict";i.d(t,"b",(function(){return n})),i.d(t,"a",(function(){return r}));var s=i(28912);function n(e,t,i){const s=e.makeSerialized(t,i);return{type:s.type,value:s.value&&JSON.parse(s.value)}}class r{constructor(e,t){this.value=e,this.valueType=t}get type(){return this.valueType.name}makeSerialized(e,t){const i=this.valueType.factory.store(this.value),n=Object(s.d)(i,e,t);return{type:this.type,value:n}}getOpHandler(e){const t=this.valueType.ops.get(e);if(!t)throw new Error("Unknown type message");return t}}},28939:function(e,t,i){"use strict";i.d(t,"a",(function(){return T}));var s=i(28824),n=i(28823),r=i(28836),a=i(28917),o=i(28924),c=i(28920),l=i(28918),h=i(28926),u=i(28919),d=i(28916),m=i(28829),g=i(27455),p=function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(i[s[n]]=e[s[n]])}return i};var f;!function(e){e[e.Simple=0]="Simple",e[e.Nest=1]="Nest",e[e.SlideOnRemove=2]="SlideOnRemove",e[e.Transient=4]="Transient"}(f||(f={}));class b{constructor(e,t,i){this.start=e,this.end=t,this.propertyManager=new o.a,this.properties={},i&&this.addProperties(i)}getIntervalId(){var e;const t=null===(e=this.properties)||void 0===e?void 0:e.intervalId;if(void 0!==t)return""+t}getAdditionalPropertySets(){return this.auxProps}addPropertySet(e){void 0===this.auxProps&&(this.auxProps=[]),this.auxProps.push(e)}serialize(e){let t=0;e&&(t=e.getCurrentSeq());const i={end:this.end,intervalType:0,sequenceNumber:t,start:this.start};return this.properties&&(i.properties=this.properties),i}clone(){return new b(this.start,this.end,this.properties)}compare(e){const t=this.compareStart(e);if(0===t){const t=this.compareEnd(e);if(0===t){const t=this.getIntervalId();if(t){const i=e.getIntervalId();return i?t>i?1:t<i?-1:0:0}return 0}return t}return t}compareStart(e){return this.start-e.start}compareEnd(e){return this.end-e.end}overlaps(e){return this.start<=e.end&&this.end>=e.start}union(e){return new b(Math.min(this.start,e.start),Math.max(this.end,e.end),this.properties)}getProperties(){return this.properties}addProperties(e,t=!1,i,s){if(e)return this.initializeProperties(),this.propertyManager.addProperties(this.properties,e,s,i,t)}modify(e,t,i,s){const n=null!=t?t:this.start,r=null!=i?i:this.end;if(this.start===n&&this.end===r)return;const a=new b(n,r);return this.properties&&(a.initializeProperties(),this.propertyManager.copyTo(this.properties,a.properties,a.propertyManager)),a}initializeProperties(){this.propertyManager||(this.propertyManager=new o.a),this.properties||(this.properties=Object(c.d)())}}class v{constructor(e,t,i,s){this.start=e,this.end=t,this.intervalType=i,this.propertyManager=new o.a,this.properties={},s&&this.addProperties(s)}addPositionChangeListeners(e,t){var i,s,n,r;if(void 0===this.callbacks){this.callbacks={beforePositionChange:e,afterPositionChange:t};const a=null!==(i=(n=this.start).callbacks)&&void 0!==i?i:n.callbacks={},o=null!==(s=(r=this.end).callbacks)&&void 0!==s?s:r.callbacks={};a.beforeSlide=o.beforeSlide=e,a.afterSlide=o.afterSlide=t}}removePositionChangeListeners(){this.callbacks&&(this.callbacks=void 0,this.start.callbacks=void 0,this.end.callbacks=void 0)}serialize(e){const t=this.start.toPosition(),i={end:this.end.toPosition(),intervalType:this.intervalType,sequenceNumber:e.getCurrentSeq(),start:t};return this.properties&&(i.properties=this.properties),i}clone(){return new v(this.start,this.end,this.intervalType,this.properties)}compare(e){const t=this.compareStart(e);if(0===t){const t=this.compareEnd(e);if(0===t){const t=this.getIntervalId();if(t){const i=e.getIntervalId();return i?t>i?1:t<i?-1:0:0}return 0}return t}return t}compareStart(e){return this.start.compare(e.start)}compareEnd(e){return this.end.compare(e.end)}overlaps(e){return this.start.compare(e.end)<=0&&this.end.compare(e.start)>=0}getIntervalId(){var e;const t=null===(e=this.properties)||void 0===e?void 0:e.intervalId;if(void 0!==t)return""+t}union(e){return new v(this.start.min(e.start),this.end.max(e.end),this.intervalType)}addProperties(e,t=!1,i,s){return this.initializeProperties(),this.propertyManager.addProperties(this.properties,e,s,i,t)}overlapsPos(e,t){const i=this.start.toPosition();return this.start.toPosition()>e&&i<t}modify(e,t,i,s){const n=e=>{let t=e;return void 0===s&&(t&=~l.b.SlideOnRemove,t|=l.b.StayOnRemove),t};let r=this.start;void 0!==t&&(r=y(this.start.getClient(),t,n(this.start.refType),s),r.addProperties(this.start.properties));let a=this.end;void 0!==i&&(a=y(this.end.getClient(),i,n(this.end.refType),s),a.addProperties(this.end.properties)),r.pairedRef=a,a.pairedRef=r;const o=new v(r,a,this.intervalType);return this.properties&&(o.initializeProperties(),this.propertyManager.copyTo(this.properties,o.properties,o.propertyManager)),o}initializeProperties(){this.propertyManager||(this.propertyManager=new o.a),this.properties||(this.properties=Object(c.d)())}}function S(e,t,i,s){if(t.segment){return e.createLocalReferencePosition(t.segment,t.offset,i,void 0)}if(!s&&!Object(a.j)(i,l.b.Transient))throw new r.e("Non-transient references need segment");return new h.a(e,void 0,0,i)}function y(e,t,i,n){let r;return n?(Object(s.a)(0!=(i&l.b.SlideOnRemove),757),r=e.getContainingSegment(t,n),r=e.getSlideToSegment(r)):(Object(s.a)(0==(i&l.b.SlideOnRemove),758),r=e.getContainingSegment(t)),S(e,r,i,n)}function C(e,t,i,s,n,r){let o=l.b.RangeBegin,c=l.b.RangeEnd;n===f.Transient?(o=l.b.Transient,c=l.b.Transient):(n===f.Nest&&(o=l.b.NestBegin,c=l.b.NestEnd),r?(o|=l.b.SlideOnRemove,c|=l.b.SlideOnRemove):(o|=l.b.StayOnRemove,c|=l.b.StayOnRemove));const h=y(s,t,o,r),u=y(s,i,c,r);h.pairedRef=u,u.pairedRef=h;const d={[a.k]:[e]};h.addProperties(d),u.addProperties(d);return new v(h,u,n,d)}class O{constructor(e,t,i,s){this.client=e,this.label=t,this.helpers=i,this.onPositionChange=s,this.intervalTree=new u.b,this.intervalIdMap=new Map,this.endIntervalTree=new u.e(i.compareEnds)}addConflictResolver(e){this.conflictResolver=e,this.endConflictResolver=(t,i)=>{const s=e(t,i);return{data:s,key:s}}}map(e){this.intervalTree.map(e)}createLegacyId(e,t){return`${O.legacyIdPrefix}${e}-${t}`}ensureSerializedId(e){var t;let i=null===(t=e.properties)||void 0===t?void 0:t.intervalId;if(void 0===i){i=this.createLegacyId(e.start,e.end);const t={intervalId:i};e.properties=Object(c.a)(e.properties,t)}return Object.defineProperty(e.properties,"intervalId",{configurable:!1,enumerable:!0,writable:!1}),i}mapUntil(e){this.intervalTree.mapUntil(e)}gatherIterationResults(e,t,i,s){if(!this.intervalTree.intervals.isEmpty())if(void 0===i&&void 0===s)t?this.intervalTree.map(t=>{e.push(t)}):this.intervalTree.mapBackward(t=>{e.push(t)});else{const n=this.helpers.create("transient",i,s,this.client,f.Transient);if(void 0===i)t?this.intervalTree.map(t=>{0===n.compareEnd(t)&&e.push(t)}):this.intervalTree.mapBackward(t=>{0===n.compareEnd(t)&&e.push(t)});else{const i=void 0===s?e=>n.compareStart(e.key):e=>n.compare(e.key),r=e=>e<=0,a=e=>e>=0,o=t=>{e.push(t.key)};t?this.intervalTree.intervals.walkExactMatchesForward(i,o,r,a):this.intervalTree.intervals.walkExactMatchesBackward(i,o,r,a)}}}findOverlappingIntervals(e,t){if(t<e||this.intervalTree.intervals.isEmpty())return[];const i=this.helpers.create("transient",e,t,this.client,f.Transient);return this.intervalTree.match(i).map(e=>e.key)}previousInterval(e){const t=this.helpers.create("transient",e,e,this.client,f.Transient),i=this.endIntervalTree.floor(t);if(i)return i.data}nextInterval(e){const t=this.helpers.create("transient",e,e,this.client,f.Transient),i=this.endIntervalTree.ceil(t);if(i)return i.data}removeInterval(e,t){const i=this.helpers.create("transient",e,t,this.client,f.Transient);return this.intervalTree.remove(i),this.endIntervalTree.remove(i),i}removeIntervalFromIndex(e){this.intervalTree.removeExisting(e),this.endIntervalTree.remove(e);const t=e.getIntervalId();Object(s.a)(void 0!==t,785),this.intervalIdMap.delete(t)}removeExistingInterval(e){this.removeIntervalFromIndex(e),this.removeIntervalListeners(e)}createInterval(e,t,i,s){return this.helpers.create(this.label,e,t,this.client,i,s)}addInterval(e,t,i,s,n){const r=this.createInterval(e,t,i,n);return r&&(r.properties||(r.properties=Object(c.d)()),s&&r.addProperties(s),void 0===r.properties.intervalId&&(r.properties.intervalId=Object(g.a)()),this.add(r)),r}addIntervalToIndex(e){const t=e.getIntervalId();Object(s.a)(void 0!==t,704),Object.defineProperty(e.properties,"intervalId",{configurable:!1,enumerable:!0,writable:!1}),this.intervalTree.put(e,this.conflictResolver),this.endIntervalTree.put(e,e,this.endConflictResolver),this.intervalIdMap.set(t,e)}add(e){this.addIntervalToIndex(e),this.addIntervalListeners(e)}getIntervalById(e){return this.intervalIdMap.get(e)}changeInterval(e,t,i,s){const n=e.modify(this.label,t,i,s);return n&&(this.removeExistingInterval(e),this.add(n)),n}serialize(){const e=this.client,t=this.intervalTree.intervals.keys();return{label:this.label,intervals:t.map(t=>function(e){const{start:t,end:i,sequenceNumber:s,intervalType:n,properties:r}=e;return[t,i,s,n,Object.assign(Object.assign({},r),{[a.k]:void 0})]}(t.serialize(e))),version:2}}addIntervalListeners(e){e instanceof v&&e.addPositionChangeListeners(()=>this.removeIntervalFromIndex(e),()=>{var t;this.addIntervalToIndex(e),null===(t=this.onPositionChange)||void 0===t||t.call(this,e)})}removeIntervalListeners(e){e instanceof v&&e.removePositionChangeListeners()}}O.legacyIdPrefix="legacy";const w=(e,t)=>e.end.compare(t.end);class T{get name(){return T.Name}get factory(){return T._factory}get ops(){return T._ops}}T.Name="sharedStringIntervalCollection",T._factory=new class{load(e,t=[]){return new I({compareEnds:w,create:C},!0,e,t)}store(e){return e.serializeInternal()}},T._ops=R();const k=(e,t)=>e.end-t.end;function N(e,t,i,s){const n={};return e&&e.length>0&&(n[a.k]=[e]),new b(t,i,n)}class q{get name(){return q.Name}get factory(){return q._factory}get ops(){return q._ops}}function R(){const e=(e,t,i)=>{const{localSeq:s}=i,n=e.rebaseLocalInterval(t.opName,t.value,s);return{rebasedOp:Object.assign(Object.assign({},t),{value:n}),rebasedLocalOpMetadata:i}};return new Map([["add",{process:(e,t,i,s)=>{e.ackAdd(t,i,s)},rebase:e}],["delete",{process:(e,t,i,s)=>{e.ackDelete(t,i,s)},rebase:(e,t,i)=>({rebasedOp:t,rebasedLocalOpMetadata:i})}],["change",{process:(e,t,i,s)=>{e.ackChange(t,i,s)},rebase:e}]])}q.Name="sharedIntervalCollection",q._factory=new class{load(e,t=[]){const i=new I({compareEnds:k,create:N},!1,e,t);return i.attachGraph(void 0,""),i}store(e){return e.serializeInternal()}},q._ops=R();class P{constructor(e,t=!0,i,s){this.results=[],this.index=0,e.gatherIterationResults(this.results,t,i,s)}next(){let e,t=!0;return this.index<this.results.length&&(e=this.results[this.index++],t=!1),{value:e,done:t}}}class I extends n.a{constructor(e,t,i,s){super(),this.helpers=e,this.requiresClient=t,this.emitter=i,this.pendingChangesStart=new Map,this.pendingChangesEnd=new Map,Array.isArray(s)?this.savedSerializedIntervals=s:this.savedSerializedIntervals=s.intervals.map(e=>{return t=e,i=s.label,{start:t[0],end:t[1],sequenceNumber:t[2],intervalType:t[3],properties:Object.assign(Object.assign({},t[4]),{[a.k]:i})};var t,i})}get attached(){return!!this.localCollection}attachGraph(e,t){if(this.attached)throw new m.a("Only supports one Sequence attach");if(void 0===e&&this.requiresClient)throw new m.a("Client required for this collection");if(this.client=e,this.localCollection=new O(e,t,this.helpers,e=>this.emit("changeInterval",e,!0,void 0)),this.savedSerializedIntervals)for(const i of this.savedSerializedIntervals)this.localCollection.ensureSerializedId(i),this.localCollection.addInterval(i.start,i.end,i.intervalType,i.properties);this.savedSerializedIntervals=void 0}getNextLocalSeq(){return++this.client.getCollabWindow().localSeq}getIntervalById(e){if(!this.attached)throw new m.a("attach must be called before accessing intervals");return this.localCollection.getIntervalById(e)}add(e,t,i,s){var n,r;if(!this.attached)throw new m.a("attach must be called prior to adding intervals");if(i&f.Transient)throw new m.a("Can not add transient intervals");const a=this.localCollection.addInterval(e,t,i,s);if(a){const s={end:t,intervalType:i,properties:a.properties,sequenceNumber:null!==(r=null===(n=this.client)||void 0===n?void 0:n.getCurrentSeq())&&void 0!==r?r:0,start:e};this.emitter.emit("add",void 0,s,{localSeq:this.getNextLocalSeq()})}return this.emit("addInterval",a,!0,void 0),a}deleteExistingInterval(e,t,i){this.localCollection.removeExistingInterval(e),e&&(t?this.emitter.emit("delete",void 0,e.serialize(this.client),{localSeq:this.getNextLocalSeq()}):this.onDeserialize&&this.onDeserialize(e)),this.emit("deleteInterval",e,t,i)}removeIntervalById(e){const t=this.localCollection.getIntervalById(e);return t&&this.deleteExistingInterval(t,!0,void 0),t}changeProperties(e,t){if(!this.attached)throw new m.a("Attach must be called before accessing intervals");if("string"!=typeof e)throw new m.a("Change API requires an ID that is a string");if(!t)throw new m.a("changeProperties should be called with a property set");const i=this.getIntervalById(e);if(i){const e=i.addProperties(t,!0,d.d),s=i.serialize(this.client);s.start=void 0,s.end=void 0,s.properties=t,s.properties.intervalId=i.getIntervalId(),this.emitter.emit("change",void 0,s,{localSeq:this.getNextLocalSeq()}),this.emit("propertyChanged",i,e)}this.emit("changeInterval",i,!0,void 0)}change(e,t,i){if(!this.attached)throw new m.a("Attach must be called before accessing intervals");if("string"!=typeof e)throw new m.a("Change API requires an ID that is a string");const s=this.getIntervalById(e);if(s){const n=this.localCollection.changeInterval(s,t,i),r=s.serialize(this.client);return r.start=t,r.end=i,r.properties={intervalId:s.getIntervalId()},this.emitter.emit("change",void 0,r,{localSeq:this.getNextLocalSeq()}),this.addPendingChange(e,r),this.emit("changeInterval",n,!0,void 0),n}}addPendingChange(e,t){void 0!==t.start&&this.addPendingChangeHelper(e,this.pendingChangesStart,t),void 0!==t.end&&this.addPendingChangeHelper(e,this.pendingChangesEnd,t)}addPendingChangeHelper(e,t,i){let s=t.get(e);s||(s=[],t.set(e,s)),s.push(i)}removePendingChange(e){var t;const i=null===(t=e.properties)||void 0===t?void 0:t.intervalId;void 0!==e.start&&this.removePendingChangeHelper(i,this.pendingChangesStart,e),void 0!==e.end&&this.removePendingChangeHelper(i,this.pendingChangesEnd,e)}removePendingChangeHelper(e,t,i){const s=t.get(e);if(s){const n=s.shift();if(0===s.length&&t.delete(e),(null==n?void 0:n.start)!==i.start||(null==n?void 0:n.end)!==i.end)throw new m.a("Mismatch in pending changes")}}hasPendingChangeStart(e){const t=this.pendingChangesStart.get(e);return t&&0!==t.length}hasPendingChangeEnd(e){const t=this.pendingChangesEnd.get(e);return t&&0!==t.length}changeInterval(e,t,i){return this.ackChange(e,t,i)}ackChange(e,t,i){var s,n,r,a;if(!this.attached)throw new m.a("Attach must be called before accessing intervals");let o;if(t){this.removePendingChange(e);const t=null===(s=e.properties)||void 0===s?void 0:s.intervalId;o=this.getIntervalById(t),o&&(null===(n=o.propertyManager)||void 0===n||n.ackPendingProperties({type:l.a.ANNOTATE,props:null!==(r=e.properties)&&void 0!==r?r:{}}),this.ackInterval(o,i))}else{const t=e.properties,s="intervalId",n=t[s],r=p(t,["symbol"==typeof s?s:s+""]);if(o=this.getIntervalById(n),o){let t,s;this.hasPendingChangeStart(n)||(t=e.start),this.hasPendingChangeEnd(n)||(s=e.end),void 0===t&&void 0===s||(o=null!==(a=this.localCollection.changeInterval(o,t,s,i))&&void 0!==a?a:o);const c=o.addProperties(r,!0,i.sequenceNumber);this.onDeserialize&&this.onDeserialize(o),this.emit("propertyChanged",o,c)}}o&&this.emit("changeInterval",o,t,i)}addConflictResolver(e){if(!this.attached)throw new m.a("attachSequence must be called");this.localCollection.addConflictResolver(e)}attachDeserializer(e){e&&(this.onDeserialize=e,this.localCollection.map(t=>{e(t)}))}rebaseLocalInterval(e,t,i){var s,n;if(!this.attached)throw new m.a("attachSequence must be called");const{start:r,end:a,intervalType:o,properties:c,sequenceNumber:l}=t,h=void 0===r?void 0:this.client.rebasePosition(r,l,i),u=void 0===a?void 0:this.client.rebasePosition(a,l,i),d=null==c?void 0:c.intervalId,g={start:h,end:u,intervalType:o,sequenceNumber:null!==(n=null===(s=this.client)||void 0===s?void 0:s.getCurrentSeq())&&void 0!==n?n:0,properties:c};return"change"===e&&(this.hasPendingChangeStart(d)||this.hasPendingChangeEnd(d))&&(this.removePendingChange(t),this.addPendingChange(d,g)),g}getSlideToSegment(e){const t={segment:e.segment,offset:e.offset},i=this.client.getSlideToSegment(t);return t.segment===i.segment&&t.offset===i.offset?void 0:i}setSlideOnRemove(e){let t=e.refType;t&=~l.b.StayOnRemove,t|=l.b.SlideOnRemove,e.refType=t}ackInterval(e,t){if(!(e instanceof v))return;if(!Object(a.j)(e.start,l.b.StayOnRemove)&&!Object(a.j)(e.end,l.b.StayOnRemove))return;const i=this.getSlideToSegment(e.start),s=this.getSlideToSegment(e.end),n=e.properties.intervalId,r=this.hasPendingChangeStart(n),o=this.hasPendingChangeEnd(n);r||this.setSlideOnRemove(e.start),o||this.setSlideOnRemove(e.end);const c=void 0!==i&&!r,h=void 0!==s&&!o;if(c||h){if(this.localCollection.removeExistingInterval(e),c){const s=e.start.properties;this.client.removeLocalReferencePosition(e.start),e.start=S(this.client,i,e.start.refType,t),s&&e.start.addProperties(s)}if(h){const i=e.end.properties;this.client.removeLocalReferencePosition(e.end),e.end=S(this.client,s,e.end.refType,t),i&&e.end.addProperties(i)}this.localCollection.add(e)}}addInternal(e,t,i){return this.ackAdd(e,t,i)}ackAdd(e,t,i){var s;if(t){const t=null===(s=e.properties)||void 0===s?void 0:s.intervalId,n=this.getIntervalById(t);return void(n&&this.ackInterval(n,i))}if(!this.attached)throw new m.a("attachSequence must be called");this.localCollection.ensureSerializedId(e);const n=this.localCollection.addInterval(e.start,e.end,e.intervalType,e.properties,i);return n&&this.onDeserialize&&this.onDeserialize(n),this.emit("addInterval",n,t,i),n}deleteInterval(e,t,i){return this.ackDelete(e,t,i)}ackDelete(e,t,i){if(t)return;if(!this.attached)throw new m.a("attach must be called prior to deleting intervals");const s=this.localCollection.ensureSerializedId(e),n=this.localCollection.getIntervalById(s);n&&this.deleteExistingInterval(n,t,i)}serializeInternal(){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.serialize()}[Symbol.iterator](){return new P(this)}CreateForwardIteratorWithStartPosition(e){return new P(this,!0,e)}CreateBackwardIteratorWithStartPosition(e){return new P(this,!1,e)}CreateForwardIteratorWithEndPosition(e){return new P(this,!0,void 0,e)}CreateBackwardIteratorWithEndPosition(e){return new P(this,!1,void 0,e)}gatherIterationResults(e,t,i,s){this.attached&&this.localCollection.gatherIterationResults(e,t,i,s)}findOverlappingIntervals(e,t){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.findOverlappingIntervals(e,t)}map(e){if(!this.attached)throw new m.a("attachSequence must be called");this.localCollection.map(e)}previousInterval(e){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.previousInterval(e)}nextInterval(e){if(!this.attached)throw new m.a("attachSequence must be called");return this.localCollection.nextInterval(e)}}},28940:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(28824);class n{constructor(e,t){this.storage=e,this.path=t,Object(s.a)(!t.endsWith("/"),412)}async readBlob(e){return this.storage.readBlob(`${this.path}/${e}`)}async contains(e){return this.storage.contains(`${this.path}/${e}`)}async list(e){return this.storage.list(`${this.path}/${e}`)}}},28941:function(e,t,i){"use strict";i.d(t,"c",(function(){return h})),i.d(t,"b",(function(){return u})),i.d(t,"a",(function(){return d}));var s=i(28931),n=i(28915),r=i(28943),a=i(28944),o=i(28913),c=i(28914),l=i(28942);class h{static segmentFromSpec(e){const t=s.b.fromJSONObject(e);if(t)return t;const i=n.b.fromJSONObject(e);return i||void 0}get type(){return h.Type}get attributes(){return h.Attributes}async load(e,t,i,s){const n=new l.a(e,t,s);return await n.load(i),n}create(e,t){const i=new l.a(e,t,this.attributes);return i.initializeLocal(),i}}h.Type="https://graph.microsoft.com/types/mergeTree",h.Attributes={type:h.Type,snapshotFormatVersion:"0.1",packageVersion:r.a};class u{static segmentFromSpec(e){const t=e;if(t.items){const e=new c.b(t.items);return t.props&&e.addProperties(t.props),e}}get type(){return u.Type}get attributes(){return u.Attributes}async load(e,t,i,s){const n=new o.a(e,t,s);return await n.load(i),n}create(e,t){const i=new o.a(e,t,this.attributes);return i.initializeLocal(),i}}u.Type="https://graph.microsoft.com/types/mergeTree/object-sequence",u.Attributes={type:u.Type,snapshotFormatVersion:"0.1",packageVersion:r.a};class d{static segmentFromSpec(e){const t=e;if(t.items){const e=new c.b(t.items);return t.props&&e.addProperties(t.props),e}}get type(){return d.Type}get attributes(){return d.Attributes}async load(e,t,i,s){const n=new a.a(e,t,s);return await n.load(i),n}create(e,t){const i=new a.a(e,t,this.attributes);return i.initializeLocal(),i}}d.Type="https://graph.microsoft.com/types/mergeTree/number-sequence",d.Attributes={type:d.Type,snapshotFormatVersion:"0.1",packageVersion:r.a}},28942:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var s=i(28915),n=i(28931),r=i(28928),a=i(28941);class o extends r.a{constructor(e,t,i){super(e,t,i,a.c.segmentFromSpec),this.id=t,this.mergeTreeTextHelper=this.client.createTextHelper()}static create(e,t){return e.createChannel(t,a.c.Type)}static getFactory(){return new a.c}get ISharedString(){return this}insertMarkerRelative(e,t,i){const n=new s.b(t);i&&n.addProperties(i);const r=this.posFromRelativePos(e),a=this.client.insertSegmentLocal(r,n);a&&this.submitSequenceMessage(a)}insertMarker(e,t,i){const n=new s.b(t);i&&n.addProperties(i);const r=this.client.insertSegmentLocal(e,n);return r&&this.submitSequenceMessage(r),r}insertTextRelative(e,t,i){const s=new n.b(t);i&&s.addProperties(i);const r=this.posFromRelativePos(e),a=this.client.insertSegmentLocal(r,s);a&&this.submitSequenceMessage(a)}insertText(e,t,i){const s=new n.b(t);i&&s.addProperties(i);const r=this.client.insertSegmentLocal(e,s);r&&this.submitSequenceMessage(r)}replaceText(e,t,i,s){this.replaceRange(e,t,n.b.make(i,s))}removeText(e,t){return this.removeRange(e,t)}annotateMarkerNotifyConsensus(e,t,i){const s=this.client.annotateMarkerNotifyConsensus(e,t,i);s&&this.submitSequenceMessage(s)}annotateMarker(e,t,i){const s=this.client.annotateMarker(e,t,i);s&&this.submitSequenceMessage(s)}findTile(e,t,i=!0){return this.client.findTile(e,t,i)}getTextAndMarkers(e){const t=this.client.getCollabWindow();return this.mergeTreeTextHelper.getTextAndMarkers(t.currentSeq,t.clientId,e)}getText(e,t){const i=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(i.currentSeq,i.clientId,"",e,t)}getTextWithPlaceholders(){const e=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(e.currentSeq,e.clientId," ")}getTextRangeWithPlaceholders(e,t){const i=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(i.currentSeq,i.clientId," ",e,t)}getTextRangeWithMarkers(e,t){const i=this.client.getCollabWindow();return this.mergeTreeTextHelper.getText(i.currentSeq,i.clientId,"*",e,t)}getMarkerFromId(e){return this.client.getMarkerFromId(e)}}},28943:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s="1.3.1"},28944:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28941),n=i(28914);class r extends n.a{constructor(e,t,i){super(e,t,i,s.a.segmentFromSpec),this.id=t}static create(e,t){return e.createChannel(t,s.a.Type)}static getFactory(){return new s.a}getRange(e,t){return this.getItems(e,t)}}},28945:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var s=i(28849),n=i(28861),r=i(28821),a=i(28912),o=i(28946);class c extends r.a{constructor(e,t,i){super(e,t,i,"fluid_counter_"),this._value=0}static create(e,t){return e.createChannel(t,o.a.Type)}static getFactory(){return new o.a}get value(){return this._value}increment(e){if(e%1!=0)throw new Error("Must increment by a whole number");const t={type:"increment",incrementAmount:e};this.incrementCore(e),this.submitLocalMessage(t)}incrementCore(e){this._value+=e,this.emit("incremented",e,this._value)}summarizeCore(e){const t={value:this.value};return Object(a.a)("header",JSON.stringify(t))}async loadCore(e){const t=await Object(n.a)(e,"header");this._value=t.value}onDisconnect(){}processCore(e,t,i){if(e.type===s.a.Operation&&!t){const t=e.contents;switch(t.type){case"increment":this.incrementCore(t.incrementAmount);break;default:throw new Error("Unknown operation")}}}applyStashedOp(){throw new Error("not implemented")}}},28946:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28945),n=i(28947);class r{get type(){return r.Type}get attributes(){return r.Attributes}async load(e,t,i,n){const r=new s.a(t,e,n);return await r.load(i),r}create(e,t){const i=new s.a(t,e,this.attributes);return i.initializeLocal(),i}}r.Type="https://graph.microsoft.com/types/counter",r.Attributes={type:r.Type,snapshotFormatVersion:"0.1",packageVersion:n.a}},28947:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s="1.3.1"},28948:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var s=i(28824),n=i(28849),r=i(28861),a=i(28821),o=i(28912),c=i(28949);class l extends a.a{constructor(e,t,i){super(e,t,i,"fluid_cell_"),this.messageId=-1,this.messageIdObserved=-1}static create(e,t){return e.createChannel(t,c.a.Type)}static getFactory(){return new c.a}get(){return this.data}set(e){const t={value:this.serializer.encode(e,this.handle)};if(this.setCore(e),!this.isAttached())return;const i={type:"setCell",value:t};this.submitLocalMessage(i,++this.messageId)}delete(){if(this.deleteCore(),!this.isAttached())return;this.submitLocalMessage({type:"deleteCell"},++this.messageId)}empty(){return void 0===this.data}summarizeCore(e){const t={value:this.data};return Object(o.a)("header",e.stringify(t,this.handle))}async loadCore(e){const t=await Object(r.a)(e,"header");this.data=this.decode(t)}initializeLocalCore(){this.data=void 0}onDisconnect(){}applyInnerOp(e){switch(e.type){case"setCell":this.setCore(this.decode(e.value));break;case"deleteCell":this.deleteCore();break;default:throw new Error("Unknown operation")}}processCore(e,t,i){if(this.messageId===this.messageIdObserved){if(e.type===n.a.Operation&&!t){const t=e.contents;this.applyInnerOp(t)}}else if(t){const e=i;Object(s.a)(void 0!==e&&e<=this.messageId,12),this.messageIdObserved=i}}setCore(e){this.data=e,this.emit("valueChanged",e)}deleteCore(){this.data=void 0,this.emit("delete")}decode(e){const t=e.value;return this.serializer.decode(t)}applyStashedOp(e){const t=e;return this.applyInnerOp(t),++this.messageId,this.messageId}}},28949:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(28948),n=i(28950);class r{get type(){return r.Type}get attributes(){return r.Attributes}async load(e,t,i,n){const r=new s.a(t,e,n);return await r.load(i),r}create(e,t){const i=new s.a(t,e,this.attributes);return i.initializeLocal(),i}}r.Type="https://graph.microsoft.com/types/cell",r.Attributes={type:r.Type,snapshotFormatVersion:"0.1",packageVersion:n.a}},28950:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));const s="1.3.1"},28951:function(e,t,i){"use strict";var s;i.d(t,"a",(function(){return s})),function(e){e[e.Disconnected=0]="Disconnected",e[e.EstablishingConnection=3]="EstablishingConnection",e[e.Connecting=1]="Connecting",e[e.CatchingUp=1]="CatchingUp",e[e.Connected=2]="Connected"}(s||(s={}))}}]);
//# sourceMappingURL=https://sourcemaps.powerapps.com/srcmaps/static/js/module/233.58eedbc4.chunk.js.map